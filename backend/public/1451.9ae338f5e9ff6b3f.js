"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1451],{1451:(O,P,e)=>{e.r(P),e.d(P,{TabsPageModule:()=>m});var h=e(2200),C=e(4341),g=e(7343),b=e(8132),y=e(467),n=e(3664),S=e(6386),j=e(8245),A=e(4796),p=e(1924);function f(o,u){1&o&&n.nrm(0,"ion-icon",9)}function T(o,u){1&o&&n.nrm(0,"ion-icon",9)}function t(o,u){if(1&o&&(n.j41(0,"ion-badge",10),n.EFF(1),n.k0s()),2&o){const E=n.XpG();n.R7$(),n.JRh(E.pendingSync)}}let s=(()=>{var o;class u{constructor(r,l,d,L,I){this.syncService=r,this.licenseService=l,this.authService=d,this.alertController=L,this.router=I,this.pendingSync=0,this.hasLicense=!1,this.licenseChecked=!1,this.licenseSub=null}ngOnInit(){var r=this;return(0,y.A)(function*(){r.syncService.getPendingCount().then(l=>{r.pendingSync=l}),r.licenseSub=r.licenseService.licenseStatus$.subscribe(l=>{r.hasLicense=l.hasValidLicense,r.licenseChecked=!0}),yield r.checkLicense()})()}ngOnDestroy(){this.licenseSub&&this.licenseSub.unsubscribe()}checkLicense(){var r=this;return(0,y.A)(function*(){r.authService.isAuthenticated&&(yield r.licenseService.checkLicenseStatus())})()}onTabClick(r,l){var d=this;return(0,y.A)(function*(){"settings"===l||d.hasLicense||(r.preventDefault(),r.stopPropagation(),yield(yield d.alertController.create({header:"Licencia requerida",message:"Para acceder a esta funcion necesitas activar una licencia. Ve a Configuracion para activar o comprar una licencia.",buttons:[{text:"Cancelar",role:"cancel"},{text:"Ir a Config",handler:()=>{d.router.navigate(["/tabs/settings"])}}]})).present())})()}static#t=o=()=>(this.\u0275fac=function(l){return new(l||u)(n.rXU(S.H),n.rXU(j.X),n.rXU(A.u),n.rXU(g.hG),n.rXU(p.Ix))},this.\u0275cmp=n.VBU({type:u,selectors:[["app-tabs"]],standalone:!1,decls:17,vars:7,consts:[["slot","bottom"],["tab","projects",3,"click"],["name","folder-outline"],["name","lock-closed","class","lock-icon",4,"ngIf"],["tab","catastro",3,"click"],["name","globe-outline"],["tab","settings"],["name","cog-outline"],["color","warning",4,"ngIf"],["name","lock-closed",1,"lock-icon"],["color","warning"]],template:function(l,d){1&l&&(n.j41(0,"ion-tabs")(1,"ion-tab-bar",0)(2,"ion-tab-button",1),n.bIt("click",function(I){return d.onTabClick(I,"projects")}),n.nrm(3,"ion-icon",2),n.j41(4,"ion-label"),n.EFF(5,"Proyectos"),n.k0s(),n.DNE(6,f,1,0,"ion-icon",3),n.k0s(),n.j41(7,"ion-tab-button",4),n.bIt("click",function(I){return d.onTabClick(I,"catastro")}),n.nrm(8,"ion-icon",5),n.j41(9,"ion-label"),n.EFF(10,"GeoVisor"),n.k0s(),n.DNE(11,T,1,0,"ion-icon",3),n.k0s(),n.j41(12,"ion-tab-button",6),n.nrm(13,"ion-icon",7),n.j41(14,"ion-label"),n.EFF(15,"Config"),n.k0s(),n.DNE(16,t,2,1,"ion-badge",8),n.k0s()()()),2&l&&(n.R7$(2),n.AVh("disabled-tab",!d.hasLicense&&d.licenseChecked),n.R7$(4),n.Y8G("ngIf",!d.hasLicense&&d.licenseChecked),n.R7$(),n.AVh("disabled-tab",!d.hasLicense&&d.licenseChecked),n.R7$(4),n.Y8G("ngIf",!d.hasLicense&&d.licenseChecked),n.R7$(5),n.Y8G("ngIf",d.pendingSync>0))},dependencies:[h.bT,g.In,g.iq,g.he,g.Jq,g.qW,g.p4],styles:["ion-tab-bar[_ngcontent-%COMP%]{--background: #ffffff;border-top:1px solid #e2e8f0;height:60px;padding-bottom:env(safe-area-inset-bottom)}ion-tab-button[_ngcontent-%COMP%]{--color: #6b7280;--color-selected: #1a5f7a;font-size:11px;font-weight:500;position:relative}ion-tab-button[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:24px;margin-bottom:2px}ion-tab-button[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{font-size:11px}ion-tab-button[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%]{position:absolute;top:4px;right:calc(50% - 20px);font-size:10px;padding:2px 6px;min-width:18px;height:18px}ion-tab-button.disabled-tab[_ngcontent-%COMP%]{--color: #c0c0c0;opacity:.6}ion-tab-button[_ngcontent-%COMP%]   .lock-icon[_ngcontent-%COMP%]{position:absolute;top:2px;right:calc(50% - 24px);font-size:12px;color:#f59e0b}"]}))}return o(),u})();var i=e(2615);let c=(()=>{var o;class u{constructor(r,l,d){this.licenseService=r,this.router=l,this.alertController=d}canActivate(){var r=this;return(0,y.A)(function*(){let l=r.licenseService.hasValidLicense();if(!l)try{l=(yield r.licenseService.checkLicenseStatus()).hasValidLicense}catch(d){console.error("Error checking license:",d),l=!1}return!!l||(yield r.showNoLicenseAlert(),r.router.createUrlTree(["/tabs/settings"]))})()}showNoLicenseAlert(){var r=this;return(0,y.A)(function*(){yield(yield r.alertController.create({header:"Licencia Requerida",message:"Necesitas una licencia activa para acceder a esta funcionalidad. Por favor, activa o compra una licencia.",buttons:["Entendido"],cssClass:"license-alert"})).present()})()}static#t=o=()=>(this.\u0275fac=function(l){return new(l||u)(i.KVO(j.X),i.KVO(p.Ix),i.KVO(g.hG))},this.\u0275prov=i.jDH({token:u,factory:u.\u0275fac,providedIn:"root"}))}return o(),u})();const a=[{path:"",component:s,children:[{path:"projects",loadChildren:()=>Promise.all([e.e(2076),e.e(1707)]).then(e.bind(e,1707)).then(o=>o.ProjectsPageModule),canActivate:[c]},{path:"camera",loadChildren:()=>Promise.all([e.e(2076),e.e(9361)]).then(e.bind(e,9361)).then(o=>o.CameraPageModule),canActivate:[c]},{path:"catastro",loadChildren:()=>Promise.all([e.e(139),e.e(2076),e.e(3408)]).then(e.bind(e,3408)).then(o=>o.CatastroPageModule),canActivate:[c]},{path:"settings",loadChildren:()=>e.e(5371).then(e.bind(e,5371)).then(o=>o.SettingsPageModule)},{path:"mediciones",loadChildren:()=>e.e(2076).then(e.bind(e,4034)).then(o=>o.MedicionesPageModule),canActivate:[c]},{path:"",redirectTo:"settings",pathMatch:"full"}]}];let v=(()=>{var o;class u{static#t=o=()=>(this.\u0275fac=function(l){return new(l||u)},this.\u0275mod=n.$C({type:u}),this.\u0275inj=i.G2t({imports:[b.iI.forChild(a),b.iI]}))}return o(),u})(),m=(()=>{var o;class u{static#t=o=()=>(this.\u0275fac=function(l){return new(l||u)},this.\u0275mod=n.$C({type:u}),this.\u0275inj=i.G2t({imports:[h.MD,C.YN,g.bv,v]}))}return o(),u})()},6386:(O,P,e)=>{e.d(P,{H:()=>A});var h=e(467);const g=(0,e(5083).F3)("Network",{web:()=>e.e(3780).then(e.bind(e,3780)).then(p=>new p.NetworkWeb)});var b=e(4412),y=e(2615),n=e(3366),S=e(7291),j=e(9473);let A=(()=>{var p;class f{constructor(t,s,i){this.api=t,this.storage=s,this.camera=i,this.isOnlineSubject=new b.t(!0),this.isSyncingSubject=new b.t(!1),this.pendingCountSubject=new b.t(0),this.isOnline$=this.isOnlineSubject.asObservable(),this.isSyncing$=this.isSyncingSubject.asObservable(),this.pendingCount$=this.pendingCountSubject.asObservable(),this.syncInProgress=!1,this.initNetworkListener()}initNetworkListener(){var t=this;return(0,h.A)(function*(){const s=yield g.getStatus();t.isOnlineSubject.next(s.connected),g.addListener("networkStatusChange",function(){var i=(0,h.A)(function*(c){t.isOnlineSubject.next(c.connected),c.connected&&!t.syncInProgress&&(yield t.syncPending())});return function(c){return i.apply(this,arguments)}}()),yield t.updatePendingCount()})()}updatePendingCount(){var t=this;return(0,h.A)(function*(){const s=yield t.storage.getPendingSyncCount();t.pendingCountSubject.next(s)})()}queueForSync(t,s,i,c){var a=this;return(0,h.A)(function*(){const v={id:a.storage.generateId(),action:t,entity:s,entityId:i,data:c,createdAt:new Date,attempts:0,status:"pending"};yield a.storage.addToSyncQueue(v),yield a.updatePendingCount(),a.isOnlineSubject.value&&!a.syncInProgress&&(yield a.syncPending())})()}syncPending(){var t=this;return(0,h.A)(function*(){if(!t.syncInProgress&&t.isOnlineSubject.value){t.syncInProgress=!0,t.isSyncingSubject.next(!0);try{const i=(yield t.storage.getSyncQueue()).filter(c=>"pending"===c.status&&c.attempts<3);if(0===i.length)return;for(const c of i)try{yield t.syncItem(c),yield t.storage.removeFromSyncQueue(c.id)}catch(a){c.attempts++,c.lastAttempt=new Date,c.error=a instanceof Error?a.message:"Error desconocido",c.attempts>=3&&(c.status="error"),yield t.storage.updateSyncQueueItem(c)}}finally{t.syncInProgress=!1,t.isSyncingSubject.next(!1),yield t.updatePendingCount()}}})()}syncItem(t){var s=this;return(0,h.A)(function*(){switch(t.entity){case"project":yield s.syncProject(t);break;case"photo":yield s.syncPhoto(t)}})()}syncProject(t){var s=this;return(0,h.A)(function*(){switch(t.action){case"CREATE":const i=yield s.api.post("/projects",t.data).toPromise();if(i&&i.project&&i.project.id){const a=(yield s.storage.getProjects()).find(v=>v.id===t.entityId);a&&(a.serverId=i.project.id,a.synced=!0,yield s.storage.saveProject(a),console.log("Proyecto sincronizado con serverId:",i.project.id))}break;case"UPDATE":yield s.api.put(`/projects/${t.entityId}`,t.data).toPromise();break;case"DELETE":yield s.api.delete(`/projects/${t.entityId}`).toPromise()}})()}syncPhoto(t){var s=this;return(0,h.A)(function*(){switch(t.action){case"CREATE":const i=yield s.storage.getPhoto(t.entityId);if(i&&i.localPath){const c=yield s.camera.getPhotoBase64(i.localPath),a=new FormData,v=s.base64ToBlob(c,"image/jpeg");a.append("file",v,"photo.jpg"),a.append("projectId",i.projectId),a.append("latitude",i.latitude.toString()),a.append("longitude",i.longitude.toString()),i.altitude&&a.append("altitude",i.altitude.toString()),i.accuracy&&a.append("accuracy",i.accuracy.toString()),i.notes&&a.append("notes",i.notes);const m=yield s.api.uploadFile("/photos",a).toPromise();m&&m.photo&&(i.imageUrl=m.photo.imageUrl,i.synced=!0,yield s.storage.savePhoto(i))}break;case"UPDATE":yield s.api.put(`/photos/${t.entityId}`,t.data).toPromise();break;case"DELETE":yield s.api.delete(`/photos/${t.entityId}`).toPromise()}})()}base64ToBlob(t,s){const i=atob(t),c=[];for(let a=0;a<i.length;a+=512){const v=i.slice(a,a+512),m=new Array(v.length);for(let o=0;o<v.length;o++)m[o]=v.charCodeAt(o);c.push(new Uint8Array(m))}return new Blob(c,{type:s})}get isOnline(){return this.isOnlineSubject.value}get isSyncing(){return this.isSyncingSubject.value}getPendingCount(){var t=this;return(0,h.A)(function*(){return yield t.storage.getPendingSyncCount()})()}syncAll(){var t=this;return(0,h.A)(function*(){yield t.syncPending()})()}static#t=p=()=>(this.\u0275fac=function(s){return new(s||f)(y.KVO(n.G),y.KVO(S.n),y.KVO(j.j))},this.\u0275prov=y.jDH({token:f,factory:f.\u0275fac,providedIn:"root"}))}return p(),f})()},8245:(O,P,e)=>{e.d(P,{X:()=>A});var h=e(467),C=e(4412),g=e(4843),b=e(5312);const n=(0,e(5083).F3)("Browser",{web:()=>e.e(4786).then(e.bind(e,4786)).then(p=>new p.BrowserWeb)});var S=e(2615),j=e(9330);let A=(()=>{var p;class f{constructor(t){this.http=t,this.apiUrl=b.c.apiUrl,this.licenseStatusSubject=new C.t({hasValidLicense:!1,license:null}),this.licenseStatus$=this.licenseStatusSubject.asObservable()}checkLicenseStatus(){var t=this;return(0,h.A)(function*(){try{const s=yield(0,g._)(t.http.get(`${t.apiUrl}/licenses/status`));return t.licenseStatusSubject.next(s),s}catch(s){console.error("Error checking license status:",s);const i={hasValidLicense:!1,license:null};return t.licenseStatusSubject.next(i),i}})()}getCurrentStatus(){return this.licenseStatusSubject.value}hasValidLicense(){return this.licenseStatusSubject.value.hasValidLicense}activateLicense(t){var s=this;return(0,h.A)(function*(){const i=yield(0,g._)(s.http.post(`${s.apiUrl}/licenses/activate`,{licenseKey:t}));return yield s.checkLicenseStatus(),i})()}getLicenseTypes(){var t=this;return(0,h.A)(function*(){return(0,g._)(t.http.get(`${t.apiUrl}/licenses/types`))})()}createPaymentOrder(t){var s=this;return(0,h.A)(function*(){return(0,g._)(s.http.post(`${s.apiUrl}/payments/create-order`,{licenseTypeId:t}))})()}purchaseLicense(t){var s=this;return(0,h.A)(function*(){const i=yield s.createPaymentOrder(t);i.approvalUrl&&(yield n.open({url:i.approvalUrl}))})()}capturePayment(t){var s=this;return(0,h.A)(function*(){const i=yield(0,g._)(s.http.post(`${s.apiUrl}/payments/capture`,{orderId:t}));return yield s.checkLicenseStatus(),i})()}getPaymentHistory(){var t=this;return(0,h.A)(function*(){return(0,g._)(t.http.get(`${t.apiUrl}/payments/history`))})()}formatPrice(t){return new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(t)}formatDaysRemaining(t){return t<=0?"Expirada":1===t?"1 dia restante":`${t} dias restantes`}static#t=p=()=>(this.\u0275fac=function(s){return new(s||f)(S.KVO(j.Qq))},this.\u0275prov=S.jDH({token:f,factory:f.\u0275fac,providedIn:"root"}))}return p(),f})()}}]);