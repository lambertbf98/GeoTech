"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1707],{1707:(V,j,p)=>{p.r(j),p.d(j,{ProjectsPageModule:()=>B});var v=p(2200),P=p(4341),d=p(7343),b=p(8132),u=p(467),y=p(4843),e=p(3664),m=p(2615),x=p(3366),C=p(7291),M=p(6386),O=p(2092),k=p(2704),I=p(9330);function S(c,a){if(1&c){const g=e.RV6();e.j41(0,"ion-button",11),e.bIt("click",function(){m.eBV(g);const o=e.XpG();return m.Njj(o.forceSync())}),e.nrm(1,"ion-icon",12),e.k0s()}}function w(c,a){1&c&&(e.j41(0,"div",13),e.nrm(1,"ion-icon",14),e.j41(2,"span"),e.EFF(3,"Modo sin conexion"),e.k0s()())}function z(c,a){1&c&&(e.j41(0,"div",15),e.nrm(1,"ion-spinner",16),e.j41(2,"p"),e.EFF(3,"Cargando proyectos..."),e.k0s()())}function E(c,a){if(1&c){const g=e.RV6();e.j41(0,"div",17)(1,"div",18),e.nrm(2,"ion-icon",19),e.k0s(),e.j41(3,"h3",20),e.EFF(4,"Sin proyectos"),e.k0s(),e.j41(5,"p",21),e.EFF(6,"Crea tu primer proyecto para comenzar a gestionar tus trabajos de campo."),e.k0s(),e.j41(7,"ion-button",22),e.bIt("click",function(){m.eBV(g);const o=e.XpG();return m.Njj(o.createProject())}),e.nrm(8,"ion-icon",23),e.EFF(9," Crear proyecto "),e.k0s()()}}function T(c,a){1&c&&e.nrm(0,"ion-icon",38)}function A(c,a){1&c&&e.nrm(0,"ion-icon",39)}function R(c,a){if(1&c&&(e.j41(0,"span"),e.nrm(1,"ion-icon",40),e.EFF(2),e.k0s()),2&c){const g=e.XpG().$implicit;e.R7$(2),e.SpI(" ",g.photoCount," fotos ")}}function F(c,a){if(1&c&&(e.j41(0,"p",41),e.nrm(1,"ion-icon",42),e.EFF(2),e.k0s()),2&c){const g=e.XpG().$implicit;e.R7$(2),e.SpI(" ",g.location," ")}}function G(c,a){if(1&c){const g=e.RV6();e.j41(0,"ion-item",26),e.bIt("click",function(){const o=m.eBV(g).$implicit,n=e.XpG(2);return m.Njj(n.openProject(o))}),e.j41(1,"div",27),e.nrm(2,"ion-icon",28),e.DNE(3,T,1,0,"ion-icon",29)(4,A,1,0,"ion-icon",30),e.k0s(),e.j41(5,"ion-label")(6,"h2",31),e.EFF(7),e.k0s(),e.j41(8,"p",32),e.nrm(9,"ion-icon",33),e.EFF(10),e.DNE(11,R,3,1,"span",34),e.k0s(),e.DNE(12,F,3,1,"p",35),e.k0s(),e.j41(13,"ion-button",36),e.bIt("click",function(o){const n=m.eBV(g).$implicit,r=e.XpG(2);return m.Njj(r.showProjectOptions(n,o))}),e.nrm(14,"ion-icon",37),e.k0s()()}if(2&c){const g=a.$implicit,t=e.XpG(2);e.R7$(3),e.Y8G("ngIf",g.synced),e.R7$(),e.Y8G("ngIf",!g.synced),e.R7$(3),e.JRh(g.name),e.R7$(3),e.SpI(" ",t.formatDate(g.createdAt)," "),e.R7$(),e.Y8G("ngIf",g.photoCount),e.R7$(),e.Y8G("ngIf",g.location)}}function D(c,a){if(1&c&&(e.j41(0,"ion-list",24),e.DNE(1,G,15,6,"ion-item",25),e.k0s()),2&c){const g=e.XpG();e.R7$(),e.Y8G("ngForOf",g.filteredProjects)}}function $(c,a){if(1&c){const g=e.RV6();e.j41(0,"ion-fab",43)(1,"ion-fab-button",2),e.bIt("click",function(){m.eBV(g);const o=e.XpG();return m.Njj(o.createProject())}),e.nrm(2,"ion-icon",44),e.k0s()()}}const N=[{path:"",component:(()=>{var c;class a{constructor(t,o,n,r,l,h,_,i,s){this.apiService=t,this.storageService=o,this.syncService=n,this.gpsService=r,this.router=l,this.alertCtrl=h,this.toastCtrl=_,this.actionSheetCtrl=i,this.http=s,this.projects=[],this.isLoading=!0,this.isOnline=!0,this.searchQuery=""}ngOnInit(){var t=this;return(0,u.A)(function*(){yield t.loadProjects()})()}ionViewWillEnter(){var t=this;return(0,u.A)(function*(){yield t.loadProjects()})()}loadProjects(){var t=this;return(0,u.A)(function*(){t.isLoading=!0;let o=yield t.storageService.getProjects();try{yield(0,y._)(t.apiService.get("/health")),t.isOnline=!0;try{const r=(yield(0,y._)(t.apiService.get("/projects")))?.projects||[];console.log("Proyectos en servidor:",r.length),console.log("Proyectos locales:",o.length);const l=new Map;r.forEach(i=>l.set(i.id,i));const h=new Map;o.forEach(i=>{i.serverId&&h.set(i.serverId,i)});let _=!1;for(const i of o)if(!i.serverId&&!i.synced)try{console.log("Subiendo proyecto local al servidor:",i.name);const s=yield(0,y._)(t.apiService.post("/projects",{name:i.name,description:i.description,location:i.location}));s?.project?.id&&(i.serverId=s.project.id,i.synced=!0,_=!0,console.log("Proyecto subido con serverId:",i.serverId))}catch(s){console.log("Error subiendo proyecto:",i.name,s?.message)}for(const i of r)if(h.has(i.id)){const s=h.get(i.id);if(s&&i.content){const f=i.content;new Date(i.updatedAt||0).getTime()>new Date(s.updatedAt||0).getTime()&&(s.zones=f.zones||s.zones,s.paths=f.paths||s.paths,s.markers=f.markers||s.markers,s.coordinates=f.coordinates||s.coordinates,s.updatedAt=new Date(i.updatedAt),_=!0,console.log("Contenido actualizado desde servidor:",s.name))}}else{const s=i.content||{},f={id:"proj_"+Date.now()+"_"+Math.random().toString(36).substr(2,5),serverId:i.id,name:i.name,description:i.description||"",location:i.location||"",photoCount:i.photoCount||0,zones:s.zones||[],paths:s.paths||[],markers:s.markers||[],coordinates:s.coordinates,createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt||i.createdAt),synced:!0};o.push(f),_=!0,console.log("Proyecto descargado del servidor:",i.name,"con",f.markers?.length||0,"marcadores")}_&&(yield t.storageService.setProjects(o)),yield t.syncService.syncPending()}catch(n){console.error("Error sincronizando proyectos:",n?.message||n),401===n?.status&&(yield(yield t.toastCtrl.create({message:"Sesion expirada. Vuelve a iniciar sesion.",duration:3e3,position:"top",color:"warning"})).present())}}catch{t.isOnline=!1}o.sort((n,r)=>{const l=new Date(n.updatedAt||n.createdAt).getTime();return new Date(r.updatedAt||r.createdAt).getTime()-l}),t.projects=o,t.isLoading=!1})()}doRefresh(t){var o=this;return(0,u.A)(function*(){yield o.loadProjects(),t.target.complete()})()}get filteredProjects(){if(!this.searchQuery.trim())return this.projects;const t=this.searchQuery.toLowerCase();return this.projects.filter(o=>o.name.toLowerCase().includes(t)||o.description?.toLowerCase().includes(t))}createProject(){var t=this;return(0,u.A)(function*(){let o="";try{const r=yield Promise.race([t.gpsService.getCurrentPosition(),new Promise((l,h)=>setTimeout(()=>h(new Error("timeout")),5e3))]);o=yield t.getLocationName(r.latitude,r.longitude)}catch(r){console.log("No se pudo obtener ubicaci\xf3n:",r)}yield(yield t.alertCtrl.create({header:"Nuevo Proyecto",inputs:[{name:"name",type:"text",placeholder:"Nombre *"},{name:"description",type:"textarea",placeholder:"Descripcion"},{name:"location",type:"text",placeholder:"Ubicacion",value:o}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Crear",handler:r=>!!r.name?.trim()&&(t.saveProject(r),!0)}]})).present()})()}getLocationName(t,o){var n=this;return(0,u.A)(function*(){try{const r=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t}&lon=${o}&zoom=18`,l=yield n.http.get(r).toPromise();if(l?.display_name)return l.display_name.split(",").slice(0,3).join(",").trim()}catch(r){console.log("Geocoding error:",r)}return""})()}saveProject(t){var o=this;return(0,u.A)(function*(){try{const n="proj_"+Date.now(),r={id:n,name:t.name.trim(),description:t.description||"",location:t.location||"",photoCount:0,createdAt:new Date,updatedAt:new Date,synced:!1};if(o.isOnline)try{const l=yield(0,y._)(o.apiService.post("/projects",{name:r.name,description:r.description,location:r.location}));l&&l.project&&(r.serverId=l.project.id,r.synced=!0,console.log("Proyecto creado en servidor con ID:",l.project.id))}catch(l){console.log("API error, saving locally:",l?.message||l),yield o.syncService.queueForSync("CREATE","project",n,r)}else yield o.syncService.queueForSync("CREATE","project",n,r);o.projects.unshift(r),yield o.storageService.setProjects(o.projects)}catch(n){console.error("Error creating project:",n)}})()}openProject(t){this.router.navigate(["/project-detail",t.id])}showProjectOptions(t,o){var n=this;return(0,u.A)(function*(){o.stopPropagation(),yield(yield n.actionSheetCtrl.create({header:t.name,buttons:[{text:"Ver",icon:"eye-outline",handler:()=>n.openProject(t)},{text:"Eliminar",icon:"trash-outline",role:"destructive",handler:()=>n.deleteProject(t)},{text:"Cancelar",role:"cancel"}]})).present()})()}deleteProject(t){var o=this;return(0,u.A)(function*(){if(t.serverId&&o.isOnline)try{yield(0,y._)(o.apiService.delete(`/projects/${t.serverId}`)),console.log("Proyecto eliminado del servidor:",t.serverId)}catch(n){console.log("Error eliminando del servidor:",n?.message)}o.projects=o.projects.filter(n=>n.id!==t.id),yield o.storageService.deleteProject(t.id)})()}forceSync(){var t=this;return(0,u.A)(function*(){yield t.loadProjects()})()}formatDate(t){const o="string"==typeof t?new Date(t):t;return o.toLocaleDateString("es-ES",{day:"numeric",month:"short",year:"numeric"})+" - "+o.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}static#e=c=()=>(this.\u0275fac=function(o){return new(o||a)(e.rXU(x.G),e.rXU(C.n),e.rXU(M.H),e.rXU(O.a),e.rXU(k.Ix),e.rXU(d.hG),e.rXU(d.K_),e.rXU(d.GD),e.rXU(I.Qq))},this.\u0275cmp=e.VBU({type:a,selectors:[["app-projects"]],standalone:!1,decls:18,vars:7,consts:[["slot","end"],["title","Sincronizar",3,"click",4,"ngIf"],[3,"click"],["name","add-outline","slot","icon-only"],["placeholder","Buscar proyectos...","debounce","300",3,"ngModelChange","ngModel"],["slot","fixed",3,"ionRefresh"],["class","offline-banner",4,"ngIf"],["class","loading-container",4,"ngIf"],["class","empty-state",4,"ngIf"],["class","geotech-list",4,"ngIf"],["vertical","bottom","horizontal","end","slot","fixed",4,"ngIf"],["title","Sincronizar",3,"click"],["name","sync-outline","slot","icon-only"],[1,"offline-banner"],["name","cloud-offline-outline"],[1,"loading-container"],["name","crescent"],[1,"empty-state"],[1,"empty-icon"],["name","folder-open-outline"],[1,"empty-title"],[1,"empty-description"],[1,"geotech-btn-primary",3,"click"],["name","add-outline","slot","start"],[1,"geotech-list"],["button","","detail","",3,"click",4,"ngFor","ngForOf"],["button","","detail","",3,"click"],["slot","start",1,"project-icon"],["name","folder-outline"],["name","cloud-done-outline","class","sync-badge synced","title","Sincronizado",4,"ngIf"],["name","cloud-offline-outline","class","sync-badge not-synced","title","No sincronizado",4,"ngIf"],[1,"project-name"],[1,"project-meta"],["name","calendar-outline"],[4,"ngIf"],["class","project-location",4,"ngIf"],["fill","clear","slot","end",3,"click"],["name","ellipsis-vertical","slot","icon-only"],["name","cloud-done-outline","title","Sincronizado",1,"sync-badge","synced"],["name","cloud-offline-outline","title","No sincronizado",1,"sync-badge","not-synced"],["name","camera-outline"],[1,"project-location"],["name","location-outline"],["vertical","bottom","horizontal","end","slot","fixed"],["name","add"]],template:function(o,n){1&o&&(e.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),e.EFF(3,"Proyectos"),e.k0s(),e.j41(4,"ion-buttons",0),e.DNE(5,S,2,0,"ion-button",1),e.j41(6,"ion-button",2),e.bIt("click",function(){return n.createProject()}),e.nrm(7,"ion-icon",3),e.k0s()()(),e.j41(8,"ion-toolbar")(9,"ion-searchbar",4),e.mxI("ngModelChange",function(l){return e.DH7(n.searchQuery,l)||(n.searchQuery=l),l}),e.k0s()()(),e.j41(10,"ion-content")(11,"ion-refresher",5),e.bIt("ionRefresh",function(l){return n.doRefresh(l)}),e.nrm(12,"ion-refresher-content"),e.k0s(),e.DNE(13,w,4,0,"div",6)(14,z,4,0,"div",7)(15,E,10,0,"div",8)(16,D,2,1,"ion-list",9),e.k0s(),e.DNE(17,$,3,0,"ion-fab",10)),2&o&&(e.R7$(5),e.Y8G("ngIf",n.isOnline),e.R7$(4),e.R50("ngModel",n.searchQuery),e.R7$(4),e.Y8G("ngIf",!n.isOnline),e.R7$(),e.Y8G("ngIf",n.isLoading),e.R7$(),e.Y8G("ngIf",!n.isLoading&&0===n.filteredProjects.length),e.R7$(),e.Y8G("ngIf",!n.isLoading&&n.filteredProjects.length>0),e.R7$(),e.Y8G("ngIf",!n.isLoading&&n.filteredProjects.length>0))},dependencies:[v.Sq,v.bT,P.BC,P.vS,d.Jm,d.QW,d.W9,d.Q8,d.YW,d.eU,d.iq,d.uz,d.he,d.nf,d.To,d.Ki,d.S1,d.w2,d.BC,d.ai,d.Gw],styles:["ion-searchbar[_ngcontent-%COMP%]{--background: var(--geotech-bg-glass) !important;--color: var(--geotech-text-primary) !important;--placeholder-color: var(--geotech-text-muted) !important;--icon-color: var(--geotech-accent-cyan) !important;--clear-button-color: var(--geotech-text-muted) !important;--border-radius: var(--geotech-radius-md) !important;padding:8px 16px!important}ion-searchbar[_ngcontent-%COMP%]   .searchbar-input[_ngcontent-%COMP%]{color:var(--geotech-text-primary)!important;font-size:14px!important}.offline-banner[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:10px;padding:12px 20px;background:#f59e0b26;border-bottom:1px solid rgba(245,158,11,.3);color:var(--geotech-accent-orange);font-size:13px;font-weight:600}.offline-banner[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:18px;filter:drop-shadow(0 0 4px var(--geotech-accent-orange))}.loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:64px}.loading-container[_ngcontent-%COMP%]   ion-spinner[_ngcontent-%COMP%]{width:48px;height:48px;color:var(--geotech-accent-cyan)}.loading-container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-top:20px;color:var(--geotech-text-secondary);font-size:14px;font-weight:500}.empty-state[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:64px 24px;text-align:center}.empty-icon[_ngcontent-%COMP%]{width:100px;height:100px;border-radius:50%;background:var(--geotech-bg-glass);border:1px solid var(--geotech-border-glass);display:flex;align-items:center;justify-content:center;margin-bottom:28px}.empty-icon[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:48px;color:var(--geotech-text-muted)}.empty-title[_ngcontent-%COMP%]{font-size:22px;font-weight:700;color:var(--geotech-text-primary);margin:0 0 10px}.empty-description[_ngcontent-%COMP%]{font-size:15px;color:var(--geotech-text-muted);max-width:300px;margin:0 0 28px;line-height:1.6}ion-list.geotech-list[_ngcontent-%COMP%]{padding:16px;background:transparent}ion-list.geotech-list[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]{--background: var(--geotech-bg-glass);--border-radius: var(--geotech-radius-lg);--padding-start: 16px;--padding-end: 12px;--min-height: 88px;margin-bottom:12px;border:1px solid var(--geotech-border-glass);border-radius:var(--geotech-radius-lg);-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);transition:all .3s ease}ion-list.geotech-list[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]:hover{border-color:#00d4ff4d;box-shadow:var(--geotech-glow-cyan)}.project-icon[_ngcontent-%COMP%]{width:52px;height:52px;border-radius:var(--geotech-radius-md);background:#00d4ff26;border:1px solid rgba(0,212,255,.2);display:flex;align-items:center;justify-content:center;position:relative}.project-icon[_ngcontent-%COMP%] > ion-icon[_ngcontent-%COMP%]:first-child{font-size:26px;color:var(--geotech-accent-cyan)}.project-icon[_ngcontent-%COMP%]   .sync-badge[_ngcontent-%COMP%]{position:absolute;bottom:-4px;right:-4px;font-size:14px;padding:2px;border-radius:50%;background:var(--geotech-bg-dark)}.project-icon[_ngcontent-%COMP%]   .sync-badge.synced[_ngcontent-%COMP%]{color:var(--geotech-accent-green, #10b981)}.project-icon[_ngcontent-%COMP%]   .sync-badge.not-synced[_ngcontent-%COMP%]{color:var(--geotech-accent-orange, #f59e0b)}.project-name[_ngcontent-%COMP%]{font-size:16px;font-weight:700;color:var(--geotech-text-primary);margin-bottom:6px}.project-meta[_ngcontent-%COMP%]{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--geotech-text-muted)}.project-meta[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:14px}.project-meta[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{display:flex;align-items:center;gap:4px;margin-left:12px}.project-location[_ngcontent-%COMP%]{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--geotech-text-secondary);margin-top:6px}.project-location[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:14px;color:var(--geotech-accent-cyan)}ion-fab-button[_ngcontent-%COMP%]{--background: linear-gradient(135deg, var(--geotech-accent-cyan), #0099cc);--background-activated: var(--geotech-accent-cyan);--box-shadow: var(--geotech-glow-cyan);color:var(--geotech-bg-dark)}.geotech-btn-primary[_ngcontent-%COMP%]{--background: linear-gradient(135deg, var(--geotech-accent-cyan), #0099cc);--border-radius: var(--geotech-radius-md);--box-shadow: var(--geotech-glow-cyan);height:52px;font-weight:600;text-transform:none;color:var(--geotech-bg-dark)}ion-list.geotech-list[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]   ion-button[fill=clear][_ngcontent-%COMP%]{--background: transparent !important;--background-hover: transparent !important;--background-focused: transparent !important;--color: var(--geotech-text-muted)}ion-list.geotech-list[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]   ion-button[fill=clear][_ngcontent-%COMP%]:hover{--color: var(--geotech-accent-cyan)}"]}))}return c(),a})()}];let X=(()=>{var c;class a{static#e=c=()=>(this.\u0275fac=function(o){return new(o||a)},this.\u0275mod=e.$C({type:a}),this.\u0275inj=m.G2t({imports:[b.iI.forChild(N),b.iI]}))}return c(),a})(),B=(()=>{var c;class a{static#e=c=()=>(this.\u0275fac=function(o){return new(o||a)},this.\u0275mod=e.$C({type:a}),this.\u0275inj=m.G2t({imports:[v.MD,P.YN,P.X1,d.bv,X]}))}return c(),a})()}}]);