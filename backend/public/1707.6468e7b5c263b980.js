"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1707],{1707:(Y,b,p)=>{p.r(b),p.d(b,{ProjectsPageModule:()=>L});var j=p(2200),P=p(4341),d=p(7343),x=p(8132),u=p(467),y=p(4843),e=p(3664),m=p(2615),C=p(3366),M=p(7291),O=p(6386),k=p(2092),I=p(2704),S=p(9330);function w(c,a){if(1&c){const g=e.RV6();e.j41(0,"ion-button",11),e.bIt("click",function(){m.eBV(g);const o=e.XpG();return m.Njj(o.forceSync())}),e.nrm(1,"ion-icon",12),e.k0s()}}function z(c,a){1&c&&(e.j41(0,"div",13),e.nrm(1,"ion-icon",14),e.j41(2,"span"),e.EFF(3,"Modo sin conexion"),e.k0s()())}function E(c,a){1&c&&(e.j41(0,"div",15),e.nrm(1,"ion-spinner",16),e.j41(2,"p"),e.EFF(3,"Cargando proyectos..."),e.k0s()())}function T(c,a){if(1&c){const g=e.RV6();e.j41(0,"div",17)(1,"div",18),e.nrm(2,"ion-icon",19),e.k0s(),e.j41(3,"h3",20),e.EFF(4,"Sin proyectos"),e.k0s(),e.j41(5,"p",21),e.EFF(6,"Crea tu primer proyecto para comenzar a gestionar tus trabajos de campo."),e.k0s(),e.j41(7,"ion-button",22),e.bIt("click",function(){m.eBV(g);const o=e.XpG();return m.Njj(o.createProject())}),e.nrm(8,"ion-icon",23),e.EFF(9," Crear proyecto "),e.k0s()()}}function R(c,a){1&c&&e.nrm(0,"ion-icon",38)}function A(c,a){1&c&&e.nrm(0,"ion-icon",39)}function F(c,a){if(1&c&&(e.j41(0,"span"),e.nrm(1,"ion-icon",40),e.EFF(2),e.k0s()),2&c){const g=e.XpG().$implicit;e.R7$(2),e.SpI(" ",g.photoCount," fotos ")}}function G(c,a){if(1&c&&(e.j41(0,"p",41),e.nrm(1,"ion-icon",42),e.EFF(2),e.k0s()),2&c){const g=e.XpG().$implicit;e.R7$(2),e.SpI(" ",g.location," ")}}function D(c,a){if(1&c){const g=e.RV6();e.j41(0,"ion-item",26),e.bIt("click",function(){const o=m.eBV(g).$implicit,n=e.XpG(2);return m.Njj(n.openProject(o))}),e.j41(1,"div",27),e.nrm(2,"ion-icon",28),e.DNE(3,R,1,0,"ion-icon",29)(4,A,1,0,"ion-icon",30),e.k0s(),e.j41(5,"ion-label")(6,"h2",31),e.EFF(7),e.k0s(),e.j41(8,"p",32),e.nrm(9,"ion-icon",33),e.EFF(10),e.DNE(11,F,3,1,"span",34),e.k0s(),e.DNE(12,G,3,1,"p",35),e.k0s(),e.j41(13,"ion-button",36),e.bIt("click",function(o){const n=m.eBV(g).$implicit,i=e.XpG(2);return m.Njj(i.showProjectOptions(n,o))}),e.nrm(14,"ion-icon",37),e.k0s()()}if(2&c){const g=a.$implicit,t=e.XpG(2);e.R7$(3),e.Y8G("ngIf",g.synced),e.R7$(),e.Y8G("ngIf",!g.synced),e.R7$(3),e.JRh(g.name),e.R7$(3),e.SpI(" ",t.formatDate(g.createdAt)," "),e.R7$(),e.Y8G("ngIf",g.photoCount),e.R7$(),e.Y8G("ngIf",g.location)}}function $(c,a){if(1&c&&(e.j41(0,"ion-list",24),e.DNE(1,D,15,6,"ion-item",25),e.k0s()),2&c){const g=e.XpG();e.R7$(),e.Y8G("ngForOf",g.filteredProjects)}}function N(c,a){if(1&c){const g=e.RV6();e.j41(0,"ion-fab",43)(1,"ion-fab-button",2),e.bIt("click",function(){m.eBV(g);const o=e.XpG();return m.Njj(o.createProject())}),e.nrm(2,"ion-icon",44),e.k0s()()}}const X=[{path:"",component:(()=>{var c;class a{constructor(t,o,n,i,s,h,f,v,r){this.apiService=t,this.storageService=o,this.syncService=n,this.gpsService=i,this.router=s,this.alertCtrl=h,this.toastCtrl=f,this.actionSheetCtrl=v,this.http=r,this.projects=[],this.isLoading=!0,this.isOnline=!0,this.searchQuery=""}ngOnInit(){var t=this;return(0,u.A)(function*(){yield t.loadProjects()})()}ionViewWillEnter(){var t=this;return(0,u.A)(function*(){yield t.loadProjects()})()}loadProjects(){var t=this;return(0,u.A)(function*(){t.isLoading=!0;let o=yield t.storageService.getProjects();try{yield(0,y._)(t.apiService.get("/health")),t.isOnline=!0;try{const i=(yield(0,y._)(t.apiService.get("/projects")))?.projects||[];console.log("Proyectos en servidor:",i.length),console.log("Proyectos locales:",o.length);const s=new Map;i.forEach(r=>s.set(r.id,r));const h=new Map;o.forEach(r=>{r.serverId&&h.set(r.serverId,r)});let f=!1;for(const r of o)if(!r.serverId&&!r.synced)try{console.log("Subiendo proyecto local al servidor:",r.name);const l=yield(0,y._)(t.apiService.post("/projects",{name:r.name,description:r.description,location:r.location}));l?.project?.id&&(r.serverId=l.project.id,r.synced=!0,f=!0,console.log("Proyecto subido con serverId:",r.serverId))}catch(l){console.log("Error subiendo proyecto:",r.name,l?.message)}for(const r of i)if(h.has(r.id)){const l=h.get(r.id);if(l&&r.content){const _=r.content;new Date(r.updatedAt||0).getTime()>new Date(l.updatedAt||0).getTime()&&(l.zones=_.zones||l.zones,l.paths=_.paths||l.paths,l.markers=_.markers||l.markers,l.coordinates=_.coordinates||l.coordinates,l.updatedAt=new Date(r.updatedAt),f=!0,console.log("Contenido actualizado desde servidor:",l.name))}}else{const l=r.content||{},_={id:"proj_"+Date.now()+"_"+Math.random().toString(36).substr(2,5),serverId:r.id,name:r.name,description:r.description||"",location:r.location||"",photoCount:r.photoCount||0,zones:l.zones||[],paths:l.paths||[],markers:l.markers||[],coordinates:l.coordinates,createdAt:new Date(r.createdAt),updatedAt:new Date(r.updatedAt||r.createdAt),synced:!0};o.push(_),f=!0,console.log("Proyecto descargado del servidor:",r.name,"con",_.markers?.length||0,"marcadores")}const v=[];for(const r of o)r.serverId&&!s.has(r.serverId)&&(v.push(r.id),console.log("Proyecto eliminado del servidor, quitando local:",r.name));v.length>0&&(o=o.filter(r=>!v.includes(r.id)),f=!0),f&&(yield t.storageService.setProjects(o)),yield t.syncService.syncPending()}catch(n){console.error("Error sincronizando proyectos:",n?.message||n),401===n?.status&&(yield(yield t.toastCtrl.create({message:"Sesion expirada. Vuelve a iniciar sesion.",duration:3e3,position:"top",color:"warning"})).present())}}catch{t.isOnline=!1}o.sort((n,i)=>{const s=new Date(n.updatedAt||n.createdAt).getTime();return new Date(i.updatedAt||i.createdAt).getTime()-s}),t.projects=o,t.isLoading=!1})()}doRefresh(t){var o=this;return(0,u.A)(function*(){yield o.loadProjects(),t.target.complete()})()}get filteredProjects(){if(!this.searchQuery.trim())return this.projects;const t=this.searchQuery.toLowerCase();return this.projects.filter(o=>o.name.toLowerCase().includes(t)||o.description?.toLowerCase().includes(t))}createProject(){var t=this;return(0,u.A)(function*(){let o="";try{const i=yield Promise.race([t.gpsService.getCurrentPosition(),new Promise((s,h)=>setTimeout(()=>h(new Error("timeout")),5e3))]);o=yield t.getLocationName(i.latitude,i.longitude)}catch(i){console.log("No se pudo obtener ubicaci\xf3n:",i)}yield(yield t.alertCtrl.create({header:"Nuevo Proyecto",inputs:[{name:"name",type:"text",placeholder:"Nombre *"},{name:"description",type:"textarea",placeholder:"Descripcion"},{name:"location",type:"text",placeholder:"Ubicacion",value:o}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Crear",handler:i=>!!i.name?.trim()&&(t.saveProject(i),!0)}]})).present()})()}getLocationName(t,o){var n=this;return(0,u.A)(function*(){try{const i=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${t}&lon=${o}&zoom=18`,s=yield n.http.get(i).toPromise();if(s?.display_name)return s.display_name.split(",").slice(0,3).join(",").trim()}catch(i){console.log("Geocoding error:",i)}return""})()}saveProject(t){var o=this;return(0,u.A)(function*(){try{const n="proj_"+Date.now(),i={id:n,name:t.name.trim(),description:t.description||"",location:t.location||"",photoCount:0,createdAt:new Date,updatedAt:new Date,synced:!1};if(o.isOnline)try{const s=yield(0,y._)(o.apiService.post("/projects",{name:i.name,description:i.description,location:i.location}));s&&s.project&&(i.serverId=s.project.id,i.synced=!0,console.log("Proyecto creado en servidor con ID:",s.project.id))}catch(s){console.log("API error, saving locally:",s?.message||s),yield o.syncService.queueForSync("CREATE","project",n,i)}else yield o.syncService.queueForSync("CREATE","project",n,i);o.projects.unshift(i),yield o.storageService.setProjects(o.projects)}catch(n){console.error("Error creating project:",n)}})()}openProject(t){this.router.navigate(["/project-detail",t.id])}showProjectOptions(t,o){var n=this;return(0,u.A)(function*(){o.stopPropagation(),yield(yield n.actionSheetCtrl.create({header:t.name,buttons:[{text:"Ver",icon:"eye-outline",handler:()=>n.openProject(t)},{text:"Eliminar",icon:"trash-outline",role:"destructive",handler:()=>n.deleteProject(t)},{text:"Cancelar",role:"cancel"}]})).present()})()}deleteProject(t){var o=this;return(0,u.A)(function*(){if(t.serverId&&o.isOnline)try{yield(0,y._)(o.apiService.delete(`/projects/${t.serverId}`)),console.log("Proyecto eliminado del servidor:",t.serverId)}catch(n){console.log("Error eliminando del servidor:",n?.message)}o.projects=o.projects.filter(n=>n.id!==t.id),yield o.storageService.deleteProject(t.id)})()}forceSync(){var t=this;return(0,u.A)(function*(){yield t.loadProjects()})()}formatDate(t){const o="string"==typeof t?new Date(t):t;return o.toLocaleDateString("es-ES",{day:"numeric",month:"short",year:"numeric"})+" - "+o.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}static#e=c=()=>(this.\u0275fac=function(o){return new(o||a)(e.rXU(C.G),e.rXU(M.n),e.rXU(O.H),e.rXU(k.a),e.rXU(I.Ix),e.rXU(d.hG),e.rXU(d.K_),e.rXU(d.GD),e.rXU(S.Qq))},this.\u0275cmp=e.VBU({type:a,selectors:[["app-projects"]],standalone:!1,decls:18,vars:7,consts:[["slot","end"],["title","Sincronizar",3,"click",4,"ngIf"],[3,"click"],["name","add-outline","slot","icon-only"],["placeholder","Buscar proyectos...","debounce","300",3,"ngModelChange","ngModel"],["slot","fixed",3,"ionRefresh"],["class","offline-banner",4,"ngIf"],["class","loading-container",4,"ngIf"],["class","empty-state",4,"ngIf"],["class","geotech-list",4,"ngIf"],["vertical","bottom","horizontal","end","slot","fixed",4,"ngIf"],["title","Sincronizar",3,"click"],["name","sync-outline","slot","icon-only"],[1,"offline-banner"],["name","cloud-offline-outline"],[1,"loading-container"],["name","crescent"],[1,"empty-state"],[1,"empty-icon"],["name","folder-open-outline"],[1,"empty-title"],[1,"empty-description"],[1,"geotech-btn-primary",3,"click"],["name","add-outline","slot","start"],[1,"geotech-list"],["button","","detail","",3,"click",4,"ngFor","ngForOf"],["button","","detail","",3,"click"],["slot","start",1,"project-icon"],["name","folder-outline"],["name","cloud-done-outline","class","sync-badge synced","title","Sincronizado",4,"ngIf"],["name","cloud-offline-outline","class","sync-badge not-synced","title","No sincronizado",4,"ngIf"],[1,"project-name"],[1,"project-meta"],["name","calendar-outline"],[4,"ngIf"],["class","project-location",4,"ngIf"],["fill","clear","slot","end",3,"click"],["name","ellipsis-vertical","slot","icon-only"],["name","cloud-done-outline","title","Sincronizado",1,"sync-badge","synced"],["name","cloud-offline-outline","title","No sincronizado",1,"sync-badge","not-synced"],["name","camera-outline"],[1,"project-location"],["name","location-outline"],["vertical","bottom","horizontal","end","slot","fixed"],["name","add"]],template:function(o,n){1&o&&(e.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),e.EFF(3,"Proyectos"),e.k0s(),e.j41(4,"ion-buttons",0),e.DNE(5,w,2,0,"ion-button",1),e.j41(6,"ion-button",2),e.bIt("click",function(){return n.createProject()}),e.nrm(7,"ion-icon",3),e.k0s()()(),e.j41(8,"ion-toolbar")(9,"ion-searchbar",4),e.mxI("ngModelChange",function(s){return e.DH7(n.searchQuery,s)||(n.searchQuery=s),s}),e.k0s()()(),e.j41(10,"ion-content")(11,"ion-refresher",5),e.bIt("ionRefresh",function(s){return n.doRefresh(s)}),e.nrm(12,"ion-refresher-content"),e.k0s(),e.DNE(13,z,4,0,"div",6)(14,E,4,0,"div",7)(15,T,10,0,"div",8)(16,$,2,1,"ion-list",9),e.k0s(),e.DNE(17,N,3,0,"ion-fab",10)),2&o&&(e.R7$(5),e.Y8G("ngIf",n.isOnline),e.R7$(4),e.R50("ngModel",n.searchQuery),e.R7$(4),e.Y8G("ngIf",!n.isOnline),e.R7$(),e.Y8G("ngIf",n.isLoading),e.R7$(),e.Y8G("ngIf",!n.isLoading&&0===n.filteredProjects.length),e.R7$(),e.Y8G("ngIf",!n.isLoading&&n.filteredProjects.length>0),e.R7$(),e.Y8G("ngIf",!n.isLoading&&n.filteredProjects.length>0))},dependencies:[j.Sq,j.bT,P.BC,P.vS,d.Jm,d.QW,d.W9,d.Q8,d.YW,d.eU,d.iq,d.uz,d.he,d.nf,d.To,d.Ki,d.S1,d.w2,d.BC,d.ai,d.Gw],styles:["ion-searchbar[_ngcontent-%COMP%]{--background: var(--geotech-bg-glass) !important;--color: var(--geotech-text-primary) !important;--placeholder-color: var(--geotech-text-muted) !important;--icon-color: var(--geotech-accent-cyan) !important;--clear-button-color: var(--geotech-text-muted) !important;--border-radius: var(--geotech-radius-md) !important;padding:8px 16px!important}ion-searchbar[_ngcontent-%COMP%]   .searchbar-input[_ngcontent-%COMP%]{color:var(--geotech-text-primary)!important;font-size:14px!important}.offline-banner[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:10px;padding:12px 20px;background:#f59e0b26;border-bottom:1px solid rgba(245,158,11,.3);color:var(--geotech-accent-orange);font-size:13px;font-weight:600}.offline-banner[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:18px;filter:drop-shadow(0 0 4px var(--geotech-accent-orange))}.loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:64px}.loading-container[_ngcontent-%COMP%]   ion-spinner[_ngcontent-%COMP%]{width:48px;height:48px;color:var(--geotech-accent-cyan)}.loading-container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-top:20px;color:var(--geotech-text-secondary);font-size:14px;font-weight:500}.empty-state[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:64px 24px;text-align:center}.empty-icon[_ngcontent-%COMP%]{width:100px;height:100px;border-radius:50%;background:var(--geotech-bg-glass);border:1px solid var(--geotech-border-glass);display:flex;align-items:center;justify-content:center;margin-bottom:28px}.empty-icon[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:48px;color:var(--geotech-text-muted)}.empty-title[_ngcontent-%COMP%]{font-size:22px;font-weight:700;color:var(--geotech-text-primary);margin:0 0 10px}.empty-description[_ngcontent-%COMP%]{font-size:15px;color:var(--geotech-text-muted);max-width:300px;margin:0 0 28px;line-height:1.6}ion-list.geotech-list[_ngcontent-%COMP%]{padding:16px;background:transparent}ion-list.geotech-list[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]{--background: var(--geotech-bg-glass);--border-radius: var(--geotech-radius-lg);--padding-start: 16px;--padding-end: 12px;--min-height: 88px;margin-bottom:12px;border:1px solid var(--geotech-border-glass);border-radius:var(--geotech-radius-lg);-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);transition:all .3s ease}ion-list.geotech-list[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]:hover{border-color:#00d4ff4d;box-shadow:var(--geotech-glow-cyan)}.project-icon[_ngcontent-%COMP%]{width:52px;height:52px;border-radius:var(--geotech-radius-md);background:#00d4ff26;border:1px solid rgba(0,212,255,.2);display:flex;align-items:center;justify-content:center;position:relative}.project-icon[_ngcontent-%COMP%] > ion-icon[_ngcontent-%COMP%]:first-child{font-size:26px;color:var(--geotech-accent-cyan)}.project-icon[_ngcontent-%COMP%]   .sync-badge[_ngcontent-%COMP%]{position:absolute;bottom:-4px;right:-4px;font-size:14px;padding:2px;border-radius:50%;background:var(--geotech-bg-dark)}.project-icon[_ngcontent-%COMP%]   .sync-badge.synced[_ngcontent-%COMP%]{color:var(--geotech-accent-green, #10b981)}.project-icon[_ngcontent-%COMP%]   .sync-badge.not-synced[_ngcontent-%COMP%]{color:var(--geotech-accent-orange, #f59e0b)}.project-name[_ngcontent-%COMP%]{font-size:16px;font-weight:700;color:var(--geotech-text-primary);margin-bottom:6px}.project-meta[_ngcontent-%COMP%]{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--geotech-text-muted)}.project-meta[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:14px}.project-meta[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{display:flex;align-items:center;gap:4px;margin-left:12px}.project-location[_ngcontent-%COMP%]{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--geotech-text-secondary);margin-top:6px}.project-location[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:14px;color:var(--geotech-accent-cyan)}ion-fab-button[_ngcontent-%COMP%]{--background: linear-gradient(135deg, var(--geotech-accent-cyan), #0099cc);--background-activated: var(--geotech-accent-cyan);--box-shadow: var(--geotech-glow-cyan);color:var(--geotech-bg-dark)}.geotech-btn-primary[_ngcontent-%COMP%]{--background: linear-gradient(135deg, var(--geotech-accent-cyan), #0099cc);--border-radius: var(--geotech-radius-md);--box-shadow: var(--geotech-glow-cyan);height:52px;font-weight:600;text-transform:none;color:var(--geotech-bg-dark)}ion-list.geotech-list[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]   ion-button[fill=clear][_ngcontent-%COMP%]{--background: transparent !important;--background-hover: transparent !important;--background-focused: transparent !important;--color: var(--geotech-text-muted)}ion-list.geotech-list[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]   ion-button[fill=clear][_ngcontent-%COMP%]:hover{--color: var(--geotech-accent-cyan)}"]}))}return c(),a})()}];let B=(()=>{var c;class a{static#e=c=()=>(this.\u0275fac=function(o){return new(o||a)},this.\u0275mod=e.$C({type:a}),this.\u0275inj=m.G2t({imports:[x.iI.forChild(X),x.iI]}))}return c(),a})(),L=(()=>{var c;class a{static#e=c=()=>(this.\u0275fac=function(o){return new(o||a)},this.\u0275mod=e.$C({type:a}),this.\u0275inj=m.G2t({imports:[j.MD,P.YN,P.X1,d.bv,B]}))}return c(),a})()}}]);