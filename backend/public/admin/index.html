<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GeoTech Admin - Panel de Administracion</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
      color: #e2e8f0;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    header {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(100, 116, 139, 0.3);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { font-size: 24px; font-weight: 700; color: #00d4ff; }
    .logout-btn {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #ef4444;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .logout-btn:hover { background: rgba(239, 68, 68, 0.3); }

    /* Login */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .login-card {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
    }
    .login-card h1 { text-align: center; margin-bottom: 32px; color: #00d4ff; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px; }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 16px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 16px;
    }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #00d4ff; }
    .form-row { display: flex; gap: 12px; }
    .form-row .form-group { flex: 1; }
    .login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    .login-btn:hover { opacity: 0.9; }
    .error-msg { color: #ef4444; margin-top: 16px; text-align: center; }

    /* Dashboard */
    .dashboard { display: none; }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
    }
    .stat-card h3 { font-size: 14px; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; }
    .stat-card .value { font-size: 36px; font-weight: 700; color: #00d4ff; }
    .stat-card.green .value { color: #10b981; }
    .stat-card.orange .value { color: #f59e0b; }
    .stat-card.purple .value { color: #8b5cf6; }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid rgba(100, 116, 139, 0.3);
      padding-bottom: 16px;
      flex-wrap: wrap;
    }
    .tab-btn {
      background: transparent;
      border: 1px solid rgba(100, 116, 139, 0.3);
      color: #94a3b8;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    .tab-btn.active { background: #00d4ff; color: #0f172a; border-color: #00d4ff; }
    .tab-btn:hover:not(.active) { border-color: #00d4ff; color: #00d4ff; }

    /* Tables */
    .panel { display: none; }
    .panel.active { display: block; }
    .table-container {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 12px;
      overflow: hidden;
    }
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(100, 116, 139, 0.3);
      flex-wrap: wrap;
      gap: 10px;
    }
    .table-header h2 { font-size: 18px; }
    .add-btn {
      background: #10b981;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .add-btn:hover { opacity: 0.9; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 14px 20px; text-align: left; border-bottom: 1px solid rgba(100, 116, 139, 0.2); }
    th { color: #94a3b8; font-size: 12px; text-transform: uppercase; font-weight: 600; }
    td { font-size: 14px; }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge.active { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .badge.pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .badge.expired { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .badge.revoked { background: rgba(100, 116, 139, 0.2); color: #64748b; }
    .badge.admin { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .action-btn {
      background: rgba(100, 116, 139, 0.2);
      border: none;
      color: #94a3b8;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 4px;
      margin-bottom: 4px;
    }
    .action-btn:hover { background: rgba(100, 116, 139, 0.4); }
    .action-btn.danger { color: #ef4444; }
    .action-btn.danger:hover { background: rgba(239, 68, 68, 0.2); }
    .action-btn.primary { color: #00d4ff; }
    .action-btn.primary:hover { background: rgba(0, 212, 255, 0.2); }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: #1e293b;
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-content.large { max-width: 900px; }
    .modal-content h2 { margin-bottom: 24px; }
    .modal-btns { display: flex; gap: 12px; margin-top: 24px; }
    .modal-btns button { flex: 1; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .cancel-btn { background: transparent; border: 1px solid rgba(100, 116, 139, 0.3); color: #94a3b8; }
    .submit-btn { background: #00d4ff; border: none; color: #0f172a; }
    .submit-btn.danger { background: #ef4444; color: white; }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 20px;
    }
    .page-btn {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(100, 116, 139, 0.3);
      color: #94a3b8;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }
    .page-btn.active { background: #00d4ff; color: #0f172a; border-color: #00d4ff; }

    .copy-btn {
      background: transparent;
      border: none;
      color: #00d4ff;
      cursor: pointer;
      padding: 4px;
    }
    .license-key { font-family: monospace; font-size: 12px; }

    /* User Detail */
    .user-detail-section {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .user-detail-section h3 {
      font-size: 14px;
      color: #00d4ff;
      margin-bottom: 12px;
      text-transform: uppercase;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(100, 116, 139, 0.2);
    }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { color: #94a3b8; }
    .detail-value { color: #e2e8f0; font-weight: 500; }

    /* Project cards */
    .project-card {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }
    .project-card h4 { color: #00d4ff; margin-bottom: 4px; }
    .project-card p { color: #94a3b8; font-size: 12px; }

    .info-text { color: #94a3b8; font-size: 12px; margin-top: 4px; }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginContainer" class="login-container">
    <div class="login-card">
      <h1>GeoTech Admin</h1>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="admin@geotech.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="********">
      </div>
      <button class="login-btn" onclick="login()">Iniciar Sesion</button>
      <p id="loginError" class="error-msg" style="display:none"></p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="dashboard">
    <header>
      <div class="logo">GeoTech Admin</div>
      <button class="logout-btn" onclick="logout()">Cerrar Sesion</button>
    </header>

    <div class="container">
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Usuarios</h3>
          <div class="value" id="statUsers">0</div>
        </div>
        <div class="stat-card green">
          <h3>Licencias Activas</h3>
          <div class="value" id="statActive">0</div>
        </div>
        <div class="stat-card orange">
          <h3>Licencias Expiradas</h3>
          <div class="value" id="statExpired">0</div>
        </div>
        <div class="stat-card purple">
          <h3>Ingresos Totales</h3>
          <div class="value" id="statRevenue">0</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" onclick="showPanel('licenses')">Licencias</button>
        <button class="tab-btn" onclick="showPanel('users')">Usuarios</button>
        <button class="tab-btn" onclick="showPanel('types')">Tipos de Licencia</button>
      </div>

      <!-- Licenses Panel -->
      <div id="licensesPanel" class="panel active">
        <div class="table-container">
          <div class="table-header">
            <h2>Licencias</h2>
            <button class="add-btn" onclick="showCreateLicenseModal()">+ Crear Licencia</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Clave</th>
                <th>Usuario</th>
                <th>Tipo</th>
                <th>Estado</th>
                <th>Expira</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="licensesTable"></tbody>
          </table>
          <div class="pagination" id="licensesPagination"></div>
        </div>
      </div>

      <!-- Users Panel -->
      <div id="usersPanel" class="panel">
        <div class="table-container">
          <div class="table-header">
            <h2>Usuarios</h2>
          </div>
          <table>
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Licencia</th>
                <th>Proyectos</th>
                <th>Registro</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="usersTable"></tbody>
          </table>
          <div class="pagination" id="usersPagination"></div>
        </div>
      </div>

      <!-- License Types Panel -->
      <div id="typesPanel" class="panel">
        <div class="table-container">
          <div class="table-header">
            <h2>Tipos de Licencia</h2>
            <button class="add-btn" onclick="showCreateTypeModal()">+ Crear Tipo</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Codigo</th>
                <th>Duracion</th>
                <th>Precio</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="typesTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Create License Modal -->
  <div id="createLicenseModal" class="modal">
    <div class="modal-content">
      <h2>Crear Nueva Licencia</h2>
      <div class="form-group">
        <label>Tipo de Licencia</label>
        <select id="licenseTypeSelect"></select>
      </div>
      <div class="form-group">
        <label>Usuario (opcional - dejar vacio para clave sin asignar)</label>
        <select id="licenseUserSelect">
          <option value="">Sin asignar</option>
        </select>
      </div>
      <div class="modal-btns">
        <button class="cancel-btn" onclick="closeModal('createLicenseModal')">Cancelar</button>
        <button class="submit-btn" onclick="createLicense()">Crear Licencia</button>
      </div>
    </div>
  </div>

  <!-- Create Type Modal -->
  <div id="createTypeModal" class="modal">
    <div class="modal-content">
      <h2>Crear Tipo de Licencia</h2>
      <div class="form-group">
        <label>Nombre</label>
        <input type="text" id="typeName" placeholder="Ej: Mensual, Por Horas">
      </div>
      <div class="form-group">
        <label>Codigo (unico)</label>
        <input type="text" id="typeCode" placeholder="Ej: monthly, hourly-2h">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Duracion en Horas (0 si usa dias)</label>
          <input type="number" id="typeHours" placeholder="0" value="0">
        </div>
        <div class="form-group">
          <label>Duracion en Dias (0 si usa horas)</label>
          <input type="number" id="typeDays" placeholder="30" value="0">
        </div>
      </div>
      <p class="info-text">Si pones horas > 0, se usaran las horas. Si horas = 0, se usaran los dias.</p>
      <div class="form-group">
        <label>Precio (EUR)</label>
        <input type="number" step="0.01" id="typePrice" placeholder="9.99">
      </div>
      <div class="form-group">
        <label>Descripcion</label>
        <input type="text" id="typeDescription" placeholder="Descripcion opcional">
      </div>
      <div class="modal-btns">
        <button class="cancel-btn" onclick="closeModal('createTypeModal')">Cancelar</button>
        <button class="submit-btn" onclick="createLicenseType()">Crear Tipo</button>
      </div>
    </div>
  </div>

  <!-- Edit Type Modal -->
  <div id="editTypeModal" class="modal">
    <div class="modal-content">
      <h2>Editar Tipo de Licencia</h2>
      <input type="hidden" id="editTypeId">
      <div class="form-group">
        <label>Nombre</label>
        <input type="text" id="editTypeName">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Duracion en Horas (0 si usa dias)</label>
          <input type="number" id="editTypeHours" value="0">
        </div>
        <div class="form-group">
          <label>Duracion en Dias (0 si usa horas)</label>
          <input type="number" id="editTypeDays">
        </div>
      </div>
      <p class="info-text">Si pones horas > 0, se usaran las horas. Si horas = 0, se usaran los dias.</p>
      <div class="form-row">
        <div class="form-group">
          <label>Precio Normal (EUR)</label>
          <input type="number" step="0.01" id="editTypePrice">
        </div>
        <div class="form-group">
          <label>Precio Promo (EUR)</label>
          <input type="number" step="0.01" id="editTypePromoPrice" placeholder="Opcional">
        </div>
      </div>
      <div class="form-group">
        <label>Promocion hasta (fecha)</label>
        <input type="date" id="editTypePromoEnds">
      </div>
      <div class="form-group">
        <label>Descripcion</label>
        <input type="text" id="editTypeDescription">
      </div>
      <div class="modal-btns">
        <button class="cancel-btn" onclick="closeModal('editTypeModal')">Cancelar</button>
        <button class="submit-btn" onclick="updateLicenseType()">Guardar Cambios</button>
      </div>
    </div>
  </div>

  <!-- User Detail Modal -->
  <div id="userDetailModal" class="modal">
    <div class="modal-content large">
      <h2>Detalles del Usuario</h2>
      <div id="userDetailContent"></div>
      <div class="modal-btns">
        <button class="cancel-btn" onclick="closeModal('userDetailModal')">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div id="resetPasswordModal" class="modal">
    <div class="modal-content">
      <h2>Cambiar Contrasena</h2>
      <input type="hidden" id="resetPasswordUserId">
      <p style="margin-bottom:16px;color:#94a3b8;">Usuario: <span id="resetPasswordEmail" style="color:#00d4ff;"></span></p>
      <div class="form-group">
        <label>Nueva Contrasena</label>
        <input type="text" id="newPassword" placeholder="Minimo 6 caracteres">
      </div>
      <p class="info-text">Las contrasenas estan hasheadas y no se pueden ver. Solo puedes cambiarlas.</p>
      <div class="modal-btns">
        <button class="cancel-btn" onclick="closeModal('resetPasswordModal')">Cancelar</button>
        <button class="submit-btn" onclick="resetPassword()">Cambiar Contrasena</button>
      </div>
    </div>
  </div>

  <!-- Delete User Confirm Modal -->
  <div id="deleteUserModal" class="modal">
    <div class="modal-content">
      <h2>Eliminar Usuario</h2>
      <input type="hidden" id="deleteUserId">
      <p style="color:#ef4444;margin-bottom:16px;">Esta accion eliminara permanentemente al usuario y todos sus datos:</p>
      <ul style="color:#94a3b8;margin-left:20px;margin-bottom:16px;">
        <li>Proyectos y fotos</li>
        <li>Licencias</li>
        <li>Pagos registrados</li>
      </ul>
      <p style="margin-bottom:16px;">Usuario: <span id="deleteUserEmail" style="color:#00d4ff;"></span></p>
      <div class="modal-btns">
        <button class="cancel-btn" onclick="closeModal('deleteUserModal')">Cancelar</button>
        <button class="submit-btn danger" onclick="deleteUser()">Eliminar Usuario</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin + '/api';
    let token = localStorage.getItem('adminToken');
    let currentLicensePage = 1;
    let currentUserPage = 1;

    // Check auth on load
    if (token) {
      showDashboard();
    }

    async function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      errorEl.style.display = 'none';

      try {
        const res = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error?.message || 'Error en login');
        }

        if (!data.token) {
          throw new Error('No se recibio token del servidor');
        }

        // Verify admin
        const userRes = await fetch(`${API_URL}/licenses/admin/stats`, {
          headers: { 'Authorization': `Bearer ${data.token}` }
        });

        if (!userRes.ok) {
          const errData = await userRes.json().catch(() => ({}));
          throw new Error(errData.error?.message || 'No tienes permisos de administrador');
        }

        localStorage.setItem('adminToken', data.token);
        token = data.token;
        showDashboard();
      } catch (err) {
        errorEl.textContent = err.message || 'Error desconocido';
        errorEl.style.display = 'block';
      }
    }

    function logout() {
      localStorage.removeItem('adminToken');
      token = null;
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('loginContainer').style.display = 'flex';
    }

    async function showDashboard() {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      await loadStats();
      await loadLicenses();
      await loadLicenseTypes();
    }

    async function apiCall(endpoint, options = {}) {
      const res = await fetch(`${API_URL}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        }
      });
      if (res.status === 401 || res.status === 403) {
        logout();
        throw new Error('Session expired');
      }
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error?.message || 'Error en la peticion');
      }
      return data;
    }

    async function loadStats() {
      try {
        const stats = await apiCall('/licenses/admin/stats');
        document.getElementById('statUsers').textContent = stats.totalUsers;
        document.getElementById('statActive').textContent = stats.activeLicenses;
        document.getElementById('statExpired').textContent = stats.expiredLicenses;
        document.getElementById('statRevenue').textContent = (Number(stats.totalRevenue) || 0).toFixed(2) + ' EUR';
      } catch (err) {
        console.error('Error loading stats:', err);
      }
    }

    async function loadLicenses(page = 1) {
      currentLicensePage = page;
      try {
        const data = await apiCall(`/licenses/admin/all?page=${page}&limit=10`);
        const tbody = document.getElementById('licensesTable');
        tbody.innerHTML = data.licenses.map(l => `
          <tr>
            <td>
              <span class="license-key">${l.licenseKey}</span>
              <button class="copy-btn" onclick="copyToClipboard('${l.licenseKey}')">Copy</button>
            </td>
            <td>${l.user?.email || '<em>Sin asignar</em>'}</td>
            <td>${l.licenseType.name}</td>
            <td><span class="badge ${l.status}">${l.status}</span></td>
            <td>${formatDateTime(l.expiresAt)}</td>
            <td>
              ${l.status === 'active' ? `<button class="action-btn danger" onclick="revokeLicense('${l.id}')">Revocar</button>` : ''}
            </td>
          </tr>
        `).join('');

        renderPagination('licensesPagination', page, Math.ceil(data.total / 10), loadLicenses);
      } catch (err) {
        console.error('Error loading licenses:', err);
      }
    }

    async function loadUsers(page = 1) {
      currentUserPage = page;
      try {
        const data = await apiCall(`/licenses/admin/users?page=${page}&limit=10`);
        const tbody = document.getElementById('usersTable');
        tbody.innerHTML = data.users.map(u => `
          <tr>
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.isAdmin ? '<span class="badge admin">Admin</span>' : '<span class="badge">Usuario</span>'}</td>
            <td>
              ${u.licenses && u.licenses.length > 0
                ? `<span class="badge active">${u.licenses[0].licenseType.name}</span>`
                : '<span class="badge expired">Sin licencia</span>'}
            </td>
            <td>${u._count?.projects || 0}</td>
            <td>${new Date(u.createdAt).toLocaleDateString()}</td>
            <td>
              <button class="action-btn primary" onclick="viewUserDetail('${u.id}')">Ver</button>
              <button class="action-btn" onclick="showResetPasswordModal('${u.id}', '${u.email}')">Password</button>
              <button class="action-btn danger" onclick="showDeleteUserModal('${u.id}', '${u.email}')">Eliminar</button>
            </td>
          </tr>
        `).join('');

        // Update user select for license creation
        const select = document.getElementById('licenseUserSelect');
        select.innerHTML = '<option value="">Sin asignar</option>' +
          data.users.map(u => `<option value="${u.id}">${u.email}</option>`).join('');

        renderPagination('usersPagination', page, Math.ceil(data.total / 10), loadUsers);
      } catch (err) {
        console.error('Error loading users:', err);
      }
    }

    async function loadLicenseTypes() {
      try {
        const types = await apiCall('/licenses/types');
        const tbody = document.getElementById('typesTable');
        tbody.innerHTML = types.map(t => {
          const hasPromo = t.promoPrice && t.promoEndsAt && new Date(t.promoEndsAt) > new Date();
          const promoText = hasPromo ? `<br><span style="color:#10b981;font-size:12px;">Promo: ${t.promoPrice} EUR (hasta ${new Date(t.promoEndsAt).toLocaleDateString()})</span>` : '';

          // Show duration correctly
          let durationText = '';
          if (t.durationHours && t.durationHours > 0) {
            durationText = `${t.durationHours} horas`;
          } else {
            durationText = `${t.durationDays || 0} dias`;
          }

          return `
          <tr>
            <td>${t.name}</td>
            <td><code>${t.code}</code></td>
            <td>${durationText}</td>
            <td>${t.price} EUR${promoText}</td>
            <td><span class="badge ${t.isActive ? 'active' : 'expired'}">${t.isActive ? 'Activo' : 'Inactivo'}</span></td>
            <td>
              <button class="action-btn" onclick='editLicenseType(${JSON.stringify(t).replace(/'/g, "\\'")})'>Editar</button>
              <button class="action-btn" onclick="toggleLicenseType('${t.id}', ${!t.isActive})">
                ${t.isActive ? 'Desactivar' : 'Activar'}
              </button>
            </td>
          </tr>
        `}).join('');

        // Update type select for license creation
        const select = document.getElementById('licenseTypeSelect');
        select.innerHTML = types.filter(t => t.isActive).map(t => {
          const hasPromo = t.promoPrice && t.promoEndsAt && new Date(t.promoEndsAt) > new Date();
          const displayPrice = hasPromo ? t.promoPrice : t.price;
          let durationText = t.durationHours > 0 ? `${t.durationHours}h` : `${t.durationDays}d`;
          return `<option value="${t.id}">${t.name} (${durationText}) - ${displayPrice} EUR${hasPromo ? ' PROMO' : ''}</option>`;
        }).join('');
      } catch (err) {
        console.error('Error loading license types:', err);
      }
    }

    function editLicenseType(type) {
      document.getElementById('editTypeId').value = type.id;
      document.getElementById('editTypeName').value = type.name;
      document.getElementById('editTypeHours').value = type.durationHours || 0;
      document.getElementById('editTypeDays').value = type.durationDays || 0;
      document.getElementById('editTypePrice').value = type.price;
      document.getElementById('editTypePromoPrice').value = type.promoPrice || '';
      document.getElementById('editTypePromoEnds').value = type.promoEndsAt ? type.promoEndsAt.split('T')[0] : '';
      document.getElementById('editTypeDescription').value = type.description || '';
      document.getElementById('editTypeModal').classList.add('show');
    }

    async function updateLicenseType() {
      const id = document.getElementById('editTypeId').value;
      const promoPrice = document.getElementById('editTypePromoPrice').value;
      const promoEnds = document.getElementById('editTypePromoEnds').value;

      const data = {
        name: document.getElementById('editTypeName').value,
        durationHours: parseInt(document.getElementById('editTypeHours').value) || 0,
        durationDays: parseInt(document.getElementById('editTypeDays').value) || 0,
        price: parseFloat(document.getElementById('editTypePrice').value),
        promoPrice: promoPrice ? parseFloat(promoPrice) : null,
        promoEndsAt: promoEnds ? new Date(promoEnds).toISOString() : null,
        description: document.getElementById('editTypeDescription').value
      };

      try {
        await apiCall(`/licenses/admin/types/${id}`, {
          method: 'PUT',
          body: JSON.stringify(data)
        });
        closeModal('editTypeModal');
        loadLicenseTypes();
        alert('Tipo de licencia actualizado correctamente');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function viewUserDetail(userId) {
      try {
        const data = await apiCall(`/licenses/admin/user/${userId}`);
        const u = data.user;

        let projectsHtml = '';
        if (u.projects && u.projects.length > 0) {
          projectsHtml = u.projects.map(p => `
            <div class="project-card">
              <h4>${p.name}</h4>
              <p>${p.description || 'Sin descripcion'}</p>
              <p>Fotos: ${p._count?.photos || 0} | Creado: ${new Date(p.createdAt).toLocaleDateString()}</p>
            </div>
          `).join('');
        } else {
          projectsHtml = '<p style="color:#94a3b8;">No tiene proyectos</p>';
        }

        let licensesHtml = '';
        if (u.licenses && u.licenses.length > 0) {
          licensesHtml = u.licenses.map(l => `
            <div class="detail-row">
              <span class="detail-label">${l.licenseType.name}</span>
              <span class="detail-value">
                <span class="badge ${l.status}">${l.status}</span>
                Expira: ${formatDateTime(l.expiresAt)}
              </span>
            </div>
          `).join('');
        } else {
          licensesHtml = '<p style="color:#94a3b8;">No tiene licencias</p>';
        }

        document.getElementById('userDetailContent').innerHTML = `
          <div class="user-detail-section">
            <h3>Informacion Basica</h3>
            <div class="detail-row">
              <span class="detail-label">ID</span>
              <span class="detail-value" style="font-family:monospace;font-size:12px;">${u.id}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Nombre</span>
              <span class="detail-value">${u.name}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Email</span>
              <span class="detail-value">${u.email}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Rol</span>
              <span class="detail-value">${u.isAdmin ? '<span class="badge admin">Administrador</span>' : 'Usuario'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Registrado</span>
              <span class="detail-value">${formatDateTime(u.createdAt)}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Contrasena</span>
              <span class="detail-value" style="color:#94a3b8;">(Hasheada - no visible)</span>
            </div>
          </div>

          <div class="user-detail-section">
            <h3>Licencias (${u.licenses?.length || 0})</h3>
            ${licensesHtml}
          </div>

          <div class="user-detail-section">
            <h3>Proyectos (${u.projects?.length || 0})</h3>
            ${projectsHtml}
          </div>

          <div style="margin-top:16px;">
            <button class="action-btn" onclick="showResetPasswordModal('${u.id}', '${u.email}')">Cambiar Contrasena</button>
            <button class="action-btn ${u.isAdmin ? 'danger' : 'primary'}" onclick="toggleAdmin('${u.id}', ${!u.isAdmin})">
              ${u.isAdmin ? 'Quitar Admin' : 'Hacer Admin'}
            </button>
          </div>
        `;

        document.getElementById('userDetailModal').classList.add('show');
      } catch (err) {
        alert('Error cargando usuario: ' + err.message);
      }
    }

    function showResetPasswordModal(userId, email) {
      document.getElementById('resetPasswordUserId').value = userId;
      document.getElementById('resetPasswordEmail').textContent = email;
      document.getElementById('newPassword').value = '';
      document.getElementById('resetPasswordModal').classList.add('show');
    }

    async function resetPassword() {
      const userId = document.getElementById('resetPasswordUserId').value;
      const newPassword = document.getElementById('newPassword').value;

      if (newPassword.length < 6) {
        alert('La contrasena debe tener al menos 6 caracteres');
        return;
      }

      try {
        await apiCall(`/licenses/admin/user/${userId}/password`, {
          method: 'PUT',
          body: JSON.stringify({ password: newPassword })
        });
        closeModal('resetPasswordModal');
        alert('Contrasena actualizada correctamente');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function showDeleteUserModal(userId, email) {
      document.getElementById('deleteUserId').value = userId;
      document.getElementById('deleteUserEmail').textContent = email;
      document.getElementById('deleteUserModal').classList.add('show');
    }

    async function deleteUser() {
      const userId = document.getElementById('deleteUserId').value;

      try {
        await apiCall(`/licenses/admin/user/${userId}`, {
          method: 'DELETE'
        });
        closeModal('deleteUserModal');
        closeModal('userDetailModal');
        loadUsers();
        loadStats();
        alert('Usuario eliminado correctamente');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function toggleAdmin(userId, makeAdmin) {
      try {
        await apiCall(`/licenses/admin/user/${userId}/admin`, {
          method: 'PUT',
          body: JSON.stringify({ isAdmin: makeAdmin })
        });
        closeModal('userDetailModal');
        loadUsers();
        alert(makeAdmin ? 'Usuario ahora es administrador' : 'Permisos de admin removidos');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function formatDateTime(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function renderPagination(containerId, current, total, callback) {
      const container = document.getElementById(containerId);
      if (total <= 1) { container.innerHTML = ''; return; }

      let html = '';
      for (let i = 1; i <= total; i++) {
        html += `<button class="page-btn ${i === current ? 'active' : ''}" onclick="${callback.name}(${i})">${i}</button>`;
      }
      container.innerHTML = html;
    }

    function showPanel(panel) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(panel + 'Panel').classList.add('active');
      event.target.classList.add('active');

      if (panel === 'users') loadUsers();
      if (panel === 'licenses') loadLicenses();
      if (panel === 'types') loadLicenseTypes();
    }

    function showCreateLicenseModal() {
      loadUsers();
      document.getElementById('createLicenseModal').classList.add('show');
    }

    function showCreateTypeModal() {
      document.getElementById('typeName').value = '';
      document.getElementById('typeCode').value = '';
      document.getElementById('typeHours').value = '0';
      document.getElementById('typeDays').value = '0';
      document.getElementById('typePrice').value = '';
      document.getElementById('typeDescription').value = '';
      document.getElementById('createTypeModal').classList.add('show');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }

    async function createLicense() {
      const typeId = document.getElementById('licenseTypeSelect').value;
      const userId = document.getElementById('licenseUserSelect').value;

      try {
        await apiCall('/licenses/admin/create', {
          method: 'POST',
          body: JSON.stringify({ licenseTypeId: typeId, userId: userId || undefined })
        });
        closeModal('createLicenseModal');
        loadLicenses();
        loadStats();
        alert('Licencia creada correctamente');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function createLicenseType() {
      const data = {
        name: document.getElementById('typeName').value,
        code: document.getElementById('typeCode').value,
        durationHours: parseInt(document.getElementById('typeHours').value) || 0,
        durationDays: parseInt(document.getElementById('typeDays').value) || 0,
        price: parseFloat(document.getElementById('typePrice').value),
        description: document.getElementById('typeDescription').value
      };

      try {
        await apiCall('/licenses/admin/types', {
          method: 'POST',
          body: JSON.stringify(data)
        });
        closeModal('createTypeModal');
        loadLicenseTypes();
        alert('Tipo de licencia creado correctamente');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function revokeLicense(id) {
      if (!confirm('Seguro que quieres revocar esta licencia?')) return;
      try {
        await apiCall(`/licenses/admin/revoke/${id}`, { method: 'POST' });
        loadLicenses();
        loadStats();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function toggleLicenseType(id, isActive) {
      try {
        await apiCall(`/licenses/admin/types/${id}`, {
          method: 'PUT',
          body: JSON.stringify({ isActive })
        });
        loadLicenseTypes();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text);
      alert('Clave copiada al portapapeles');
    }
  </script>
</body>
</html>
