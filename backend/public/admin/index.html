<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GeoTech Admin - Panel de Licencias</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
      color: #e2e8f0;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    header {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(100, 116, 139, 0.3);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { font-size: 24px; font-weight: 700; color: #00d4ff; }
    .logout-btn {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #ef4444;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .logout-btn:hover { background: rgba(239, 68, 68, 0.3); }

    /* Login */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .login-card {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
    }
    .login-card h1 { text-align: center; margin-bottom: 32px; color: #00d4ff; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px; }
    .form-group input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 16px;
    }
    .form-group input:focus { outline: none; border-color: #00d4ff; }
    .login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    .login-btn:hover { opacity: 0.9; }
    .error-msg { color: #ef4444; margin-top: 16px; text-align: center; }

    /* Dashboard */
    .dashboard { display: none; }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
    }
    .stat-card h3 { font-size: 14px; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; }
    .stat-card .value { font-size: 36px; font-weight: 700; color: #00d4ff; }
    .stat-card.green .value { color: #10b981; }
    .stat-card.orange .value { color: #f59e0b; }
    .stat-card.purple .value { color: #8b5cf6; }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid rgba(100, 116, 139, 0.3);
      padding-bottom: 16px;
    }
    .tab-btn {
      background: transparent;
      border: 1px solid rgba(100, 116, 139, 0.3);
      color: #94a3b8;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    .tab-btn.active { background: #00d4ff; color: #0f172a; border-color: #00d4ff; }
    .tab-btn:hover:not(.active) { border-color: #00d4ff; color: #00d4ff; }

    /* Tables */
    .panel { display: none; }
    .panel.active { display: block; }
    .table-container {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 12px;
      overflow: hidden;
    }
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(100, 116, 139, 0.3);
    }
    .table-header h2 { font-size: 18px; }
    .add-btn {
      background: #10b981;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .add-btn:hover { opacity: 0.9; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 14px 20px; text-align: left; border-bottom: 1px solid rgba(100, 116, 139, 0.2); }
    th { color: #94a3b8; font-size: 12px; text-transform: uppercase; font-weight: 600; }
    td { font-size: 14px; }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge.active { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .badge.pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .badge.expired { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .badge.revoked { background: rgba(100, 116, 139, 0.2); color: #64748b; }
    .action-btn {
      background: rgba(100, 116, 139, 0.2);
      border: none;
      color: #94a3b8;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 8px;
    }
    .action-btn:hover { background: rgba(100, 116, 139, 0.4); }
    .action-btn.danger { color: #ef4444; }
    .action-btn.danger:hover { background: rgba(239, 68, 68, 0.2); }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: #1e293b;
      border: 1px solid rgba(100, 116, 139, 0.3);
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 500px;
    }
    .modal-content h2 { margin-bottom: 24px; }
    .modal-btns { display: flex; gap: 12px; margin-top: 24px; }
    .modal-btns button { flex: 1; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .cancel-btn { background: transparent; border: 1px solid rgba(100, 116, 139, 0.3); color: #94a3b8; }
    .submit-btn { background: #00d4ff; border: none; color: #0f172a; }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 20px;
    }
    .page-btn {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(100, 116, 139, 0.3);
      color: #94a3b8;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }
    .page-btn.active { background: #00d4ff; color: #0f172a; border-color: #00d4ff; }

    .copy-btn {
      background: transparent;
      border: none;
      color: #00d4ff;
      cursor: pointer;
      padding: 4px;
    }
    .license-key { font-family: monospace; font-size: 12px; }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginContainer" class="login-container">
    <div class="login-card">
      <h1>GeoTech Admin</h1>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="admin@geotech.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="********">
      </div>
      <button class="login-btn" onclick="login()">Iniciar Sesion</button>
      <p id="loginError" class="error-msg" style="display:none"></p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="dashboard">
    <header>
      <div class="logo">GeoTech Admin</div>
      <button class="logout-btn" onclick="logout()">Cerrar Sesion</button>
    </header>

    <div class="container">
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Usuarios</h3>
          <div class="value" id="statUsers">0</div>
        </div>
        <div class="stat-card green">
          <h3>Licencias Activas</h3>
          <div class="value" id="statActive">0</div>
        </div>
        <div class="stat-card orange">
          <h3>Licencias Expiradas</h3>
          <div class="value" id="statExpired">0</div>
        </div>
        <div class="stat-card purple">
          <h3>Ingresos Totales</h3>
          <div class="value" id="statRevenue">0</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" onclick="showPanel('licenses')">Licencias</button>
        <button class="tab-btn" onclick="showPanel('users')">Usuarios</button>
        <button class="tab-btn" onclick="showPanel('types')">Tipos de Licencia</button>
      </div>

      <!-- Licenses Panel -->
      <div id="licensesPanel" class="panel active">
        <div class="table-container">
          <div class="table-header">
            <h2>Licencias</h2>
            <button class="add-btn" onclick="showCreateLicenseModal()">+ Crear Licencia</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Clave</th>
                <th>Usuario</th>
                <th>Tipo</th>
                <th>Estado</th>
                <th>Expira</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="licensesTable"></tbody>
          </table>
          <div class="pagination" id="licensesPagination"></div>
        </div>
      </div>

      <!-- Users Panel -->
      <div id="usersPanel" class="panel">
        <div class="table-container">
          <div class="table-header">
            <h2>Usuarios</h2>
          </div>
          <table>
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Email</th>
                <th>Licencia</th>
                <th>Proyectos</th>
                <th>Registro</th>
              </tr>
            </thead>
            <tbody id="usersTable"></tbody>
          </table>
          <div class="pagination" id="usersPagination"></div>
        </div>
      </div>

      <!-- License Types Panel -->
      <div id="typesPanel" class="panel">
        <div class="table-container">
          <div class="table-header">
            <h2>Tipos de Licencia</h2>
            <button class="add-btn" onclick="showCreateTypeModal()">+ Crear Tipo</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Codigo</th>
                <th>Duracion</th>
                <th>Precio</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="typesTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Create License Modal -->
  <div id="createLicenseModal" class="modal">
    <div class="modal-content">
      <h2>Crear Nueva Licencia</h2>
      <div class="form-group">
        <label>Tipo de Licencia</label>
        <select id="licenseTypeSelect" style="width:100%;padding:12px;background:#0f172a;border:1px solid rgba(100,116,139,0.3);border-radius:8px;color:#e2e8f0;">
        </select>
      </div>
      <div class="form-group">
        <label>Usuario (opcional - dejar vacio para clave sin asignar)</label>
        <select id="licenseUserSelect" style="width:100%;padding:12px;background:#0f172a;border:1px solid rgba(100,116,139,0.3);border-radius:8px;color:#e2e8f0;">
          <option value="">Sin asignar</option>
        </select>
      </div>
      <div class="modal-btns">
        <button class="cancel-btn" onclick="closeModal('createLicenseModal')">Cancelar</button>
        <button class="submit-btn" onclick="createLicense()">Crear Licencia</button>
      </div>
    </div>
  </div>

  <!-- Create Type Modal -->
  <div id="createTypeModal" class="modal">
    <div class="modal-content">
      <h2>Crear Tipo de Licencia</h2>
      <div class="form-group">
        <label>Nombre</label>
        <input type="text" id="typeName" placeholder="Ej: Mensual">
      </div>
      <div class="form-group">
        <label>Codigo</label>
        <input type="text" id="typeCode" placeholder="Ej: monthly">
      </div>
      <div class="form-group">
        <label>Duracion (dias)</label>
        <input type="number" id="typeDuration" placeholder="30">
      </div>
      <div class="form-group">
        <label>Precio (EUR)</label>
        <input type="number" step="0.01" id="typePrice" placeholder="9.99">
      </div>
      <div class="form-group">
        <label>Descripcion</label>
        <input type="text" id="typeDescription" placeholder="Descripcion opcional">
      </div>
      <div class="modal-btns">
        <button class="cancel-btn" onclick="closeModal('createTypeModal')">Cancelar</button>
        <button class="submit-btn" onclick="createLicenseType()">Crear Tipo</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin + '/api';
    let token = localStorage.getItem('adminToken');
    let currentLicensePage = 1;
    let currentUserPage = 1;

    // Check auth on load
    if (token) {
      showDashboard();
    }

    async function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      try {
        const res = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.error?.message || 'Error');

        // Verify admin
        const userRes = await fetch(`${API_URL}/licenses/admin/stats`, {
          headers: { 'Authorization': `Bearer ${data.accessToken}` }
        });

        if (!userRes.ok) {
          throw new Error('No tienes permisos de administrador');
        }

        localStorage.setItem('adminToken', data.accessToken);
        token = data.accessToken;
        showDashboard();
      } catch (err) {
        document.getElementById('loginError').textContent = err.message;
        document.getElementById('loginError').style.display = 'block';
      }
    }

    function logout() {
      localStorage.removeItem('adminToken');
      token = null;
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('loginContainer').style.display = 'flex';
    }

    async function showDashboard() {
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      await loadStats();
      await loadLicenses();
      await loadLicenseTypes();
    }

    async function apiCall(endpoint, options = {}) {
      const res = await fetch(`${API_URL}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        }
      });
      if (res.status === 401 || res.status === 403) {
        logout();
        throw new Error('Session expired');
      }
      return res.json();
    }

    async function loadStats() {
      try {
        const stats = await apiCall('/licenses/admin/stats');
        document.getElementById('statUsers').textContent = stats.totalUsers;
        document.getElementById('statActive').textContent = stats.activeLicenses;
        document.getElementById('statExpired').textContent = stats.expiredLicenses;
        document.getElementById('statRevenue').textContent = stats.totalRevenue.toFixed(2) + ' EUR';
      } catch (err) {
        console.error('Error loading stats:', err);
      }
    }

    async function loadLicenses(page = 1) {
      currentLicensePage = page;
      try {
        const data = await apiCall(`/licenses/admin/all?page=${page}&limit=10`);
        const tbody = document.getElementById('licensesTable');
        tbody.innerHTML = data.licenses.map(l => `
          <tr>
            <td>
              <span class="license-key">${l.licenseKey}</span>
              <button class="copy-btn" onclick="copyToClipboard('${l.licenseKey}')">Copy</button>
            </td>
            <td>${l.user?.email || '<em>Sin asignar</em>'}</td>
            <td>${l.licenseType.name}</td>
            <td><span class="badge ${l.status}">${l.status}</span></td>
            <td>${new Date(l.expiresAt).toLocaleDateString()}</td>
            <td>
              ${l.status === 'active' ? `<button class="action-btn danger" onclick="revokeLicense('${l.id}')">Revocar</button>` : ''}
            </td>
          </tr>
        `).join('');

        renderPagination('licensesPagination', page, Math.ceil(data.total / 10), loadLicenses);
      } catch (err) {
        console.error('Error loading licenses:', err);
      }
    }

    async function loadUsers(page = 1) {
      currentUserPage = page;
      try {
        const data = await apiCall(`/licenses/admin/users?page=${page}&limit=10`);
        const tbody = document.getElementById('usersTable');
        tbody.innerHTML = data.users.map(u => `
          <tr>
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>
              ${u.licenses.length > 0
                ? `<span class="badge active">${u.licenses[0].licenseType.name}</span>`
                : '<span class="badge expired">Sin licencia</span>'}
            </td>
            <td>${u._count.projects}</td>
            <td>${new Date(u.createdAt).toLocaleDateString()}</td>
          </tr>
        `).join('');

        // Update user select for license creation
        const select = document.getElementById('licenseUserSelect');
        select.innerHTML = '<option value="">Sin asignar</option>' +
          data.users.map(u => `<option value="${u.id}">${u.email}</option>`).join('');

        renderPagination('usersPagination', page, Math.ceil(data.total / 10), loadUsers);
      } catch (err) {
        console.error('Error loading users:', err);
      }
    }

    async function loadLicenseTypes() {
      try {
        const types = await apiCall('/licenses/types');
        const tbody = document.getElementById('typesTable');
        tbody.innerHTML = types.map(t => `
          <tr>
            <td>${t.name}</td>
            <td><code>${t.code}</code></td>
            <td>${t.durationDays} dias</td>
            <td>${t.price} EUR</td>
            <td><span class="badge ${t.isActive ? 'active' : 'expired'}">${t.isActive ? 'Activo' : 'Inactivo'}</span></td>
            <td>
              <button class="action-btn" onclick="toggleLicenseType('${t.id}', ${!t.isActive})">
                ${t.isActive ? 'Desactivar' : 'Activar'}
              </button>
            </td>
          </tr>
        `).join('');

        // Update type select for license creation
        const select = document.getElementById('licenseTypeSelect');
        select.innerHTML = types.filter(t => t.isActive).map(t =>
          `<option value="${t.id}">${t.name} - ${t.price} EUR</option>`
        ).join('');
      } catch (err) {
        console.error('Error loading license types:', err);
      }
    }

    function renderPagination(containerId, current, total, callback) {
      const container = document.getElementById(containerId);
      if (total <= 1) { container.innerHTML = ''; return; }

      let html = '';
      for (let i = 1; i <= total; i++) {
        html += `<button class="page-btn ${i === current ? 'active' : ''}" onclick="${callback.name}(${i})">${i}</button>`;
      }
      container.innerHTML = html;
    }

    function showPanel(panel) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(panel + 'Panel').classList.add('active');
      event.target.classList.add('active');

      if (panel === 'users') loadUsers();
      if (panel === 'licenses') loadLicenses();
      if (panel === 'types') loadLicenseTypes();
    }

    function showCreateLicenseModal() {
      loadUsers(); // Refresh user list
      document.getElementById('createLicenseModal').classList.add('show');
    }

    function showCreateTypeModal() {
      document.getElementById('createTypeModal').classList.add('show');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }

    async function createLicense() {
      const typeId = document.getElementById('licenseTypeSelect').value;
      const userId = document.getElementById('licenseUserSelect').value;

      try {
        await apiCall('/licenses/admin/create', {
          method: 'POST',
          body: JSON.stringify({ licenseTypeId: typeId, userId: userId || undefined })
        });
        closeModal('createLicenseModal');
        loadLicenses();
        loadStats();
        alert('Licencia creada correctamente');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function createLicenseType() {
      const data = {
        name: document.getElementById('typeName').value,
        code: document.getElementById('typeCode').value,
        durationDays: parseInt(document.getElementById('typeDuration').value),
        price: parseFloat(document.getElementById('typePrice').value),
        description: document.getElementById('typeDescription').value
      };

      try {
        await apiCall('/licenses/admin/types', {
          method: 'POST',
          body: JSON.stringify(data)
        });
        closeModal('createTypeModal');
        loadLicenseTypes();
        alert('Tipo de licencia creado correctamente');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function revokeLicense(id) {
      if (!confirm('Seguro que quieres revocar esta licencia?')) return;
      try {
        await apiCall(`/licenses/admin/revoke/${id}`, { method: 'POST' });
        loadLicenses();
        loadStats();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function toggleLicenseType(id, isActive) {
      try {
        await apiCall(`/licenses/admin/types/${id}`, {
          method: 'PUT',
          body: JSON.stringify({ isActive })
        });
        loadLicenseTypes();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text);
      alert('Clave copiada al portapapeles');
    }
  </script>
</body>
</html>
