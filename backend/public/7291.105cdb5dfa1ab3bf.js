"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7291],{7291:(b,f,g)=>{g.d(f,{n:()=>v});var c=g(467),i=g(8254),p=g(2615);const l="photos",u="projects";let v=(()=>{var _;class y{constructor(){this.SYNC_QUEUE_KEY="geotech_sync_queue",this.MEASUREMENTS_KEY="geotech_measurements",this.db=null,this.dbReady=null,this.dbReady=this.initIndexedDB()}initIndexedDB(){var e=this;return(0,c.A)(function*(){return e.db?e.db:new Promise((t,r)=>{const o=indexedDB.open("geotech_db",2);o.onerror=()=>{console.error("Error opening IndexedDB:",o.error),r(o.error)},o.onsuccess=()=>{e.db=o.result,t(e.db)},o.onupgradeneeded=n=>{const a=n.target.result;a.objectStoreNames.contains(l)||a.createObjectStore(l,{keyPath:"id"}).createIndex("projectId","projectId",{unique:!1}),a.objectStoreNames.contains(u)||a.createObjectStore(u,{keyPath:"id"})}})})()}getDB(){var e=this;return(0,c.A)(function*(){return e.db?e.db:e.dbReady?e.dbReady:e.initIndexedDB()})()}getProjects(){var e=this;return(0,c.A)(function*(){try{const t=yield e.getDB();return new Promise((r,o)=>{const d=t.transaction([u],"readonly").objectStore(u).getAll();d.onsuccess=()=>r(d.result||[]),d.onerror=()=>o(d.error)})}catch(t){return console.error("Error getting projects from IndexedDB:",t),e.getProjectsFromPreferences()}})()}getProjectsFromPreferences(){return(0,c.A)(function*(){const{value:e}=yield i.p.get({key:"geotech_projects"});return e?JSON.parse(e):[]})()}setProjects(e){var t=this;return(0,c.A)(function*(){try{const n=(yield t.getDB()).transaction([u],"readwrite").objectStore(u);n.clear();for(const a of e)n.put(a)}catch(r){console.error("Error setting projects:",r)}})()}saveProject(e){var t=this;return(0,c.A)(function*(){try{const r=yield t.getDB();return new Promise((o,n)=>{const s=r.transaction([u],"readwrite").objectStore(u).put(e);s.onsuccess=()=>o(),s.onerror=()=>n(s.error)})}catch(r){throw console.error("Error saving project:",r),r}})()}deleteProject(e){var t=this;return(0,c.A)(function*(){try{const r=yield t.getDB();yield new Promise((n,a)=>{const h=r.transaction([u],"readwrite").objectStore(u).delete(e);h.onsuccess=()=>n(),h.onerror=()=>a(h.error)});const o=yield t.getPhotos(e);for(const n of o)yield t.deletePhoto(n.id)}catch(r){console.error("Error deleting project:",r)}})()}getProject(e){var t=this;return(0,c.A)(function*(){try{const r=yield t.getDB();return new Promise((o,n)=>{const s=r.transaction([u],"readonly").objectStore(u).get(e);s.onsuccess=()=>o(s.result),s.onerror=()=>n(s.error)})}catch(r){return void console.error("Error getting project:",r)}})()}getPhotos(e){var t=this;return(0,c.A)(function*(){try{const r=yield t.getDB();return new Promise((o,n)=>{const d=r.transaction([l],"readonly").objectStore(l);if(e){const h=d.index("projectId").getAll(e);h.onsuccess=()=>o(h.result||[]),h.onerror=()=>n(h.error)}else{const s=d.getAll();s.onsuccess=()=>o(s.result||[]),s.onerror=()=>n(s.error)}})}catch(r){return console.error("Error getting photos:",r),[]}})()}savePhoto(e){var t=this;return(0,c.A)(function*(){try{const r=yield t.getDB();return new Promise((o,n)=>{const s=r.transaction([l],"readwrite").objectStore(l).put(e);s.onsuccess=()=>o(),s.onerror=()=>{console.error("Error saving photo:",s.error),n(s.error)}})}catch(r){throw console.error("Error saving photo to IndexedDB:",r),r}})()}addPhoto(e){var t=this;return(0,c.A)(function*(){yield t.savePhoto(e)})()}updatePhoto(e){var t=this;return(0,c.A)(function*(){yield t.savePhoto(e)})()}deletePhoto(e){var t=this;return(0,c.A)(function*(){try{const r=yield t.getDB();return new Promise((o,n)=>{const s=r.transaction([l],"readwrite").objectStore(l).delete(e);s.onsuccess=()=>o(),s.onerror=()=>n(s.error)})}catch(r){console.error("Error deleting photo:",r)}})()}getPhoto(e){var t=this;return(0,c.A)(function*(){try{const r=yield t.getDB();return new Promise((o,n)=>{const s=r.transaction([l],"readonly").objectStore(l).get(e);s.onsuccess=()=>o(s.result),s.onerror=()=>n(s.error)})}catch(r){return void console.error("Error getting photo:",r)}})()}getSyncQueue(){var e=this;return(0,c.A)(function*(){const{value:t}=yield i.p.get({key:e.SYNC_QUEUE_KEY});return t?JSON.parse(t):[]})()}addToSyncQueue(e){var t=this;return(0,c.A)(function*(){const r=yield t.getSyncQueue();r.push(e),yield i.p.set({key:t.SYNC_QUEUE_KEY,value:JSON.stringify(r)})})()}updateSyncQueueItem(e){var t=this;return(0,c.A)(function*(){const r=yield t.getSyncQueue(),o=r.findIndex(n=>n.id===e.id);o>=0&&(r[o]=e,yield i.p.set({key:t.SYNC_QUEUE_KEY,value:JSON.stringify(r)}))})()}removeFromSyncQueue(e){var t=this;return(0,c.A)(function*(){const o=(yield t.getSyncQueue()).filter(n=>n.id!==e);yield i.p.set({key:t.SYNC_QUEUE_KEY,value:JSON.stringify(o)})})()}clearSyncQueue(){var e=this;return(0,c.A)(function*(){yield i.p.set({key:e.SYNC_QUEUE_KEY,value:JSON.stringify([])})})()}getPendingSyncCount(){var e=this;return(0,c.A)(function*(){return(yield e.getSyncQueue()).filter(r=>"pending"===r.status).length})()}generateId(){return"local_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}clearAll(){var e=this;return(0,c.A)(function*(){yield i.p.clear();try{const r=(yield e.getDB()).transaction([l,u],"readwrite");r.objectStore(l).clear(),r.objectStore(u).clear()}catch(t){console.error("Error clearing IndexedDB:",t)}})()}clear(){var e=this;return(0,c.A)(function*(){yield e.clearAll()})()}getMeasurements(){var e=this;return(0,c.A)(function*(){const{value:t}=yield i.p.get({key:e.MEASUREMENTS_KEY});return t?JSON.parse(t):[]})()}saveMeasurement(e){var t=this;return(0,c.A)(function*(){const r=yield t.getMeasurements(),o=r.findIndex(n=>n.id===e.id);o>=0?r[o]=e:r.unshift(e),yield i.p.set({key:t.MEASUREMENTS_KEY,value:JSON.stringify(r)})})()}deleteMeasurement(e){var t=this;return(0,c.A)(function*(){const o=(yield t.getMeasurements()).filter(n=>n.id!==e);yield i.p.set({key:t.MEASUREMENTS_KEY,value:JSON.stringify(o)})})()}clearMeasurements(){var e=this;return(0,c.A)(function*(){yield i.p.set({key:e.MEASUREMENTS_KEY,value:JSON.stringify([])})})()}migrateToIndexedDB(){var e=this;return(0,c.A)(function*(){try{const{value:t}=yield i.p.get({key:"geotech_projects"});if(t){const o=JSON.parse(t);if(o.length>0){console.log(`Migrando ${o.length} proyectos a IndexedDB...`);for(const n of o)yield e.saveProject(n);yield i.p.remove({key:"geotech_projects"}),console.log("Proyectos migrados")}}const{value:r}=yield i.p.get({key:"geotech_photos"});if(r){const o=JSON.parse(r);if(o.length>0){console.log(`Migrando ${o.length} fotos a IndexedDB...`);for(const n of o)yield e.savePhoto(n);yield i.p.remove({key:"geotech_photos"}),console.log("Fotos migradas")}}}catch(t){console.error("Error durante migraci\xf3n:",t)}})()}static#e=_=()=>(this.\u0275fac=function(t){return new(t||y)},this.\u0275prov=p.jDH({token:y,factory:y.\u0275fac,providedIn:"root"}))}return _(),y})()}}]);