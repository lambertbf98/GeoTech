"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3106],{3106:($,C,n)=>{n.r(C),n.d(C,{TabsPageModule:()=>N});var d=n(2200),L=n(4341),h=n(7343),b=n(8132),g=n(467),A=n(3888),I=n(1985),O=n(9470),T=n(8211);const e=(0,n(5083).F3)("App",{web:()=>n.e(9303).then(n.bind(n,9303)).then(i=>new i.AppWeb)});var t=n(3664),s=n(6386),c=n(8245),l=n(4796),v=n(5032),f=n(2704);function m(i,a){1&i&&t.nrm(0,"ion-icon",9)}function S(i,a){1&i&&t.nrm(0,"ion-icon",9)}function F(i,a){if(1&i&&(t.j41(0,"ion-badge",10),t.EFF(1),t.k0s()),2&i){const E=t.XpG();t.R7$(),t.JRh(E.pendingSync)}}let D=(()=>{var i;class a{constructor(o,r,u,P,U,G){this.syncService=o,this.licenseService=r,this.authService=u,this.alertController=P,this.router=U,this.platform=G,this.pendingSync=0,this.hasLicense=!1,this.licenseChecked=!1,this.licenseSub=null,this.refreshInterval=null,this.appStateListener=null}ngOnInit(){var o=this;return(0,g.A)(function*(){o.syncService.getPendingCount().then(r=>{o.pendingSync=r}),o.licenseSub=o.licenseService.licenseStatus$.subscribe(r=>{o.hasLicense=r.hasValidLicense,o.licenseChecked=!0}),yield o.checkLicense(),o.refreshInterval=function p(i=0,a=A.E){return i<0&&(i=0),function y(i=0,a,E=A.b){let o=-1;return null!=a&&((0,O.m)(a)?E=a:o=a),new I.c(r=>{let u=(0,T.v)(i)?+i-E.now():i;u<0&&(u=0);let P=0;return E.schedule(function(){r.closed||(r.next(P++),0<=o?this.schedule(void 0,o):r.complete())},u)})}(i,i,a)}(3e4).subscribe(()=>{o.checkLicense()}),o.appStateListener=yield e.addListener("appStateChange",function(){var r=(0,g.A)(function*({isActive:u}){u&&(yield o.checkLicense())});return function(u){return r.apply(this,arguments)}}())})()}ngOnDestroy(){this.licenseSub&&this.licenseSub.unsubscribe(),this.refreshInterval&&this.refreshInterval.unsubscribe(),this.appStateListener&&this.appStateListener.remove()}checkLicense(){var o=this;return(0,g.A)(function*(){o.authService.isAuthenticated&&(yield o.licenseService.checkLicenseStatus())})()}onTabClick(o,r){var u=this;return(0,g.A)(function*(){"settings"===r||u.hasLicense||(o.preventDefault(),o.stopPropagation(),yield(yield u.alertController.create({header:"Licencia requerida",message:"Para acceder a esta funcion necesitas activar una licencia. Ve a Configuracion para activar o comprar una licencia.",buttons:[{text:"Cancelar",role:"cancel"},{text:"Ir a Config",handler:()=>{u.router.navigate(["/tabs/settings"])}}]})).present())})()}static#t=i=()=>(this.\u0275fac=function(r){return new(r||a)(t.rXU(s.H),t.rXU(c.X),t.rXU(l.u),t.rXU(h.hG),t.rXU(f.Ix),t.rXU(v.OD))},this.\u0275cmp=t.VBU({type:a,selectors:[["app-tabs"]],standalone:!1,decls:17,vars:7,consts:[["slot","bottom"],["tab","projects",3,"click"],["name","folder-outline"],["name","lock-closed","class","lock-icon",4,"ngIf"],["tab","catastro",3,"click"],["name","globe-outline"],["tab","settings"],["name","cog-outline"],["color","warning",4,"ngIf"],["name","lock-closed",1,"lock-icon"],["color","warning"]],template:function(r,u){1&r&&(t.j41(0,"ion-tabs")(1,"ion-tab-bar",0)(2,"ion-tab-button",1),t.bIt("click",function(U){return u.onTabClick(U,"projects")}),t.nrm(3,"ion-icon",2),t.j41(4,"ion-label"),t.EFF(5,"Proyectos"),t.k0s(),t.DNE(6,m,1,0,"ion-icon",3),t.k0s(),t.j41(7,"ion-tab-button",4),t.bIt("click",function(U){return u.onTabClick(U,"catastro")}),t.nrm(8,"ion-icon",5),t.j41(9,"ion-label"),t.EFF(10,"GeoVisor"),t.k0s(),t.DNE(11,S,1,0,"ion-icon",3),t.k0s(),t.j41(12,"ion-tab-button",6),t.nrm(13,"ion-icon",7),t.j41(14,"ion-label"),t.EFF(15,"Config"),t.k0s(),t.DNE(16,F,2,1,"ion-badge",8),t.k0s()()()),2&r&&(t.R7$(2),t.AVh("disabled-tab",!u.hasLicense&&u.licenseChecked),t.R7$(4),t.Y8G("ngIf",!u.hasLicense&&u.licenseChecked),t.R7$(),t.AVh("disabled-tab",!u.hasLicense&&u.licenseChecked),t.R7$(4),t.Y8G("ngIf",!u.hasLicense&&u.licenseChecked),t.R7$(5),t.Y8G("ngIf",u.pendingSync>0))},dependencies:[d.bT,h.In,h.iq,h.he,h.Jq,h.qW,h.p4],styles:["ion-tab-bar[_ngcontent-%COMP%]{--background: #ffffff;border-top:1px solid #e2e8f0;height:60px;padding-bottom:env(safe-area-inset-bottom)}ion-tab-button[_ngcontent-%COMP%]{--color: #6b7280;--color-selected: #1a5f7a;font-size:11px;font-weight:500;position:relative}ion-tab-button[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:24px;margin-bottom:2px}ion-tab-button[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{font-size:11px}ion-tab-button[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%]{position:absolute;top:4px;right:calc(50% - 20px);font-size:10px;padding:2px 6px;min-width:18px;height:18px}ion-tab-button.disabled-tab[_ngcontent-%COMP%]{--color: #c0c0c0;opacity:.6}ion-tab-button[_ngcontent-%COMP%]   .lock-icon[_ngcontent-%COMP%]{position:absolute;top:2px;right:calc(50% - 24px);font-size:12px;color:#f59e0b}"]}))}return i(),a})();var j=n(2615);let x=(()=>{var i;class a{constructor(o,r,u,P){this.licenseService=o,this.authService=r,this.router=u,this.alertController=P}canActivate(){var o=this;return(0,g.A)(function*(){if(!o.authService.isAuthenticated)return o.router.createUrlTree(["/auth/login"]);try{if((yield o.licenseService.checkLicenseStatus()).hasValidLicense)return!0}catch(r){console.error("Error checking license:",r)}return yield o.showNoLicenseAlert(),o.router.createUrlTree(["/tabs/settings"])})()}showNoLicenseAlert(){var o=this;return(0,g.A)(function*(){yield(yield o.alertController.create({header:"Licencia Requerida",message:"Necesitas una licencia activa para acceder a esta funcionalidad. Por favor, activa o compra una licencia.",buttons:["Entendido"],cssClass:"license-alert"})).present()})()}static#t=i=()=>(this.\u0275fac=function(r){return new(r||a)(j.KVO(c.X),j.KVO(l.u),j.KVO(f.Ix),j.KVO(h.hG))},this.\u0275prov=j.jDH({token:a,factory:a.\u0275fac,providedIn:"root"}))}return i(),a})();const V=[{path:"",component:D,children:[{path:"projects",loadChildren:()=>Promise.all([n.e(2076),n.e(1707)]).then(n.bind(n,1707)).then(i=>i.ProjectsPageModule),canActivate:[x]},{path:"camera",loadChildren:()=>Promise.all([n.e(2076),n.e(9361)]).then(n.bind(n,9361)).then(i=>i.CameraPageModule),canActivate:[x]},{path:"catastro",loadChildren:()=>Promise.all([n.e(139),n.e(2076),n.e(3408)]).then(n.bind(n,3408)).then(i=>i.CatastroPageModule),canActivate:[x]},{path:"settings",loadChildren:()=>n.e(5371).then(n.bind(n,5371)).then(i=>i.SettingsPageModule)},{path:"mediciones",loadChildren:()=>n.e(2076).then(n.bind(n,4034)).then(i=>i.MedicionesPageModule),canActivate:[x]},{path:"",redirectTo:"settings",pathMatch:"full"}]}];let B=(()=>{var i;class a{static#t=i=()=>(this.\u0275fac=function(r){return new(r||a)},this.\u0275mod=t.$C({type:a}),this.\u0275inj=j.G2t({imports:[b.iI.forChild(V),b.iI]}))}return i(),a})(),N=(()=>{var i;class a{static#t=i=()=>(this.\u0275fac=function(r){return new(r||a)},this.\u0275mod=t.$C({type:a}),this.\u0275inj=j.G2t({imports:[d.MD,L.YN,h.bv,B]}))}return i(),a})()},6386:($,C,n)=>{n.d(C,{H:()=>T});var d=n(467);const h=(0,n(5083).F3)("Network",{web:()=>n.e(3780).then(n.bind(n,3780)).then(y=>new y.NetworkWeb)});var b=n(4412),g=n(2615),A=n(3366),I=n(7291),O=n(9473);let T=(()=>{var y;class p{constructor(e,t,s){this.api=e,this.storage=t,this.camera=s,this.isOnlineSubject=new b.t(!0),this.isSyncingSubject=new b.t(!1),this.pendingCountSubject=new b.t(0),this.isOnline$=this.isOnlineSubject.asObservable(),this.isSyncing$=this.isSyncingSubject.asObservable(),this.pendingCount$=this.pendingCountSubject.asObservable(),this.syncInProgress=!1,this.initNetworkListener()}initNetworkListener(){var e=this;return(0,d.A)(function*(){const t=yield h.getStatus();e.isOnlineSubject.next(t.connected),h.addListener("networkStatusChange",function(){var s=(0,d.A)(function*(c){e.isOnlineSubject.next(c.connected),c.connected&&!e.syncInProgress&&(yield e.syncPending())});return function(c){return s.apply(this,arguments)}}()),yield e.updatePendingCount()})()}updatePendingCount(){var e=this;return(0,d.A)(function*(){const t=yield e.storage.getPendingSyncCount();e.pendingCountSubject.next(t)})()}queueForSync(e,t,s,c){var l=this;return(0,d.A)(function*(){const v={id:l.storage.generateId(),action:e,entity:t,entityId:s,data:c,createdAt:new Date,attempts:0,status:"pending"};yield l.storage.addToSyncQueue(v),yield l.updatePendingCount(),l.isOnlineSubject.value&&!l.syncInProgress&&(yield l.syncPending())})()}syncPending(){var e=this;return(0,d.A)(function*(){if(!e.syncInProgress&&e.isOnlineSubject.value){e.syncInProgress=!0,e.isSyncingSubject.next(!0);try{const s=(yield e.storage.getSyncQueue()).filter(c=>"pending"===c.status&&c.attempts<3);if(0===s.length)return;for(const c of s)try{yield e.syncItem(c),yield e.storage.removeFromSyncQueue(c.id)}catch(l){c.attempts++,c.lastAttempt=new Date,c.error=l instanceof Error?l.message:"Error desconocido",c.attempts>=3&&(c.status="error"),yield e.storage.updateSyncQueueItem(c)}}finally{e.syncInProgress=!1,e.isSyncingSubject.next(!1),yield e.updatePendingCount()}}})()}syncItem(e){var t=this;return(0,d.A)(function*(){switch(e.entity){case"project":yield t.syncProject(e);break;case"photo":yield t.syncPhoto(e)}})()}syncProject(e){var t=this;return(0,d.A)(function*(){switch(e.action){case"CREATE":const s=yield t.api.post("/projects",e.data).toPromise();if(s&&s.project&&s.project.id){const l=(yield t.storage.getProjects()).find(v=>v.id===e.entityId);l&&(l.serverId=s.project.id,l.synced=!0,yield t.storage.saveProject(l),console.log("Proyecto sincronizado con serverId:",s.project.id))}break;case"UPDATE":yield t.api.put(`/projects/${e.entityId}`,e.data).toPromise();break;case"DELETE":yield t.api.delete(`/projects/${e.entityId}`).toPromise()}})()}syncPhoto(e){var t=this;return(0,d.A)(function*(){switch(e.action){case"CREATE":const s=yield t.storage.getPhoto(e.entityId);if(s&&s.localPath){const l=(yield t.storage.getProjects()).find(F=>F.id===s.projectId);if(!l||!l.serverId)throw console.log("Proyecto no sincronizado aun, esperando..."),new Error("El proyecto debe sincronizarse primero");const v=yield t.camera.getPhotoBase64(s.localPath),f=new FormData,m=t.base64ToBlob(v,"image/jpeg");f.append("file",m,"photo.jpg"),f.append("projectId",l.serverId),f.append("latitude",s.latitude.toString()),f.append("longitude",s.longitude.toString()),s.altitude&&f.append("altitude",s.altitude.toString()),s.accuracy&&f.append("accuracy",s.accuracy.toString()),s.notes&&f.append("notes",s.notes);const S=yield t.api.uploadFile("/photos",f).toPromise();S&&S.photo&&(s.imageUrl=S.photo.imageUrl,s.thumbnailUrl=S.photo.thumbnailUrl,s.serverId=S.photo.id,s.synced=!0,yield t.storage.savePhoto(s),console.log("Foto sincronizada:",S.photo.id))}break;case"UPDATE":yield t.api.put(`/photos/${e.entityId}`,e.data).toPromise();break;case"DELETE":yield t.api.delete(`/photos/${e.entityId}`).toPromise()}})()}base64ToBlob(e,t){const s=atob(e),c=[];for(let l=0;l<s.length;l+=512){const v=s.slice(l,l+512),f=new Array(v.length);for(let m=0;m<v.length;m++)f[m]=v.charCodeAt(m);c.push(new Uint8Array(f))}return new Blob(c,{type:t})}get isOnline(){return this.isOnlineSubject.value}get isSyncing(){return this.isSyncingSubject.value}getPendingCount(){var e=this;return(0,d.A)(function*(){return yield e.storage.getPendingSyncCount()})()}syncAll(){var e=this;return(0,d.A)(function*(){yield e.syncPending()})()}static#t=y=()=>(this.\u0275fac=function(t){return new(t||p)(g.KVO(A.G),g.KVO(I.n),g.KVO(O.j))},this.\u0275prov=g.jDH({token:p,factory:p.\u0275fac,providedIn:"root"}))}return y(),p})()},8245:($,C,n)=>{n.d(C,{X:()=>T});var d=n(467),L=n(4412),h=n(4843),b=n(5312);const A=(0,n(5083).F3)("Browser",{web:()=>n.e(4786).then(n.bind(n,4786)).then(y=>new y.BrowserWeb)});var I=n(2615),O=n(9330);let T=(()=>{var y;class p{constructor(e){this.http=e,this.apiUrl=b.c.apiUrl,this.licenseStatusSubject=new L.t({hasValidLicense:!1,license:null}),this.licenseStatus$=this.licenseStatusSubject.asObservable()}checkLicenseStatus(){var e=this;return(0,d.A)(function*(){if(!localStorage.getItem("token")){const s={hasValidLicense:!1,license:null};return e.licenseStatusSubject.next(s),s}try{const s=yield(0,h._)(e.http.get(`${e.apiUrl}/licenses/status`));return e.licenseStatusSubject.next(s),s}catch(s){console.error("Error checking license status:",s);const c={hasValidLicense:!1,license:null};return e.licenseStatusSubject.next(c),c}})()}getCurrentStatus(){return this.licenseStatusSubject.value}hasValidLicense(){return this.licenseStatusSubject.value.hasValidLicense}activateLicense(e){var t=this;return(0,d.A)(function*(){const s=yield(0,h._)(t.http.post(`${t.apiUrl}/licenses/activate`,{licenseKey:e}));return yield t.checkLicenseStatus(),s})()}getLicenseTypes(){var e=this;return(0,d.A)(function*(){return(0,h._)(e.http.get(`${e.apiUrl}/licenses/types`))})()}createPaymentOrder(e){var t=this;return(0,d.A)(function*(){return(0,h._)(t.http.post(`${t.apiUrl}/payments/create-order`,{licenseTypeId:e}))})()}purchaseLicense(e){var t=this;return(0,d.A)(function*(){const s=yield t.createPaymentOrder(e);s.approvalUrl&&(yield A.open({url:s.approvalUrl}))})()}capturePayment(e){var t=this;return(0,d.A)(function*(){const s=yield(0,h._)(t.http.post(`${t.apiUrl}/payments/capture`,{orderId:e}));return yield t.checkLicenseStatus(),s})()}getPaymentHistory(){var e=this;return(0,d.A)(function*(){return(0,h._)(e.http.get(`${e.apiUrl}/payments/history`))})()}formatPrice(e){return new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(e)}formatDaysRemaining(e){return e<=0?"Expirada":1===e?"1 dia restante":`${e} dias restantes`}static#t=y=()=>(this.\u0275fac=function(t){return new(t||p)(I.KVO(O.Qq))},this.\u0275prov=I.jDH({token:p,factory:p.\u0275fac,providedIn:"root"}))}return y(),p})()}}]);