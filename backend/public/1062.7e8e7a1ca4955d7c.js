"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1062],{1062:(U,A,e)=>{e.r(A),e.d(A,{TabsPageModule:()=>$});var d=e(2200),I=e(4341),g=e(7343),f=e(8132),p=e(467),j=e(3888),P=e(1807);const y=(0,e(5083).F3)("App",{web:()=>e.e(9303).then(e.bind(e,9303)).then(o=>new o.AppWeb)});var n=e(3664),M=e(6386),t=e(8245),s=e(4796),i=e(5032),r=e(2704);function l(o,u){1&o&&n.nrm(0,"ion-icon",9)}function m(o,u){1&o&&n.nrm(0,"ion-icon",9)}function b(o,u){if(1&o&&(n.j41(0,"ion-badge",10),n.EFF(1),n.k0s()),2&o){const F=n.XpG();n.R7$(),n.JRh(F.pendingSync)}}let L=(()=>{var o;class u{constructor(a,c,h,E,T,B){this.syncService=a,this.licenseService=c,this.authService=h,this.alertController=E,this.router=T,this.platform=B,this.pendingSync=0,this.hasLicense=!1,this.licenseChecked=!1,this.licenseSub=null,this.refreshInterval=null,this.appStateListener=null}ngOnInit(){var a=this;return(0,p.A)(function*(){a.syncService.getPendingCount().then(c=>{a.pendingSync=c}),a.licenseSub=a.licenseService.licenseStatus$.subscribe(c=>{a.hasLicense=c.hasValidLicense,a.licenseChecked=!0}),yield a.checkLicense(),a.refreshInterval=function S(o=0,u=j.E){return o<0&&(o=0),(0,P.O)(o,o,u)}(6e4).subscribe(()=>{a.checkLicense()}),a.appStateListener=yield y.addListener("appStateChange",function(){var c=(0,p.A)(function*({isActive:h}){h&&(yield a.checkLicense())});return function(h){return c.apply(this,arguments)}}())})()}ngOnDestroy(){this.licenseSub&&this.licenseSub.unsubscribe(),this.refreshInterval&&this.refreshInterval.unsubscribe(),this.appStateListener&&this.appStateListener.remove()}checkLicense(){var a=this;return(0,p.A)(function*(){a.authService.isAuthenticated&&(yield a.licenseService.checkLicenseStatus())})()}onTabClick(a,c){var h=this;return(0,p.A)(function*(){"settings"===c||h.hasLicense||(a.preventDefault(),a.stopPropagation(),yield(yield h.alertController.create({header:"Licencia requerida",message:"Para acceder a esta funcion necesitas activar una licencia. Ve a Configuracion para activar o comprar una licencia.",buttons:[{text:"Cancelar",role:"cancel"},{text:"Ir a Config",handler:()=>{h.router.navigate(["/tabs/settings"])}}]})).present())})()}static#t=o=()=>(this.\u0275fac=function(c){return new(c||u)(n.rXU(M.H),n.rXU(t.X),n.rXU(s.u),n.rXU(g.hG),n.rXU(r.Ix),n.rXU(i.OD))},this.\u0275cmp=n.VBU({type:u,selectors:[["app-tabs"]],standalone:!1,decls:17,vars:7,consts:[["slot","bottom"],["tab","projects",3,"click"],["name","folder-outline"],["name","lock-closed","class","lock-icon",4,"ngIf"],["tab","catastro",3,"click"],["name","globe-outline"],["tab","settings"],["name","cog-outline"],["color","warning",4,"ngIf"],["name","lock-closed",1,"lock-icon"],["color","warning"]],template:function(c,h){1&c&&(n.j41(0,"ion-tabs")(1,"ion-tab-bar",0)(2,"ion-tab-button",1),n.bIt("click",function(T){return h.onTabClick(T,"projects")}),n.nrm(3,"ion-icon",2),n.j41(4,"ion-label"),n.EFF(5,"Proyectos"),n.k0s(),n.DNE(6,l,1,0,"ion-icon",3),n.k0s(),n.j41(7,"ion-tab-button",4),n.bIt("click",function(T){return h.onTabClick(T,"catastro")}),n.nrm(8,"ion-icon",5),n.j41(9,"ion-label"),n.EFF(10,"GeoVisor"),n.k0s(),n.DNE(11,m,1,0,"ion-icon",3),n.k0s(),n.j41(12,"ion-tab-button",6),n.nrm(13,"ion-icon",7),n.j41(14,"ion-label"),n.EFF(15,"Config"),n.k0s(),n.DNE(16,b,2,1,"ion-badge",8),n.k0s()()()),2&c&&(n.R7$(2),n.AVh("disabled-tab",!h.hasLicense&&h.licenseChecked),n.R7$(4),n.Y8G("ngIf",!h.hasLicense&&h.licenseChecked),n.R7$(),n.AVh("disabled-tab",!h.hasLicense&&h.licenseChecked),n.R7$(4),n.Y8G("ngIf",!h.hasLicense&&h.licenseChecked),n.R7$(5),n.Y8G("ngIf",h.pendingSync>0))},dependencies:[d.bT,g.In,g.iq,g.he,g.Jq,g.qW,g.p4],styles:["ion-tab-bar[_ngcontent-%COMP%]{--background: #ffffff;border-top:1px solid #e2e8f0;height:60px;padding-bottom:env(safe-area-inset-bottom)}ion-tab-button[_ngcontent-%COMP%]{--color: #6b7280;--color-selected: #1a5f7a;font-size:11px;font-weight:500;position:relative}ion-tab-button[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:24px;margin-bottom:2px}ion-tab-button[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{font-size:11px}ion-tab-button[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%]{position:absolute;top:4px;right:calc(50% - 20px);font-size:10px;padding:2px 6px;min-width:18px;height:18px}ion-tab-button.disabled-tab[_ngcontent-%COMP%]{--color: #c0c0c0;opacity:.6}ion-tab-button[_ngcontent-%COMP%]   .lock-icon[_ngcontent-%COMP%]{position:absolute;top:2px;right:calc(50% - 24px);font-size:12px;color:#f59e0b}"]}))}return o(),u})();var v=e(2615);let O=(()=>{var o;class u{constructor(a,c,h,E){this.licenseService=a,this.authService=c,this.router=h,this.alertController=E}canActivate(){var a=this;return(0,p.A)(function*(){if(!a.authService.isAuthenticated)return a.router.createUrlTree(["/login"]);try{if((yield a.licenseService.checkLicenseStatus()).hasValidLicense)return!0}catch(c){console.error("Error checking license:",c)}return yield a.showNoLicenseAlert(),a.router.createUrlTree(["/tabs/settings"])})()}showNoLicenseAlert(){var a=this;return(0,p.A)(function*(){yield(yield a.alertController.create({header:"Licencia Requerida",message:"Necesitas una licencia activa para acceder a esta funcionalidad. Por favor, activa o compra una licencia.",buttons:["Entendido"],cssClass:"license-alert"})).present()})()}static#t=o=()=>(this.\u0275fac=function(c){return new(c||u)(v.KVO(t.X),v.KVO(s.u),v.KVO(r.Ix),v.KVO(g.hG))},this.\u0275prov=v.jDH({token:u,factory:u.\u0275fac,providedIn:"root"}))}return o(),u})();const D=[{path:"",component:L,children:[{path:"projects",loadChildren:()=>Promise.all([e.e(2076),e.e(1707)]).then(e.bind(e,1707)).then(o=>o.ProjectsPageModule),canActivate:[O]},{path:"camera",loadChildren:()=>Promise.all([e.e(2076),e.e(9361)]).then(e.bind(e,9361)).then(o=>o.CameraPageModule),canActivate:[O]},{path:"catastro",loadChildren:()=>Promise.all([e.e(139),e.e(2076),e.e(9929)]).then(e.bind(e,9929)).then(o=>o.CatastroPageModule),canActivate:[O]},{path:"settings",loadChildren:()=>e.e(5371).then(e.bind(e,5371)).then(o=>o.SettingsPageModule)},{path:"mediciones",loadChildren:()=>e.e(2076).then(e.bind(e,4034)).then(o=>o.MedicionesPageModule),canActivate:[O]},{path:"",redirectTo:"settings",pathMatch:"full"}]}];let x=(()=>{var o;class u{static#t=o=()=>(this.\u0275fac=function(c){return new(c||u)},this.\u0275mod=n.$C({type:u}),this.\u0275inj=v.G2t({imports:[f.iI.forChild(D),f.iI]}))}return o(),u})(),$=(()=>{var o;class u{static#t=o=()=>(this.\u0275fac=function(c){return new(c||u)},this.\u0275mod=n.$C({type:u}),this.\u0275inj=v.G2t({imports:[d.MD,I.YN,g.bv,x]}))}return o(),u})()},1807:(U,A,e)=>{e.d(A,{O:()=>p});var d=e(1985),I=e(3888),g=e(9470),f=e(8211);function p(j=0,P,S=I.b){let C=-1;return null!=P&&((0,g.m)(P)?S=P:C=P),new d.c(y=>{let n=(0,f.v)(j)?+j-S.now():j;n<0&&(n=0);let M=0;return S.schedule(function(){y.closed||(y.next(M++),0<=C?this.schedule(void 0,C):y.complete())},n)})}},6386:(U,A,e)=>{e.d(A,{H:()=>C});var d=e(467);const g=(0,e(5083).F3)("Network",{web:()=>e.e(3780).then(e.bind(e,3780)).then(y=>new y.NetworkWeb)});var f=e(4412),p=e(2615),j=e(3366),P=e(7291),S=e(9473);let C=(()=>{var y;class n{constructor(t,s,i){this.api=t,this.storage=s,this.camera=i,this.isOnlineSubject=new f.t(!0),this.isSyncingSubject=new f.t(!1),this.pendingCountSubject=new f.t(0),this.isOnline$=this.isOnlineSubject.asObservable(),this.isSyncing$=this.isSyncingSubject.asObservable(),this.pendingCount$=this.pendingCountSubject.asObservable(),this.syncInProgress=!1,this.initNetworkListener()}initNetworkListener(){var t=this;return(0,d.A)(function*(){const s=yield g.getStatus();t.isOnlineSubject.next(s.connected),g.addListener("networkStatusChange",function(){var i=(0,d.A)(function*(r){t.isOnlineSubject.next(r.connected),r.connected&&!t.syncInProgress&&(yield t.syncPending())});return function(r){return i.apply(this,arguments)}}()),yield t.updatePendingCount()})()}updatePendingCount(){var t=this;return(0,d.A)(function*(){const s=yield t.storage.getPendingSyncCount();t.pendingCountSubject.next(s)})()}queueForSync(t,s,i,r){var l=this;return(0,d.A)(function*(){const m={id:l.storage.generateId(),action:t,entity:s,entityId:i,data:r,createdAt:new Date,attempts:0,status:"pending"};yield l.storage.addToSyncQueue(m),yield l.updatePendingCount(),l.isOnlineSubject.value&&!l.syncInProgress&&(yield l.syncPending())})()}syncPending(){var t=this;return(0,d.A)(function*(){if(!t.syncInProgress&&t.isOnlineSubject.value){t.syncInProgress=!0,t.isSyncingSubject.next(!0);try{const i=(yield t.storage.getSyncQueue()).filter(r=>"pending"===r.status&&r.attempts<3);if(0===i.length)return;for(const r of i)try{yield t.syncItem(r),yield t.storage.removeFromSyncQueue(r.id)}catch(l){r.attempts++,r.lastAttempt=new Date,r.error=l instanceof Error?l.message:"Error desconocido",r.attempts>=3&&(r.status="error"),yield t.storage.updateSyncQueueItem(r)}}finally{t.syncInProgress=!1,t.isSyncingSubject.next(!1),yield t.updatePendingCount()}}})()}syncItem(t){var s=this;return(0,d.A)(function*(){switch(t.entity){case"project":yield s.syncProject(t);break;case"photo":yield s.syncPhoto(t)}})()}syncProject(t){var s=this;return(0,d.A)(function*(){switch(t.action){case"CREATE":const i=yield s.api.post("/projects",t.data).toPromise();if(i&&i.project&&i.project.id){const l=(yield s.storage.getProjects()).find(m=>m.id===t.entityId);l&&(l.serverId=i.project.id,l.synced=!0,yield s.storage.saveProject(l),console.log("Proyecto sincronizado con serverId:",i.project.id))}break;case"UPDATE":yield s.api.put(`/projects/${t.entityId}`,t.data).toPromise();break;case"DELETE":yield s.api.delete(`/projects/${t.entityId}`).toPromise()}})()}syncPhoto(t){var s=this;return(0,d.A)(function*(){switch(t.action){case"CREATE":const i=yield s.storage.getPhoto(t.entityId);if(i&&i.localPath){const l=(yield s.storage.getProjects()).find(O=>O.id===i.projectId);if(!l||!l.serverId)throw console.log("Proyecto no sincronizado aun, esperando..."),new Error("El proyecto debe sincronizarse primero");const m=yield s.camera.getPhotoBase64(i.localPath),b=new FormData,L=s.base64ToBlob(m,"image/jpeg");b.append("file",L,"photo.jpg"),b.append("projectId",l.serverId),b.append("latitude",i.latitude.toString()),b.append("longitude",i.longitude.toString()),i.altitude&&b.append("altitude",i.altitude.toString()),i.accuracy&&b.append("accuracy",i.accuracy.toString()),i.notes&&b.append("notes",i.notes);const v=yield s.api.uploadFile("/photos",b).toPromise();v&&v.photo&&(i.imageUrl=v.photo.imageUrl,i.thumbnailUrl=v.photo.thumbnailUrl,i.serverId=v.photo.id,i.synced=!0,yield s.storage.savePhoto(i),console.log("Foto sincronizada:",v.photo.id))}break;case"UPDATE":yield s.api.put(`/photos/${t.entityId}`,t.data).toPromise();break;case"DELETE":yield s.api.delete(`/photos/${t.entityId}`).toPromise()}})()}base64ToBlob(t,s){const i=atob(t),r=[];for(let l=0;l<i.length;l+=512){const m=i.slice(l,l+512),b=new Array(m.length);for(let L=0;L<m.length;L++)b[L]=m.charCodeAt(L);r.push(new Uint8Array(b))}return new Blob(r,{type:s})}get isOnline(){return this.isOnlineSubject.value}get isSyncing(){return this.isSyncingSubject.value}getPendingCount(){var t=this;return(0,d.A)(function*(){return yield t.storage.getPendingSyncCount()})()}syncAll(){var t=this;return(0,d.A)(function*(){yield t.syncPending()})()}static#t=y=()=>(this.\u0275fac=function(s){return new(s||n)(p.KVO(j.G),p.KVO(P.n),p.KVO(S.j))},this.\u0275prov=p.jDH({token:n,factory:n.\u0275fac,providedIn:"root"}))}return y(),n})()},8245:(U,A,e)=>{e.d(A,{X:()=>C});var d=e(467),I=e(9330),g=e(4412),f=e(4843),p=e(5312);const P=(0,e(5083).F3)("Browser",{web:()=>e.e(4786).then(e.bind(e,4786)).then(y=>new y.BrowserWeb)});var S=e(2615);let C=(()=>{var y;class n{constructor(t){this.http=t,this.apiUrl=p.c.apiUrl,this.licenseStatusSubject=new g.t({hasValidLicense:!1,license:null}),this.licenseStatus$=this.licenseStatusSubject.asObservable()}getAuthHeaders(){const t=localStorage.getItem("token");let s=new I.Lr({"Content-Type":"application/json"});return t&&(s=s.set("Authorization",`Bearer ${t}`)),s}checkLicenseStatus(){var t=this;return(0,d.A)(function*(){if(!localStorage.getItem("token")){const i={hasValidLicense:!1,license:null};return t.licenseStatusSubject.next(i),i}try{const i=yield(0,f._)(t.http.get(`${t.apiUrl}/licenses/status`,{headers:t.getAuthHeaders()}));return t.licenseStatusSubject.next(i),i}catch(i){401!==i?.status&&console.error("Error checking license status:",i);const r={hasValidLicense:!1,license:null};return t.licenseStatusSubject.next(r),r}})()}getCurrentStatus(){return this.licenseStatusSubject.value}hasValidLicense(){return this.licenseStatusSubject.value.hasValidLicense}activateLicense(t){var s=this;return(0,d.A)(function*(){const i=yield(0,f._)(s.http.post(`${s.apiUrl}/licenses/activate`,{licenseKey:t},{headers:s.getAuthHeaders()}));return yield s.checkLicenseStatus(),i})()}getLicenseTypes(){var t=this;return(0,d.A)(function*(){return(0,f._)(t.http.get(`${t.apiUrl}/licenses/types`))})()}createPaymentOrder(t){var s=this;return(0,d.A)(function*(){return(0,f._)(s.http.post(`${s.apiUrl}/payments/create-order`,{licenseTypeId:t},{headers:s.getAuthHeaders()}))})()}purchaseLicense(t){var s=this;return(0,d.A)(function*(){const i=yield s.createPaymentOrder(t);i.approvalUrl&&(yield P.open({url:i.approvalUrl}))})()}capturePayment(t){var s=this;return(0,d.A)(function*(){const i=yield(0,f._)(s.http.post(`${s.apiUrl}/payments/capture`,{orderId:t},{headers:s.getAuthHeaders()}));return yield s.checkLicenseStatus(),i})()}getPaymentHistory(){var t=this;return(0,d.A)(function*(){return(0,f._)(t.http.get(`${t.apiUrl}/payments/history`,{headers:t.getAuthHeaders()}))})()}formatPrice(t){return new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(t)}formatDaysRemaining(t){return t<=0?"Expirada":1===t?"1 dia restante":`${t} dias restantes`}static#t=y=()=>(this.\u0275fac=function(s){return new(s||n)(S.KVO(I.Qq))},this.\u0275prov=S.jDH({token:n,factory:n.\u0275fac,providedIn:"root"}))}return y(),n})()}}]);