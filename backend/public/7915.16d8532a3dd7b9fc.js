"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7915],{6386:(j,y,e)=>{e.d(y,{H:()=>p});var c=e(467);const d=(0,e(5083).F3)("Network",{web:()=>e.e(3780).then(e.bind(e,3780)).then(u=>new u.NetworkWeb)});var g=e(4412),i=e(2615),P=e(3366),m=e(7291),v=e(9473);let p=(()=>{var u;class l{constructor(t,n,s){this.api=t,this.storage=n,this.camera=s,this.isOnlineSubject=new g.t(!0),this.isSyncingSubject=new g.t(!1),this.pendingCountSubject=new g.t(0),this.isOnline$=this.isOnlineSubject.asObservable(),this.isSyncing$=this.isSyncingSubject.asObservable(),this.pendingCount$=this.pendingCountSubject.asObservable(),this.syncInProgress=!1,this.initNetworkListener()}initNetworkListener(){var t=this;return(0,c.A)(function*(){const n=yield d.getStatus();t.isOnlineSubject.next(n.connected),d.addListener("networkStatusChange",function(){var s=(0,c.A)(function*(a){t.isOnlineSubject.next(a.connected),a.connected&&!t.syncInProgress&&(yield t.syncPending())});return function(a){return s.apply(this,arguments)}}()),yield t.updatePendingCount()})()}updatePendingCount(){var t=this;return(0,c.A)(function*(){const n=yield t.storage.getPendingSyncCount();t.pendingCountSubject.next(n)})()}queueForSync(t,n,s,a){var o=this;return(0,c.A)(function*(){const r={id:o.storage.generateId(),action:t,entity:n,entityId:s,data:a,createdAt:new Date,attempts:0,status:"pending"};yield o.storage.addToSyncQueue(r),yield o.updatePendingCount(),o.isOnlineSubject.value&&!o.syncInProgress&&(yield o.syncPending())})()}syncPending(){var t=this;return(0,c.A)(function*(){if(!t.syncInProgress&&t.isOnlineSubject.value){t.syncInProgress=!0,t.isSyncingSubject.next(!0);try{const s=(yield t.storage.getSyncQueue()).filter(a=>"pending"===a.status&&a.attempts<3);if(0===s.length)return;for(const a of s)try{yield t.syncItem(a),yield t.storage.removeFromSyncQueue(a.id)}catch(o){a.attempts++,a.lastAttempt=new Date,a.error=o instanceof Error?o.message:"Error desconocido",a.attempts>=3&&(a.status="error"),yield t.storage.updateSyncQueueItem(a)}}finally{t.syncInProgress=!1,t.isSyncingSubject.next(!1),yield t.updatePendingCount()}}})()}syncItem(t){var n=this;return(0,c.A)(function*(){switch(t.entity){case"project":yield n.syncProject(t);break;case"photo":yield n.syncPhoto(t)}})()}syncProject(t){var n=this;return(0,c.A)(function*(){switch(t.action){case"CREATE":const s=yield n.api.post("/projects",t.data).toPromise();if(s&&s.project&&s.project.id){const o=(yield n.storage.getProjects()).find(r=>r.id===t.entityId);o&&(o.serverId=s.project.id,o.synced=!0,yield n.storage.saveProject(o),console.log("Proyecto sincronizado con serverId:",s.project.id))}break;case"UPDATE":yield n.api.put(`/projects/${t.entityId}`,t.data).toPromise();break;case"DELETE":yield n.api.delete(`/projects/${t.entityId}`).toPromise()}})()}syncPhoto(t){var n=this;return(0,c.A)(function*(){switch(t.action){case"CREATE":const s=yield n.storage.getPhoto(t.entityId);if(s&&s.localPath){const a=yield n.camera.getPhotoBase64(s.localPath),o=new FormData,r=n.base64ToBlob(a,"image/jpeg");o.append("file",r,"photo.jpg"),o.append("projectId",s.projectId),o.append("latitude",s.latitude.toString()),o.append("longitude",s.longitude.toString()),s.altitude&&o.append("altitude",s.altitude.toString()),s.accuracy&&o.append("accuracy",s.accuracy.toString()),s.notes&&o.append("notes",s.notes);const h=yield n.api.uploadFile("/photos",o).toPromise();h&&h.photo&&(s.imageUrl=h.photo.imageUrl,s.synced=!0,yield n.storage.savePhoto(s))}break;case"UPDATE":yield n.api.put(`/photos/${t.entityId}`,t.data).toPromise();break;case"DELETE":yield n.api.delete(`/photos/${t.entityId}`).toPromise()}})()}base64ToBlob(t,n){const s=atob(t),a=[];for(let o=0;o<s.length;o+=512){const r=s.slice(o,o+512),h=new Array(r.length);for(let f=0;f<r.length;f++)h[f]=r.charCodeAt(f);a.push(new Uint8Array(h))}return new Blob(a,{type:n})}get isOnline(){return this.isOnlineSubject.value}get isSyncing(){return this.isSyncingSubject.value}getPendingCount(){var t=this;return(0,c.A)(function*(){return yield t.storage.getPendingSyncCount()})()}syncAll(){var t=this;return(0,c.A)(function*(){yield t.syncPending()})()}static#t=u=()=>(this.\u0275fac=function(n){return new(n||l)(i.KVO(P.G),i.KVO(m.n),i.KVO(v.j))},this.\u0275prov=i.jDH({token:l,factory:l.\u0275fac,providedIn:"root"}))}return u(),l})()},7915:(j,y,e)=>{e.r(y),e.d(y,{TabsPageModule:()=>S});var c=e(2200),b=e(4341),d=e(7343),g=e(8132),i=e(3664),P=e(6386);function m(t,n){if(1&t&&(i.j41(0,"ion-badge",8),i.EFF(1),i.k0s()),2&t){const s=i.XpG();i.R7$(),i.JRh(s.pendingSync)}}let v=(()=>{var t;class n{constructor(a){this.syncService=a,this.pendingSync=0}ngOnInit(){this.syncService.getPendingCount().then(a=>{this.pendingSync=a})}static#t=t=()=>(this.\u0275fac=function(o){return new(o||n)(i.rXU(P.H))},this.\u0275cmp=i.VBU({type:n,selectors:[["app-tabs"]],standalone:!1,decls:15,vars:1,consts:[["slot","bottom"],["tab","projects"],["name","folder-outline"],["tab","catastro"],["name","globe-outline"],["tab","settings"],["name","cog-outline"],["color","warning",4,"ngIf"],["color","warning"]],template:function(o,r){1&o&&(i.j41(0,"ion-tabs")(1,"ion-tab-bar",0)(2,"ion-tab-button",1),i.nrm(3,"ion-icon",2),i.j41(4,"ion-label"),i.EFF(5,"Proyectos"),i.k0s()(),i.j41(6,"ion-tab-button",3),i.nrm(7,"ion-icon",4),i.j41(8,"ion-label"),i.EFF(9,"GeoVisor"),i.k0s()(),i.j41(10,"ion-tab-button",5),i.nrm(11,"ion-icon",6),i.j41(12,"ion-label"),i.EFF(13,"Config"),i.k0s(),i.DNE(14,m,2,1,"ion-badge",7),i.k0s()()()),2&o&&(i.R7$(14),i.Y8G("ngIf",r.pendingSync>0))},dependencies:[c.bT,d.In,d.iq,d.he,d.Jq,d.qW,d.p4],styles:["ion-tab-bar[_ngcontent-%COMP%]{--background: #ffffff;border-top:1px solid #e2e8f0;height:60px;padding-bottom:env(safe-area-inset-bottom)}ion-tab-button[_ngcontent-%COMP%]{--color: #6b7280;--color-selected: #1a5f7a;font-size:11px;font-weight:500}ion-tab-button[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:24px;margin-bottom:2px}ion-tab-button[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{font-size:11px}ion-tab-button[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%]{position:absolute;top:4px;right:calc(50% - 20px);font-size:10px;padding:2px 6px;min-width:18px;height:18px}"]}))}return t(),n})();var p=e(2615);const u=[{path:"",component:v,children:[{path:"projects",loadChildren:()=>Promise.all([e.e(2076),e.e(1707)]).then(e.bind(e,1707)).then(t=>t.ProjectsPageModule)},{path:"camera",loadChildren:()=>Promise.all([e.e(2076),e.e(9361)]).then(e.bind(e,9361)).then(t=>t.CameraPageModule)},{path:"catastro",loadChildren:()=>Promise.all([e.e(9721),e.e(2076),e.e(3408)]).then(e.bind(e,3408)).then(t=>t.CatastroPageModule)},{path:"settings",loadChildren:()=>Promise.all([e.e(2076),e.e(5371)]).then(e.bind(e,5371)).then(t=>t.SettingsPageModule)},{path:"mediciones",loadChildren:()=>e.e(2076).then(e.bind(e,4034)).then(t=>t.MedicionesPageModule)},{path:"",redirectTo:"projects",pathMatch:"full"}]}];let l=(()=>{var t;class n{static#t=t=()=>(this.\u0275fac=function(o){return new(o||n)},this.\u0275mod=i.$C({type:n}),this.\u0275inj=p.G2t({imports:[g.iI.forChild(u),g.iI]}))}return t(),n})(),S=(()=>{var t;class n{static#t=t=()=>(this.\u0275fac=function(o){return new(o||n)},this.\u0275mod=i.$C({type:n}),this.\u0275inj=p.G2t({imports:[c.MD,b.YN,d.bv,l]}))}return t(),n})()}}]);