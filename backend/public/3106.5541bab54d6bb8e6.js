"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3106],{3106:(U,m,n)=>{n.r(m),n.d(m,{TabsPageModule:()=>N});var h=n(2200),I=n(4341),d=n(7343),b=n(8132),f=n(467),S=n(3888),P=n(1985),L=n(9470),O=n(8211);const e=(0,n(5083).F3)("App",{web:()=>n.e(9303).then(n.bind(n,9303)).then(i=>new i.AppWeb)});var t=n(3664),s=n(6386),l=n(8245),a=n(4796),y=n(5032),v=n(1924);function C(i,r){1&i&&t.nrm(0,"ion-icon",9)}function F(i,r){1&i&&t.nrm(0,"ion-icon",9)}function M(i,r){if(1&i&&(t.j41(0,"ion-badge",10),t.EFF(1),t.k0s()),2&i){const T=t.XpG();t.R7$(),t.JRh(T.pendingSync)}}let D=(()=>{var i;class r{constructor(o,c,u,A,E,G){this.syncService=o,this.licenseService=c,this.authService=u,this.alertController=A,this.router=E,this.platform=G,this.pendingSync=0,this.hasLicense=!1,this.licenseChecked=!1,this.licenseSub=null,this.refreshInterval=null,this.appStateListener=null}ngOnInit(){var o=this;return(0,f.A)(function*(){o.syncService.getPendingCount().then(c=>{o.pendingSync=c}),o.licenseSub=o.licenseService.licenseStatus$.subscribe(c=>{o.hasLicense=c.hasValidLicense,o.licenseChecked=!0}),yield o.checkLicense(),o.refreshInterval=function g(i=0,r=S.E){return i<0&&(i=0),function p(i=0,r,T=S.b){let o=-1;return null!=r&&((0,L.m)(r)?T=r:o=r),new P.c(c=>{let u=(0,O.v)(i)?+i-T.now():i;u<0&&(u=0);let A=0;return T.schedule(function(){c.closed||(c.next(A++),0<=o?this.schedule(void 0,o):c.complete())},u)})}(i,i,r)}(3e4).subscribe(()=>{o.checkLicense()}),o.appStateListener=yield e.addListener("appStateChange",function(){var c=(0,f.A)(function*({isActive:u}){u&&(yield o.checkLicense())});return function(u){return c.apply(this,arguments)}}())})()}ngOnDestroy(){this.licenseSub&&this.licenseSub.unsubscribe(),this.refreshInterval&&this.refreshInterval.unsubscribe(),this.appStateListener&&this.appStateListener.remove()}checkLicense(){var o=this;return(0,f.A)(function*(){o.authService.isAuthenticated&&(yield o.licenseService.checkLicenseStatus())})()}onTabClick(o,c){var u=this;return(0,f.A)(function*(){"settings"===c||u.hasLicense||(o.preventDefault(),o.stopPropagation(),yield(yield u.alertController.create({header:"Licencia requerida",message:"Para acceder a esta funcion necesitas activar una licencia. Ve a Configuracion para activar o comprar una licencia.",buttons:[{text:"Cancelar",role:"cancel"},{text:"Ir a Config",handler:()=>{u.router.navigate(["/tabs/settings"])}}]})).present())})()}static#t=i=()=>(this.\u0275fac=function(c){return new(c||r)(t.rXU(s.H),t.rXU(l.X),t.rXU(a.u),t.rXU(d.hG),t.rXU(v.Ix),t.rXU(y.OD))},this.\u0275cmp=t.VBU({type:r,selectors:[["app-tabs"]],standalone:!1,decls:17,vars:7,consts:[["slot","bottom"],["tab","projects",3,"click"],["name","folder-outline"],["name","lock-closed","class","lock-icon",4,"ngIf"],["tab","catastro",3,"click"],["name","globe-outline"],["tab","settings"],["name","cog-outline"],["color","warning",4,"ngIf"],["name","lock-closed",1,"lock-icon"],["color","warning"]],template:function(c,u){1&c&&(t.j41(0,"ion-tabs")(1,"ion-tab-bar",0)(2,"ion-tab-button",1),t.bIt("click",function(E){return u.onTabClick(E,"projects")}),t.nrm(3,"ion-icon",2),t.j41(4,"ion-label"),t.EFF(5,"Proyectos"),t.k0s(),t.DNE(6,C,1,0,"ion-icon",3),t.k0s(),t.j41(7,"ion-tab-button",4),t.bIt("click",function(E){return u.onTabClick(E,"catastro")}),t.nrm(8,"ion-icon",5),t.j41(9,"ion-label"),t.EFF(10,"GeoVisor"),t.k0s(),t.DNE(11,F,1,0,"ion-icon",3),t.k0s(),t.j41(12,"ion-tab-button",6),t.nrm(13,"ion-icon",7),t.j41(14,"ion-label"),t.EFF(15,"Config"),t.k0s(),t.DNE(16,M,2,1,"ion-badge",8),t.k0s()()()),2&c&&(t.R7$(2),t.AVh("disabled-tab",!u.hasLicense&&u.licenseChecked),t.R7$(4),t.Y8G("ngIf",!u.hasLicense&&u.licenseChecked),t.R7$(),t.AVh("disabled-tab",!u.hasLicense&&u.licenseChecked),t.R7$(4),t.Y8G("ngIf",!u.hasLicense&&u.licenseChecked),t.R7$(5),t.Y8G("ngIf",u.pendingSync>0))},dependencies:[h.bT,d.In,d.iq,d.he,d.Jq,d.qW,d.p4],styles:["ion-tab-bar[_ngcontent-%COMP%]{--background: #ffffff;border-top:1px solid #e2e8f0;height:60px;padding-bottom:env(safe-area-inset-bottom)}ion-tab-button[_ngcontent-%COMP%]{--color: #6b7280;--color-selected: #1a5f7a;font-size:11px;font-weight:500;position:relative}ion-tab-button[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:24px;margin-bottom:2px}ion-tab-button[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{font-size:11px}ion-tab-button[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%]{position:absolute;top:4px;right:calc(50% - 20px);font-size:10px;padding:2px 6px;min-width:18px;height:18px}ion-tab-button.disabled-tab[_ngcontent-%COMP%]{--color: #c0c0c0;opacity:.6}ion-tab-button[_ngcontent-%COMP%]   .lock-icon[_ngcontent-%COMP%]{position:absolute;top:2px;right:calc(50% - 24px);font-size:12px;color:#f59e0b}"]}))}return i(),r})();var j=n(2615);let x=(()=>{var i;class r{constructor(o,c,u){this.licenseService=o,this.router=c,this.alertController=u}canActivate(){var o=this;return(0,f.A)(function*(){try{if((yield o.licenseService.checkLicenseStatus()).hasValidLicense)return!0}catch(c){console.error("Error checking license:",c)}return yield o.showNoLicenseAlert(),o.router.createUrlTree(["/tabs/settings"])})()}showNoLicenseAlert(){var o=this;return(0,f.A)(function*(){yield(yield o.alertController.create({header:"Licencia Requerida",message:"Necesitas una licencia activa para acceder a esta funcionalidad. Por favor, activa o compra una licencia.",buttons:["Entendido"],cssClass:"license-alert"})).present()})()}static#t=i=()=>(this.\u0275fac=function(c){return new(c||r)(j.KVO(l.X),j.KVO(v.Ix),j.KVO(d.hG))},this.\u0275prov=j.jDH({token:r,factory:r.\u0275fac,providedIn:"root"}))}return i(),r})();const V=[{path:"",component:D,children:[{path:"projects",loadChildren:()=>Promise.all([n.e(2076),n.e(1707)]).then(n.bind(n,1707)).then(i=>i.ProjectsPageModule),canActivate:[x]},{path:"camera",loadChildren:()=>Promise.all([n.e(2076),n.e(9361)]).then(n.bind(n,9361)).then(i=>i.CameraPageModule),canActivate:[x]},{path:"catastro",loadChildren:()=>Promise.all([n.e(139),n.e(2076),n.e(3408)]).then(n.bind(n,3408)).then(i=>i.CatastroPageModule),canActivate:[x]},{path:"settings",loadChildren:()=>n.e(5371).then(n.bind(n,5371)).then(i=>i.SettingsPageModule)},{path:"mediciones",loadChildren:()=>n.e(2076).then(n.bind(n,4034)).then(i=>i.MedicionesPageModule),canActivate:[x]},{path:"",redirectTo:"settings",pathMatch:"full"}]}];let B=(()=>{var i;class r{static#t=i=()=>(this.\u0275fac=function(c){return new(c||r)},this.\u0275mod=t.$C({type:r}),this.\u0275inj=j.G2t({imports:[b.iI.forChild(V),b.iI]}))}return i(),r})(),N=(()=>{var i;class r{static#t=i=()=>(this.\u0275fac=function(c){return new(c||r)},this.\u0275mod=t.$C({type:r}),this.\u0275inj=j.G2t({imports:[h.MD,I.YN,d.bv,B]}))}return i(),r})()},6386:(U,m,n)=>{n.d(m,{H:()=>O});var h=n(467);const d=(0,n(5083).F3)("Network",{web:()=>n.e(3780).then(n.bind(n,3780)).then(p=>new p.NetworkWeb)});var b=n(4412),f=n(2615),S=n(3366),P=n(7291),L=n(9473);let O=(()=>{var p;class g{constructor(e,t,s){this.api=e,this.storage=t,this.camera=s,this.isOnlineSubject=new b.t(!0),this.isSyncingSubject=new b.t(!1),this.pendingCountSubject=new b.t(0),this.isOnline$=this.isOnlineSubject.asObservable(),this.isSyncing$=this.isSyncingSubject.asObservable(),this.pendingCount$=this.pendingCountSubject.asObservable(),this.syncInProgress=!1,this.initNetworkListener()}initNetworkListener(){var e=this;return(0,h.A)(function*(){const t=yield d.getStatus();e.isOnlineSubject.next(t.connected),d.addListener("networkStatusChange",function(){var s=(0,h.A)(function*(l){e.isOnlineSubject.next(l.connected),l.connected&&!e.syncInProgress&&(yield e.syncPending())});return function(l){return s.apply(this,arguments)}}()),yield e.updatePendingCount()})()}updatePendingCount(){var e=this;return(0,h.A)(function*(){const t=yield e.storage.getPendingSyncCount();e.pendingCountSubject.next(t)})()}queueForSync(e,t,s,l){var a=this;return(0,h.A)(function*(){const y={id:a.storage.generateId(),action:e,entity:t,entityId:s,data:l,createdAt:new Date,attempts:0,status:"pending"};yield a.storage.addToSyncQueue(y),yield a.updatePendingCount(),a.isOnlineSubject.value&&!a.syncInProgress&&(yield a.syncPending())})()}syncPending(){var e=this;return(0,h.A)(function*(){if(!e.syncInProgress&&e.isOnlineSubject.value){e.syncInProgress=!0,e.isSyncingSubject.next(!0);try{const s=(yield e.storage.getSyncQueue()).filter(l=>"pending"===l.status&&l.attempts<3);if(0===s.length)return;for(const l of s)try{yield e.syncItem(l),yield e.storage.removeFromSyncQueue(l.id)}catch(a){l.attempts++,l.lastAttempt=new Date,l.error=a instanceof Error?a.message:"Error desconocido",l.attempts>=3&&(l.status="error"),yield e.storage.updateSyncQueueItem(l)}}finally{e.syncInProgress=!1,e.isSyncingSubject.next(!1),yield e.updatePendingCount()}}})()}syncItem(e){var t=this;return(0,h.A)(function*(){switch(e.entity){case"project":yield t.syncProject(e);break;case"photo":yield t.syncPhoto(e)}})()}syncProject(e){var t=this;return(0,h.A)(function*(){switch(e.action){case"CREATE":const s=yield t.api.post("/projects",e.data).toPromise();if(s&&s.project&&s.project.id){const a=(yield t.storage.getProjects()).find(y=>y.id===e.entityId);a&&(a.serverId=s.project.id,a.synced=!0,yield t.storage.saveProject(a),console.log("Proyecto sincronizado con serverId:",s.project.id))}break;case"UPDATE":yield t.api.put(`/projects/${e.entityId}`,e.data).toPromise();break;case"DELETE":yield t.api.delete(`/projects/${e.entityId}`).toPromise()}})()}syncPhoto(e){var t=this;return(0,h.A)(function*(){switch(e.action){case"CREATE":const s=yield t.storage.getPhoto(e.entityId);if(s&&s.localPath){const l=yield t.camera.getPhotoBase64(s.localPath),a=new FormData,y=t.base64ToBlob(l,"image/jpeg");a.append("file",y,"photo.jpg"),a.append("projectId",s.projectId),a.append("latitude",s.latitude.toString()),a.append("longitude",s.longitude.toString()),s.altitude&&a.append("altitude",s.altitude.toString()),s.accuracy&&a.append("accuracy",s.accuracy.toString()),s.notes&&a.append("notes",s.notes);const v=yield t.api.uploadFile("/photos",a).toPromise();v&&v.photo&&(s.imageUrl=v.photo.imageUrl,s.synced=!0,yield t.storage.savePhoto(s))}break;case"UPDATE":yield t.api.put(`/photos/${e.entityId}`,e.data).toPromise();break;case"DELETE":yield t.api.delete(`/photos/${e.entityId}`).toPromise()}})()}base64ToBlob(e,t){const s=atob(e),l=[];for(let a=0;a<s.length;a+=512){const y=s.slice(a,a+512),v=new Array(y.length);for(let C=0;C<y.length;C++)v[C]=y.charCodeAt(C);l.push(new Uint8Array(v))}return new Blob(l,{type:t})}get isOnline(){return this.isOnlineSubject.value}get isSyncing(){return this.isSyncingSubject.value}getPendingCount(){var e=this;return(0,h.A)(function*(){return yield e.storage.getPendingSyncCount()})()}syncAll(){var e=this;return(0,h.A)(function*(){yield e.syncPending()})()}static#t=p=()=>(this.\u0275fac=function(t){return new(t||g)(f.KVO(S.G),f.KVO(P.n),f.KVO(L.j))},this.\u0275prov=f.jDH({token:g,factory:g.\u0275fac,providedIn:"root"}))}return p(),g})()},8245:(U,m,n)=>{n.d(m,{X:()=>O});var h=n(467),I=n(4412),d=n(4843),b=n(5312);const S=(0,n(5083).F3)("Browser",{web:()=>n.e(4786).then(n.bind(n,4786)).then(p=>new p.BrowserWeb)});var P=n(2615),L=n(9330);let O=(()=>{var p;class g{constructor(e){this.http=e,this.apiUrl=b.c.apiUrl,this.licenseStatusSubject=new I.t({hasValidLicense:!1,license:null}),this.licenseStatus$=this.licenseStatusSubject.asObservable()}checkLicenseStatus(){var e=this;return(0,h.A)(function*(){try{const t=yield(0,d._)(e.http.get(`${e.apiUrl}/licenses/status`));return e.licenseStatusSubject.next(t),t}catch(t){console.error("Error checking license status:",t);const s={hasValidLicense:!1,license:null};return e.licenseStatusSubject.next(s),s}})()}getCurrentStatus(){return this.licenseStatusSubject.value}hasValidLicense(){return this.licenseStatusSubject.value.hasValidLicense}activateLicense(e){var t=this;return(0,h.A)(function*(){const s=yield(0,d._)(t.http.post(`${t.apiUrl}/licenses/activate`,{licenseKey:e}));return yield t.checkLicenseStatus(),s})()}getLicenseTypes(){var e=this;return(0,h.A)(function*(){return(0,d._)(e.http.get(`${e.apiUrl}/licenses/types`))})()}createPaymentOrder(e){var t=this;return(0,h.A)(function*(){return(0,d._)(t.http.post(`${t.apiUrl}/payments/create-order`,{licenseTypeId:e}))})()}purchaseLicense(e){var t=this;return(0,h.A)(function*(){const s=yield t.createPaymentOrder(e);s.approvalUrl&&(yield S.open({url:s.approvalUrl}))})()}capturePayment(e){var t=this;return(0,h.A)(function*(){const s=yield(0,d._)(t.http.post(`${t.apiUrl}/payments/capture`,{orderId:e}));return yield t.checkLicenseStatus(),s})()}getPaymentHistory(){var e=this;return(0,h.A)(function*(){return(0,d._)(e.http.get(`${e.apiUrl}/payments/history`))})()}formatPrice(e){return new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(e)}formatDaysRemaining(e){return e<=0?"Expirada":1===e?"1 dia restante":`${e} dias restantes`}static#t=p=()=>(this.\u0275fac=function(t){return new(t||g)(P.KVO(L.Qq))},this.\u0275prov=P.jDH({token:g,factory:g.\u0275fac,providedIn:"root"}))}return p(),g})()}}]);