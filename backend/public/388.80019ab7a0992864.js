"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[388,7291],{1889:(A,E,p)=>{p.d(E,{Wi:()=>d,__:()=>i});var i=function(l){return l.Documents="DOCUMENTS",l.Data="DATA",l.Library="LIBRARY",l.Cache="CACHE",l.External="EXTERNAL",l.ExternalStorage="EXTERNAL_STORAGE",l.ExternalCache="EXTERNAL_CACHE",l.LibraryNoCloud="LIBRARY_NO_CLOUD",l.Temporary="TEMPORARY",l}(i||{}),d=function(l){return l.UTF8="utf8",l.ASCII="ascii",l.UTF16="utf16",l}(d||{})},2739:(A,E,p)=>{p.d(E,{YA:()=>v,__:()=>y.__});var i=p(5083),d=p(5873),y=p(1889);const v=(0,i.F3)("Filesystem",{web:()=>p.e(2937).then(p.bind(p,2937)).then(l=>new l.FilesystemWeb)});(0,d.Y)()},3366:(A,E,p)=>{p.d(E,{G:()=>v});var i=p(9330),d=p(5312),y=p(2615);let v=(()=>{var l;class m{constructor(u){this.http=u,this.baseUrl=d.c.apiUrl}getHeaders(){const u=localStorage.getItem("token");let f=new i.Lr({"Content-Type":"application/json"});return u&&(f=f.set("Authorization",`Bearer ${u}`)),f}get(u){return this.http.get(`${this.baseUrl}${u}`,{headers:this.getHeaders()})}post(u,f){return this.http.post(`${this.baseUrl}${u}`,f,{headers:this.getHeaders()})}put(u,f){return this.http.put(`${this.baseUrl}${u}`,f,{headers:this.getHeaders()})}delete(u){return this.http.delete(`${this.baseUrl}${u}`,{headers:this.getHeaders()})}uploadFile(u,f){const g=localStorage.getItem("token");let b=new i.Lr;return g&&(b=b.set("Authorization",`Bearer ${g}`)),this.http.post(`${this.baseUrl}${u}`,f,{headers:b})}createReport(u,f,g){return this.post("/reports",{projectId:u,name:f,htmlContent:g})}getReportsByProject(u){return this.get(`/reports/project/${u}`)}getReport(u){return this.get(`/reports/${u}`)}deleteReport(u){return this.delete(`/reports/${u}`)}createKml(u,f,g){return this.post("/reports/kml",{projectId:u,name:f,kmlContent:g})}getKmlsByProject(u){return this.get(`/reports/kml/project/${u}`)}getKml(u){return this.get(`/reports/kml/${u}`)}deleteKml(u){return this.delete(`/reports/kml/${u}`)}static#e=l=()=>(this.\u0275fac=function(f){return new(f||m)(y.KVO(i.Qq))},this.\u0275prov=y.jDH({token:m,factory:m.\u0275fac,providedIn:"root"}))}return l(),m})()},4843:(A,E,p)=>{p.d(E,{_:()=>y});var i=p(9350),d=p(7707);function y(v,l){const m="object"==typeof l;return new Promise((_,u)=>{const f=new d.Ms({next:g=>{_(g),f.unsubscribe()},error:u,complete:()=>{m?_(l.defaultValue):u(new i.G)}});v.subscribe(f)})}},5873:(A,E,p)=>{p.d(E,{Y:()=>v});var i=p(467);function v(l=!1){typeof window>"u"||(window.CapacitorUtils=window.CapacitorUtils||{},void 0===window.Capacitor||l?void 0!==window.cordova&&function y(l){l.CapacitorUtils.Synapse=new Proxy({},{get:(m,_)=>l.cordova.plugins[_]})}(window):function d(l){l.CapacitorUtils.Synapse=new Proxy({},{get:(m,_)=>new Proxy({},{get:(u,f)=>(g,b,r)=>{const e=l.Capacitor.Plugins[_];void 0!==e?"function"==typeof e[f]?(0,i.A)(function*(){try{const o=yield e[f](g);b(o)}catch(o){r(o)}})():r(new Error(`Method ${f} not found in Capacitor plugin ${_}`)):r(new Error(`Capacitor plugin ${_} not found`))}})})}(window))}},7291:(A,E,p)=>{p.d(E,{n:()=>u});var i=p(467),d=p(8254),y=p(2615);const m="photos",_="projects";let u=(()=>{var f;class g{constructor(){this.SYNC_QUEUE_KEY="geotech_sync_queue",this.MEASUREMENTS_KEY="geotech_measurements",this.db=null,this.dbReady=null,this.dbReady=this.initIndexedDB()}initIndexedDB(){var r=this;return(0,i.A)(function*(){return r.db?r.db:new Promise((e,o)=>{const t=indexedDB.open("geotech_db",2);t.onerror=()=>{console.error("Error opening IndexedDB:",t.error),o(t.error)},t.onsuccess=()=>{r.db=t.result,e(r.db)},t.onupgradeneeded=n=>{const a=n.target.result;a.objectStoreNames.contains(m)||a.createObjectStore(m,{keyPath:"id"}).createIndex("projectId","projectId",{unique:!1}),a.objectStoreNames.contains(_)||a.createObjectStore(_,{keyPath:"id"})}})})()}getDB(){var r=this;return(0,i.A)(function*(){return r.db?r.db:r.dbReady?r.dbReady:r.initIndexedDB()})()}getProjects(){var r=this;return(0,i.A)(function*(){try{const e=yield r.getDB();return new Promise((o,t)=>{const s=e.transaction([_],"readonly").objectStore(_).getAll();s.onsuccess=()=>o(s.result||[]),s.onerror=()=>t(s.error)})}catch(e){return console.error("Error getting projects from IndexedDB:",e),r.getProjectsFromPreferences()}})()}getProjectsFromPreferences(){return(0,i.A)(function*(){const{value:r}=yield d.p.get({key:"geotech_projects"});return r?JSON.parse(r):[]})()}setProjects(r){var e=this;return(0,i.A)(function*(){try{const n=(yield e.getDB()).transaction([_],"readwrite").objectStore(_);n.clear();for(const a of r)n.put(a)}catch(o){console.error("Error setting projects:",o)}})()}saveProject(r){var e=this;return(0,i.A)(function*(){try{const o=yield e.getDB();return new Promise((t,n)=>{const c=o.transaction([_],"readwrite").objectStore(_).put(r);c.onsuccess=()=>t(),c.onerror=()=>n(c.error)})}catch(o){throw console.error("Error saving project:",o),o}})()}deleteProject(r){var e=this;return(0,i.A)(function*(){try{const o=yield e.getDB();yield new Promise((n,a)=>{const h=o.transaction([_],"readwrite").objectStore(_).delete(r);h.onsuccess=()=>n(),h.onerror=()=>a(h.error)});const t=yield e.getPhotos(r);for(const n of t)yield e.deletePhoto(n.id)}catch(o){console.error("Error deleting project:",o)}})()}getProject(r){var e=this;return(0,i.A)(function*(){try{const o=yield e.getDB();return new Promise((t,n)=>{const c=o.transaction([_],"readonly").objectStore(_).get(r);c.onsuccess=()=>t(c.result),c.onerror=()=>n(c.error)})}catch(o){return void console.error("Error getting project:",o)}})()}getPhotos(r){var e=this;return(0,i.A)(function*(){try{const o=yield e.getDB();return new Promise((t,n)=>{const s=o.transaction([m],"readonly").objectStore(m);if(r){const h=s.index("projectId").getAll(r);h.onsuccess=()=>t(h.result||[]),h.onerror=()=>n(h.error)}else{const c=s.getAll();c.onsuccess=()=>t(c.result||[]),c.onerror=()=>n(c.error)}})}catch(o){return console.error("Error getting photos:",o),[]}})()}savePhoto(r){var e=this;return(0,i.A)(function*(){try{const o=yield e.getDB();return new Promise((t,n)=>{const c=o.transaction([m],"readwrite").objectStore(m).put(r);c.onsuccess=()=>t(),c.onerror=()=>{console.error("Error saving photo:",c.error),n(c.error)}})}catch(o){throw console.error("Error saving photo to IndexedDB:",o),o}})()}addPhoto(r){var e=this;return(0,i.A)(function*(){yield e.savePhoto(r)})()}updatePhoto(r){var e=this;return(0,i.A)(function*(){yield e.savePhoto(r)})()}deletePhoto(r){var e=this;return(0,i.A)(function*(){try{const o=yield e.getDB();return new Promise((t,n)=>{const c=o.transaction([m],"readwrite").objectStore(m).delete(r);c.onsuccess=()=>t(),c.onerror=()=>n(c.error)})}catch(o){console.error("Error deleting photo:",o)}})()}getPhoto(r){var e=this;return(0,i.A)(function*(){try{const o=yield e.getDB();return new Promise((t,n)=>{const c=o.transaction([m],"readonly").objectStore(m).get(r);c.onsuccess=()=>t(c.result),c.onerror=()=>n(c.error)})}catch(o){return void console.error("Error getting photo:",o)}})()}getSyncQueue(){var r=this;return(0,i.A)(function*(){const{value:e}=yield d.p.get({key:r.SYNC_QUEUE_KEY});return e?JSON.parse(e):[]})()}addToSyncQueue(r){var e=this;return(0,i.A)(function*(){const o=yield e.getSyncQueue();o.push(r),yield d.p.set({key:e.SYNC_QUEUE_KEY,value:JSON.stringify(o)})})()}updateSyncQueueItem(r){var e=this;return(0,i.A)(function*(){const o=yield e.getSyncQueue(),t=o.findIndex(n=>n.id===r.id);t>=0&&(o[t]=r,yield d.p.set({key:e.SYNC_QUEUE_KEY,value:JSON.stringify(o)}))})()}removeFromSyncQueue(r){var e=this;return(0,i.A)(function*(){const t=(yield e.getSyncQueue()).filter(n=>n.id!==r);yield d.p.set({key:e.SYNC_QUEUE_KEY,value:JSON.stringify(t)})})()}clearSyncQueue(){var r=this;return(0,i.A)(function*(){yield d.p.set({key:r.SYNC_QUEUE_KEY,value:JSON.stringify([])})})()}getPendingSyncCount(){var r=this;return(0,i.A)(function*(){return(yield r.getSyncQueue()).filter(o=>"pending"===o.status).length})()}generateId(){return"local_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}clearAll(){var r=this;return(0,i.A)(function*(){yield d.p.clear();try{const o=(yield r.getDB()).transaction([m,_],"readwrite");o.objectStore(m).clear(),o.objectStore(_).clear()}catch(e){console.error("Error clearing IndexedDB:",e)}})()}clear(){var r=this;return(0,i.A)(function*(){yield r.clearAll()})()}getMeasurements(){var r=this;return(0,i.A)(function*(){const{value:e}=yield d.p.get({key:r.MEASUREMENTS_KEY});return e?JSON.parse(e):[]})()}saveMeasurement(r){var e=this;return(0,i.A)(function*(){const o=yield e.getMeasurements(),t=o.findIndex(n=>n.id===r.id);t>=0?o[t]=r:o.unshift(r),yield d.p.set({key:e.MEASUREMENTS_KEY,value:JSON.stringify(o)})})()}deleteMeasurement(r){var e=this;return(0,i.A)(function*(){const t=(yield e.getMeasurements()).filter(n=>n.id!==r);yield d.p.set({key:e.MEASUREMENTS_KEY,value:JSON.stringify(t)})})()}clearMeasurements(){var r=this;return(0,i.A)(function*(){yield d.p.set({key:r.MEASUREMENTS_KEY,value:JSON.stringify([])})})()}migrateToIndexedDB(){var r=this;return(0,i.A)(function*(){try{const{value:e}=yield d.p.get({key:"geotech_projects"});if(e){const t=JSON.parse(e);if(t.length>0){console.log(`Migrando ${t.length} proyectos a IndexedDB...`);for(const n of t)yield r.saveProject(n);yield d.p.remove({key:"geotech_projects"}),console.log("Proyectos migrados")}}const{value:o}=yield d.p.get({key:"geotech_photos"});if(o){const t=JSON.parse(o);if(t.length>0){console.log(`Migrando ${t.length} fotos a IndexedDB...`);for(const n of t)yield r.savePhoto(n);yield d.p.remove({key:"geotech_photos"}),console.log("Fotos migradas")}}}catch(e){console.error("Error durante migraci\xf3n:",e)}})()}static#e=f=()=>(this.\u0275fac=function(e){return new(e||g)},this.\u0275prov=y.jDH({token:g,factory:g.\u0275fac,providedIn:"root"}))}return f(),g})()},9473:(A,E,p)=>{p.d(E,{j:()=>b});var i=p(467),d=p(5083),y=function(r){return r.Prompt="PROMPT",r.Camera="CAMERA",r.Photos="PHOTOS",r}(y||{}),v=function(r){return r.Rear="REAR",r.Front="FRONT",r}(v||{}),l=function(r){return r.Uri="uri",r.Base64="base64",r.DataUrl="dataUrl",r}(l||{});class m extends d.E_{getPhoto(e){var o=this;return(0,i.A)(function*(){return new Promise(function(){var t=(0,i.A)(function*(n,a){if(e.webUseInput||e.source===y.Photos)o.fileInputExperience(e,n,a);else if(e.source===y.Prompt){let s=document.querySelector("pwa-action-sheet");s||(s=document.createElement("pwa-action-sheet"),document.body.appendChild(s)),s.header=e.promptLabelHeader||"Photo",s.cancelable=!1,s.options=[{title:e.promptLabelPhoto||"From Photos"},{title:e.promptLabelPicture||"Take Picture"}],s.addEventListener("onSelection",function(){var c=(0,i.A)(function*(h){0===h.detail?o.fileInputExperience(e,n,a):o.cameraExperience(e,n,a)});return function(h){return c.apply(this,arguments)}}())}else o.cameraExperience(e,n,a)});return function(n,a){return t.apply(this,arguments)}}())})()}pickImages(e){var o=this;return(0,i.A)(function*(){return new Promise(function(){var t=(0,i.A)(function*(n,a){o.multipleFileInputExperience(n,a)});return function(n,a){return t.apply(this,arguments)}}())})()}cameraExperience(e,o,t){var n=this;return(0,i.A)(function*(){if(customElements.get("pwa-camera-modal")){const a=document.createElement("pwa-camera-modal");a.facingMode=e.direction===v.Front?"user":"environment",document.body.appendChild(a);try{yield a.componentOnReady(),a.addEventListener("onPhoto",function(){var s=(0,i.A)(function*(c){const h=c.detail;null===h?t(new d.I9("User cancelled photos app")):h instanceof Error?t(h):o(yield n._getCameraPhoto(h,e)),a.dismiss(),document.body.removeChild(a)});return function(c){return s.apply(this,arguments)}}()),a.present()}catch{n.fileInputExperience(e,o,t)}}else console.error("Unable to load PWA Element 'pwa-camera-modal'. See the docs: https://capacitorjs.com/docs/web/pwa-elements."),n.fileInputExperience(e,o,t)})()}fileInputExperience(e,o,t){let n=document.querySelector("#_capacitor-camera-input");const a=()=>{var s;null===(s=n.parentNode)||void 0===s||s.removeChild(n)};n||(n=document.createElement("input"),n.id="_capacitor-camera-input",n.type="file",n.hidden=!0,document.body.appendChild(n),n.addEventListener("change",s=>{const c=n.files[0];let h="jpeg";if("image/png"===c.type?h="png":"image/gif"===c.type&&(h="gif"),"dataUrl"===e.resultType||"base64"===e.resultType){const P=new FileReader;P.addEventListener("load",()=>{if("dataUrl"===e.resultType)o({dataUrl:P.result,format:h});else if("base64"===e.resultType){const w=P.result.split(",")[1];o({base64String:w,format:h})}a()}),P.readAsDataURL(c)}else o({webPath:URL.createObjectURL(c),format:h}),a()}),n.addEventListener("cancel",s=>{t(new d.I9("User cancelled photos app")),a()})),n.accept="image/*",n.capture=!0,e.source===y.Photos||e.source===y.Prompt?n.removeAttribute("capture"):e.direction===v.Front?n.capture="user":e.direction===v.Rear&&(n.capture="environment"),n.click()}multipleFileInputExperience(e,o){let t=document.querySelector("#_capacitor-camera-input-multiple");const n=()=>{var a;null===(a=t.parentNode)||void 0===a||a.removeChild(t)};t||(t=document.createElement("input"),t.id="_capacitor-camera-input-multiple",t.type="file",t.hidden=!0,t.multiple=!0,document.body.appendChild(t),t.addEventListener("change",a=>{const s=[];for(let c=0;c<t.files.length;c++){const h=t.files[c];let P="jpeg";"image/png"===h.type?P="png":"image/gif"===h.type&&(P="gif"),s.push({webPath:URL.createObjectURL(h),format:P})}e({photos:s}),n()}),t.addEventListener("cancel",a=>{o(new d.I9("User cancelled photos app")),n()})),t.accept="image/*",t.click()}_getCameraPhoto(e,o){return new Promise((t,n)=>{const a=new FileReader,s=e.type.split("/")[1];"uri"===o.resultType?t({webPath:URL.createObjectURL(e),format:s,saved:!1}):(a.readAsDataURL(e),a.onloadend=()=>{const c=a.result;t("dataUrl"===o.resultType?{dataUrl:c,format:s,saved:!1}:{base64String:c.split(",")[1],format:s,saved:!1})},a.onerror=c=>{n(c)})})}checkPermissions(){var e=this;return(0,i.A)(function*(){if(typeof navigator>"u"||!navigator.permissions)throw e.unavailable("Permissions API not available in this browser");try{return{camera:(yield window.navigator.permissions.query({name:"camera"})).state,photos:"granted"}}catch{throw e.unavailable("Camera permissions are not available in this browser")}})()}requestPermissions(){var e=this;return(0,i.A)(function*(){throw e.unimplemented("Not implemented on web.")})()}pickLimitedLibraryPhotos(){var e=this;return(0,i.A)(function*(){throw e.unavailable("Not implemented on web.")})()}getLimitedLibraryPhotos(){var e=this;return(0,i.A)(function*(){throw e.unavailable("Not implemented on web.")})()}}new m;const u=(0,d.F3)("Camera",{web:()=>new m});var f=p(2739),g=p(2615);let b=(()=>{var r;class e{constructor(){}takePhoto(){var t=this;return(0,i.A)(function*(){if(!d.Ii.isNativePlatform())return t.takeWebPhoto();const n=yield u.getPhoto({resultType:l.Uri,source:y.Camera,quality:90,width:1920,height:1080,correctOrientation:!0,saveToGallery:!1});return yield t.savePicture(n)})()}takeWebPhoto(){var t=this;return new Promise((n,a)=>{const s=document.createElement("input");s.type="file",s.accept="image/*",s.capture="environment",s.style.cssText="position: fixed; top: -100px; left: -100px; opacity: 0; pointer-events: none;",document.body.appendChild(s),s.addEventListener("change",(0,i.A)(function*(){const c=s.files?.[0];if(document.body.removeChild(s),c)try{const h=yield t.fileToBase64(c),P=URL.createObjectURL(c);n({filepath:"web_"+Date.now()+".jpeg",webviewPath:P,webPath:P,base64:h})}catch(h){a(h)}else a(new Error("No se selecciono ninguna imagen"))})),s.addEventListener("cancel",()=>{document.body.removeChild(s),a(new Error("Captura cancelada"))}),s.click()})}fileToBase64(t){return new Promise((n,a)=>{const s=new FileReader;s.onerror=a,s.onload=()=>{const h=s.result.split(",")[1];n(h)},s.readAsDataURL(t)})}pickFromGallery(){var t=this;return(0,i.A)(function*(){if(!d.Ii.isNativePlatform())return t.takeWebPhoto();const n=yield u.getPhoto({resultType:l.Uri,source:y.Photos,quality:90,width:1920,height:1080,correctOrientation:!0});return yield t.savePicture(n)})()}savePicture(t){var n=this;return(0,i.A)(function*(){const a=yield n.readAsBase64(t),s="geotech_"+(new Date).getTime()+".jpeg";return{filepath:(yield f.YA.writeFile({path:"photos/"+s,data:a,directory:f.__.Data,recursive:!0})).uri,webviewPath:t.webPath||"",webPath:t.webPath||"",base64:a}})()}readAsBase64(t){var n=this;return(0,i.A)(function*(){const s=yield(yield fetch(t.webPath)).blob();return yield n.convertBlobToBase64(s)})()}convertBlobToBase64(t){return new Promise((n,a)=>{const s=new FileReader;s.onerror=a,s.onload=()=>{const h=s.result.split(",")[1];n(h)},s.readAsDataURL(t)})}deletePhoto(t){return(0,i.A)(function*(){try{yield f.YA.deleteFile({path:t,directory:f.__.Data})}catch(n){console.error("Error deleting photo:",n)}})()}getPhotoBase64(t){return(0,i.A)(function*(){return(yield f.YA.readFile({path:t,directory:f.__.Data})).data})()}static#e=r=()=>(this.\u0275fac=function(n){return new(n||e)},this.\u0275prov=g.jDH({token:e,factory:e.\u0275fac,providedIn:"root"}))}return r(),e})()}}]);