"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4125],{4125:(de,I,y)=>{y.r(I),y.d(I,{ProjectEditorPageModule:()=>ce});var C=y(2200),O=y(4341),j=y(7343),E=y(8132),p=y(467),b=y(4843),P=y(8244),S=y(3587),o=y(3664),m=y(2615),D=y(1782),A=y(5032),$=y(345),T=y(7291),R=y(2092),z=y(9473),L=y(772),F=y(8426),G=y(6382),N=y(3366);const B=["hiddenPhotoInput"],U=["galleryPhotoInput"],V=["quickCameraInput"];function X(g,v){if(1&g&&(o.j41(0,"span"),o.EFF(1),o.k0s()),2&g){const h=o.XpG(2);o.R7$(),o.SpI("Dibujando zona (",h.currentPoints.length," puntos)")}}function K(g,v){if(1&g&&(o.j41(0,"span"),o.EFF(1),o.k0s()),2&g){const h=o.XpG(2);o.R7$(),o.SpI("Trazando vial (",h.currentPoints.length," puntos)")}}function H(g,v){1&g&&(o.j41(0,"span"),o.EFF(1,"Toca para colocar punto"),o.k0s())}function W(g,v){if(1&g){const h=o.RV6();o.j41(0,"ion-button",35),o.bIt("click",function(){m.eBV(h);const t=o.XpG(2);return m.Njj(t.finishDrawing())}),o.nrm(1,"ion-icon",36),o.EFF(2," Guardar "),o.k0s()}if(2&g){const h=o.XpG(2);o.Y8G("disabled",h.currentPoints.length<2)}}function Y(g,v){if(1&g){const h=o.RV6();o.j41(0,"div",26)(1,"div",27),o.DNE(2,X,2,1,"span",28)(3,K,2,1,"span",28)(4,H,2,0,"span",28),o.k0s(),o.j41(5,"div",29)(6,"ion-button",30),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.undoLastPoint())}),o.nrm(7,"ion-icon",31),o.EFF(8," Deshacer "),o.k0s(),o.j41(9,"ion-button",32),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.cancelDrawing())}),o.nrm(10,"ion-icon",33),o.EFF(11," Cancelar "),o.k0s(),o.DNE(12,W,3,1,"ion-button",34),o.k0s()()}if(2&g){const h=o.XpG();o.R7$(2),o.Y8G("ngIf","zone"===h.drawMode),o.R7$(),o.Y8G("ngIf","path"===h.drawMode),o.R7$(),o.Y8G("ngIf","marker"===h.drawMode),o.R7$(2),o.Y8G("disabled",0===h.currentPoints.length),o.R7$(6),o.Y8G("ngIf","marker"!==h.drawMode)}}function Z(g,v){if(1&g){const h=o.RV6();o.j41(0,"div",37)(1,"ion-button",38),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.setDrawMode("zone"))}),o.nrm(2,"ion-icon",39),o.k0s(),o.j41(3,"ion-button",40),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.setDrawMode("path"))}),o.nrm(4,"ion-icon",41),o.k0s(),o.j41(5,"ion-button",42),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.setDrawMode("marker"))}),o.nrm(6,"ion-icon",43),o.k0s(),o.j41(7,"ion-button",44),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.importPhotosFromGallery())}),o.nrm(8,"ion-icon",45),o.k0s(),o.j41(9,"ion-button",46),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.takeQuickPhoto())}),o.nrm(10,"ion-icon",47),o.k0s()()}}function J(g,v){1&g&&o.nrm(0,"ion-spinner",51)}function Q(g,v){1&g&&o.nrm(0,"ion-icon",52)}function q(g,v){if(1&g){const h=o.RV6();o.j41(0,"ion-button",48),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.exportToWord())}),o.DNE(1,J,1,0,"ion-spinner",49)(2,Q,1,0,"ion-icon",50),o.EFF(3),o.k0s()}if(2&g){const h=o.XpG();o.Y8G("disabled",h.isGeneratingPDD),o.R7$(),o.Y8G("ngIf",h.isGeneratingPDD),o.R7$(),o.Y8G("ngIf",!h.isGeneratingPDD),o.R7$(),o.SpI(" ",h.isGeneratingPDD?"Generando...":"Informe PDD"," ")}}function ee(g,v){if(1&g){const h=o.RV6();o.j41(0,"ion-button",53),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.exportToKMZ())}),o.nrm(1,"ion-icon",54),o.EFF(2," Archivo KML "),o.k0s()}}function te(g,v){if(1&g){const h=o.RV6();o.j41(0,"div",55)(1,"div",56)(2,"h2"),o.EFF(3,"Vista Previa del Informe"),o.k0s(),o.j41(4,"ion-button",57),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.closeReportPreview())}),o.nrm(5,"ion-icon",58),o.k0s()(),o.nrm(6,"div",59),o.j41(7,"div",60)(8,"ion-button",61),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.closeReportPreview())}),o.nrm(9,"ion-icon",62),o.EFF(10," Cancelar "),o.k0s(),o.j41(11,"ion-button",63),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.saveReportToProject())}),o.nrm(12,"ion-icon",64),o.EFF(13," Guardar en Proyecto "),o.k0s()()()}if(2&g){const h=o.XpG();o.R7$(6),o.Y8G("innerHTML",h.reportPreviewHtml,o.npT)}}function oe(g,v){if(1&g&&(o.j41(0,"div",65)(1,"div",66)(2,"div",67),o.nrm(3,"ion-spinner",68),o.k0s(),o.j41(4,"div",69),o.nrm(5,"ion-icon",70),o.k0s(),o.j41(6,"div",71)(7,"span",72),o.EFF(8,"Procesando con IA"),o.k0s(),o.j41(9,"span",73),o.EFF(10),o.k0s()()()()),2&g){const h=o.XpG();o.R7$(10),o.JRh(h.aiLoadingMessage||(h.isAnalyzingPhoto?"Analizando imagen...":"Generando informe..."))}}function ne(g,v){if(1&g&&(o.j41(0,"div",89)(1,"div",90),o.nrm(2,"ion-icon",91),o.EFF(3," Notas"),o.k0s(),o.j41(4,"p"),o.EFF(5),o.k0s()()),2&g){const h=o.XpG(2);o.R7$(5),o.JRh(h.viewerPhoto.notes)}}function re(g,v){if(1&g&&(o.j41(0,"div",92)(1,"div",90),o.nrm(2,"ion-icon",70),o.EFF(3," Analisis IA"),o.k0s(),o.j41(4,"p"),o.EFF(5),o.k0s()()),2&g){const h=o.XpG(2);o.R7$(5),o.JRh(h.viewerPhoto.aiDescription)}}function ie(g,v){if(1&g){const h=o.RV6();o.j41(0,"div",74)(1,"div",75)(2,"div",76)(3,"h3"),o.EFF(4),o.k0s(),o.j41(5,"span"),o.EFF(6),o.nI1(7,"date"),o.k0s()(),o.j41(8,"button",77),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.closePhotoViewer())}),o.nrm(9,"ion-icon",78),o.k0s()(),o.j41(10,"div",79),o.nrm(11,"img",80),o.DNE(12,ne,6,1,"div",81)(13,re,6,1,"div",82),o.k0s(),o.j41(14,"div",83)(15,"button",84),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.editViewerPhotoNotes())}),o.nrm(16,"ion-icon",85),o.EFF(17," Editar "),o.k0s(),o.j41(18,"button",84),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.analyzeViewerPhotoWithAI())}),o.nrm(19,"ion-icon",86),o.EFF(20," IA "),o.k0s(),o.j41(21,"button",87),o.bIt("click",function(){m.eBV(h);const t=o.XpG();return m.Njj(t.deleteViewerPhoto())}),o.nrm(22,"ion-icon",88),o.EFF(23," Eliminar "),o.k0s()()()}if(2&g){const h=o.XpG();o.R7$(4),o.JRh((null==h.viewerMarker?null:h.viewerMarker.name)||"Foto"),o.R7$(2),o.JRh(o.i5U(7,5,h.viewerPhoto.timestamp,"dd/MM/yyyy HH:mm")),o.R7$(5),o.Y8G("src",h.viewerPhoto.imageUrl||h.viewerPhoto.localPath,o.B4B),o.R7$(),o.Y8G("ngIf",h.viewerPhoto.notes),o.R7$(),o.Y8G("ngIf",h.viewerPhoto.aiDescription)}}const ae=[{path:"",component:(()=>{var g;class v{constructor(e,t,n,i,r,a,c,l,s,d,u,_,x){this.route=e,this.navCtrl=t,this.alertCtrl=n,this.toastCtrl=i,this.actionSheetCtrl=r,this.sanitizer=a,this.storageService=c,this.gpsService=l,this.cameraService=s,this.claudeService=d,this.kmlService=u,this.reportService=_,this.apiService=x,this.pendingPhotoMarkerId=null,this.project=null,this.photos=[],this.isGeneratingPDD=!1,this.isAnalyzingPhoto=!1,this.aiLoadingMessage="",this.showReportPreview=!1,this.reportPreviewHtml="",this.reportPreviewRawHtml="",this.pendingReportData=null,this.showPhotoViewer=!1,this.viewerPhoto=null,this.viewerMarker=null,this.drawMode="none",this.currentPoints=[],this.map=null,this.satelliteLayer=null,this.zonesLayer=null,this.pathsLayer=null,this.markersLayer=null,this.drawLayer=null,this.currentDrawing=null}ngOnInit(){var e=this;return(0,p.A)(function*(){const t=e.route.snapshot.paramMap.get("id");t&&(yield e.loadProject(t))})()}ionViewWillEnter(){var e=this;return(0,p.A)(function*(){const t=e.route.snapshot.paramMap.get("id");if(t&&e.project){e.photos=yield e.storageService.getPhotos(t);const n=yield e.storageService.getProject(t);n&&(e.project=n,e.renderProjectElements())}})()}ngOnDestroy(){this.map&&(this.map.remove(),this.map=null)}ionViewDidEnter(){setTimeout(()=>this.initMapWithLocation(),300)}initMapWithLocation(){var e=this;return(0,p.A)(function*(){if((e.project?.markers?.length||0)>0||(e.project?.zones?.length||0)>0||(e.project?.paths?.length||0)>0||e.photos.length>0)e.initMap();else try{const n=yield e.gpsService.getCurrentPosition();e.project&&!e.project.coordinates&&(e.project.coordinates={lat:n.latitude,lng:n.longitude},yield e.saveProject()),e.initMap(n.latitude,n.longitude)}catch{console.log("No se pudo obtener ubicaci\xf3n, usando default"),e.initMap()}})()}loadProject(e){var t=this;return(0,p.A)(function*(){const n=yield t.storageService.getProject(e);if(t.photos=yield t.storageService.getPhotos(e),!n)return t.showToast("Proyecto no encontrado","danger"),void t.navCtrl.back();t.project=n,t.project.zones||(t.project.zones=[]),t.project.paths||(t.project.paths=[]),t.project.markers||(t.project.markers=[]),yield t.ensureMarkerOrders(),t.project.serverId&&t.syncPhotosFromCloud()})()}syncPhotosFromCloud(){var e=this;return(0,p.A)(function*(){if(e.project?.serverId)try{const t=yield(0,b._)(e.apiService.getPhotosByProject(e.project.serverId));if(t?.photos&&Array.isArray(t.photos)){const n=t.photos;console.log("Fotos en servidor:",n.length);const i=new Map;e.photos.forEach(a=>{a.serverId&&i.set(a.serverId,a)});let r=!1;for(const a of n)if(!i.has(a.id)){const c={id:`photo_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,serverId:a.id,projectId:e.project.id,imageUrl:a.imageUrl,thumbnailUrl:a.thumbnailUrl,latitude:parseFloat(a.latitude)||0,longitude:parseFloat(a.longitude)||0,altitude:a.altitude?parseFloat(a.altitude):void 0,notes:a.notes,aiDescription:a.aiDescription,timestamp:a.createdAt,synced:!0};yield e.storageService.savePhoto(c),e.photos.push(c),i.set(a.id,c),r=!0,console.log("Foto descargada del servidor:",a.id)}if(e.project.markers){let a=!1;for(const c of e.project.markers)if(c.serverPhotoIds&&c.serverPhotoIds.length>0){const l=new Set(c.photoIds||[]);for(const s of c.serverPhotoIds){const d=i.get(s);d&&!l.has(d.id)&&(l.add(d.id),a=!0)}a&&(c.photoIds=Array.from(l))}a&&(yield e.saveProject())}r&&e.renderProjectElements()}}catch(t){console.log("Error sincronizando fotos:",t?.message)}})()}ensureMarkerOrders(){var e=this;return(0,p.A)(function*(){if(!e.project?.markers)return;let t=!1,n=0;for(const i of e.project.markers)i.order&&i.order>n&&(n=i.order);for(const i of e.project.markers)i.order||(n++,i.order=n,t=!0);t&&(yield e.saveProject())})()}initMap(e,t){if(this.map||!this.project||!document.getElementById("editorMap"))return;const i=e||this.project.coordinates?.lat||40.416775,r=t||this.project.coordinates?.lng||-3.70379;delete P.Icon.Default.prototype._getIconUrl,P.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"}),this.map=P.map("editorMap",{zoomControl:!1,maxZoom:22,minZoom:3}).setView([i,r],16),this.map.createPane("zonesPane"),this.map.getPane("zonesPane").style.zIndex="400",this.map.createPane("pathsPane"),this.map.getPane("pathsPane").style.zIndex="450",this.map.createPane("markersPane"),this.map.getPane("markersPane").style.zIndex="500",this.satelliteLayer=P.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:22,maxNativeZoom:19}).addTo(this.map),this.zonesLayer=P.layerGroup().addTo(this.map),this.pathsLayer=P.layerGroup().addTo(this.map),this.markersLayer=P.layerGroup().addTo(this.map),this.drawLayer=P.layerGroup().addTo(this.map),P.control.zoom({position:"bottomright"}).addTo(this.map),this.map.on("click",a=>this.onMapClick(a)),this.renderProjectElements()}renderProjectElements(){if(!this.project||!this.map)return;this.zonesLayer?.clearLayers(),this.pathsLayer?.clearLayers(),this.markersLayer?.clearLayers(),this.project.zones?.forEach(t=>{const n=t.coordinates.map(r=>P.latLng(r.lat,r.lng)),i=P.polygon(n,{color:t.color||"#ef4444",weight:5,fillOpacity:.25,opacity:.9,pane:"zonesPane"});i.on("click",r=>{P.DomEvent.stopPropagation(r),this.showZoneOptions(t)}),i.addTo(this.zonesLayer)}),this.project.paths?.forEach(t=>{const n=t.coordinates.map(a=>P.latLng(a.lat,a.lng)),i=P.polyline(n,{color:"transparent",weight:30,opacity:0,pane:"pathsPane"});i.on("click",a=>{P.DomEvent.stopPropagation(a),this.showPathOptions(t)}),i.addTo(this.pathsLayer);const r=P.polyline(n,{color:t.color||"#3b82f6",weight:10,opacity:.95,lineCap:"round",lineJoin:"round",pane:"pathsPane"});r.on("click",a=>{P.DomEvent.stopPropagation(a),this.showPathOptions(t)}),r.addTo(this.pathsLayer)}),this.project.markers?.forEach(t=>{this.addMarkerToMap(t)});const e=new Set;this.project.markers?.forEach(t=>{t.photoIds?.forEach(n=>e.add(n))}),this.photos.forEach(t=>{if(t.latitude&&t.longitude&&!e.has(t.id)){const n=P.divIcon({className:"photo-marker orphan-photo",html:'<div class="photo-marker-dot"></div>',iconSize:[24,24],iconAnchor:[12,12]}),i=P.marker([t.latitude,t.longitude],{icon:n,pane:"markersPane"});i.on("click",()=>this.showOrphanPhotoOptions(t)),i.addTo(this.markersLayer)}}),this.fitBoundsToContent()}fitBoundsToContent(){if(!this.map||!this.project)return;const e=[];if(this.project.zones?.forEach(t=>t.coordinates.forEach(n=>e.push(P.latLng(n.lat,n.lng)))),this.project.paths?.forEach(t=>t.coordinates.forEach(n=>e.push(P.latLng(n.lat,n.lng)))),this.project.markers?.forEach(t=>e.push(P.latLng(t.coordinate.lat,t.coordinate.lng))),this.photos.forEach(t=>{t.latitude&&t.longitude&&e.push(P.latLng(t.latitude,t.longitude))}),e.length>0){const t=P.latLngBounds(e);this.map.fitBounds(t,{padding:[50,50],maxZoom:18})}}setDrawMode(e){this.drawMode!==e?(this.cancelDrawing(),this.drawMode=e,this.setLayersInteractive("none"===e)):this.cancelDrawing()}setLayersInteractive(e){this.zonesLayer?.eachLayer(t=>{e?(t.options.interactive=!0,t._path&&(t._path.style.pointerEvents="auto")):(t.options.interactive=!1,t._path&&(t._path.style.pointerEvents="none"))}),this.pathsLayer?.eachLayer(t=>{e?(t.options.interactive=!0,t._path&&(t._path.style.pointerEvents="auto")):(t.options.interactive=!1,t._path&&(t._path.style.pointerEvents="none"))}),this.markersLayer?.eachLayer(t=>{e?(t.options.interactive=!0,t._icon&&(t._icon.style.pointerEvents="auto")):(t.options.interactive=!1,t._icon&&(t._icon.style.pointerEvents="none"))})}onMapClick(e){if("none"!==this.drawMode){if("marker"===this.drawMode)return void this.addNewMarker(e.latlng);this.currentPoints.push(e.latlng),this.updateDrawing()}}updateDrawing(){!this.drawLayer||0===this.currentPoints.length||(this.drawLayer.clearLayers(),this.currentPoints.forEach((e,t)=>{const n=P.divIcon({className:"draw-point",html:`<div class="draw-dot">${t+1}</div>`,iconSize:[24,24],iconAnchor:[12,12]});P.marker(e,{icon:n}).addTo(this.drawLayer)}),this.currentPoints.length>=2&&("zone"===this.drawMode?this.currentDrawing=P.polygon(this.currentPoints,{color:"#ef4444",weight:3,fillOpacity:.2,dashArray:"10, 5"}).addTo(this.drawLayer):"path"===this.drawMode&&(this.currentDrawing=P.polyline(this.currentPoints,{color:"#3b82f6",weight:4,dashArray:"10, 5"}).addTo(this.drawLayer))))}finishDrawing(){var e=this;return(0,p.A)(function*(){e.currentPoints.length<2||"zone"===e.drawMode&&e.currentPoints.length<3||(yield(yield e.alertCtrl.create({header:"zone"===e.drawMode?"Nueva Zona":"Nuevo Vial",inputs:[{name:"name",type:"text",placeholder:"zone"===e.drawMode?"Nombre de la zona":"Nombre del vial"},{name:"description",type:"textarea",placeholder:"Descripcion (opcional)"}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Guardar",handler:n=>!!n.name?.trim()&&(e.saveDrawing(n.name,n.description),!0)}]})).present())})()}saveDrawing(e,t){var n=this;return(0,p.A)(function*(){if(!n.project)return;const i=n.currentPoints.map(a=>({lat:a.lat,lng:a.lng})),r=`${n.drawMode}_${Date.now()}`;if("zone"===n.drawMode){const a={id:r,name:e,description:t,coordinates:i,color:"#ef4444",createdAt:(new Date).toISOString()};n.project.zones=n.project.zones||[],n.project.zones.push(a)}else if("path"===n.drawMode){const a={id:r,name:e,description:t,coordinates:i,color:"#3b82f6",createdAt:(new Date).toISOString()};n.project.paths=n.project.paths||[],n.project.paths.push(a)}yield n.saveProject(),n.cancelDrawing(),n.renderProjectElements()})()}cancelDrawing(){this.drawMode="none",this.currentPoints=[],this.currentDrawing=null,this.drawLayer?.clearLayers(),this.setLayersInteractive(!0)}undoLastPoint(){this.currentPoints.length>0&&(this.currentPoints.pop(),this.updateDrawing())}addNewMarker(e){var t=this;return(0,p.A)(function*(){var i;yield(yield t.alertCtrl.create({header:"Nuevo Punto",inputs:[{name:"name",type:"text",placeholder:"Nombre del punto"},{name:"description",type:"textarea",placeholder:"Descripcion/notas"}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Guardar",handler:(i=(0,p.A)(function*(r){return!!r.name?.trim()&&(yield t.saveMarker(e,r.name,r.description),!0)}),function(a){return i.apply(this,arguments)})}]})).present(),t.drawMode="none"})()}saveMarker(e,t,n){var i=this;return(0,p.A)(function*(){if(!i.project)return;i.project.markers=i.project.markers||[];const a=i.project.markers.reduce((l,s)=>Math.max(l,s.order||0),0)+1,c={id:`marker_${Date.now()}`,name:t,description:n,coordinate:{lat:e.lat,lng:e.lng},order:a,createdAt:(new Date).toISOString()};i.project.markers.push(c),yield i.saveProject(),i.renderProjectElements()})()}takePhotoForMarkerId(e){var t=this;return(0,p.A)(function*(){const n=t.project?.markers?.find(i=>i.id===e);if(n)try{console.log("Abriendo c\xe1mara para marcador:",n.name);const i=yield t.cameraService.takePhoto();if(console.log("Foto capturada:",i?"OK":"null"),i&&t.project){const r=i.base64?`data:image/jpeg;base64,${i.base64}`:i.webviewPath||i.webPath,a={id:`photo_${Date.now()}`,projectId:t.project.id,localPath:i.filepath,imageUrl:r,latitude:n.coordinate.lat,longitude:n.coordinate.lng,timestamp:(new Date).toISOString(),synced:!1,notes:`Punto ${n.order||"?"}: ${n.name}`};yield t.storageService.savePhoto(a),t.photos.push(a);const c=t.project.markers?.find(l=>l.id===e);c&&(c.photoIds=c.photoIds||[],c.photoIds.push(a.id),console.log("Foto a\xf1adida al marcador. Total fotos:",c.photoIds.length)),yield t.saveProject(),t.renderProjectElements()}}catch(i){console.error("Error tomando foto:",i)}else console.error("Marcador no encontrado:",e)})()}onHiddenPhotoInputChange(e){var t=this;return(0,p.A)(function*(){const n=e.target,i=n.files?.[0];try{yield t.actionSheetCtrl.dismiss()}catch{}if(!i||!t.pendingPhotoMarkerId||!t.project)return console.log("No file, markerId or project:",{file:!!i,markerId:t.pendingPhotoMarkerId,project:!!t.project}),t.pendingPhotoMarkerId=null,void(n.value="");const r=t.pendingPhotoMarkerId,a=t.project.markers?.find(c=>c.id===r);if(!a)return console.error("Marcador no encontrado:",r),t.pendingPhotoMarkerId=null,void(n.value="");try{const l=`data:image/jpeg;base64,${yield t.fileToBase64(i)}`,d={id:`photo_${Date.now()}`,projectId:t.project.id,localPath:`web_${Date.now()}.jpeg`,imageUrl:l,latitude:a.coordinate.lat,longitude:a.coordinate.lng,timestamp:(new Date).toISOString(),synced:!1,notes:`Punto ${a.order||"?"}: ${a.name}`};yield t.storageService.savePhoto(d),t.photos.push(d);const u=t.project.markers?.find(_=>_.id===r);u&&(u.photoIds=u.photoIds||[],u.photoIds.push(d.id),console.log("Foto a\xf1adida al marcador. Total fotos:",u.photoIds.length)),yield t.saveProject(),t.renderProjectElements(),t.project.serverId&&t.uploadPhotoToCloud(d,l,r)}catch(c){console.error("Error procesando foto:",c)}finally{t.pendingPhotoMarkerId=null,n.value=""}})()}uploadPhotoToCloud(e,t,n){var i=this;return(0,p.A)(function*(){if(i.project?.serverId)try{const r=yield(0,b._)(i.apiService.uploadPhoto(i.project.serverId,t,e.latitude,e.longitude,e.notes));if(r?.success&&r?.photo){e.serverId=r.photo.id,e.imageUrl=r.photo.imageUrl,e.thumbnailUrl=r.photo.thumbnailUrl,e.synced=!0,yield i.storageService.savePhoto(e);const a=i.photos.findIndex(c=>c.id===e.id);if(a>=0&&(i.photos[a]=e),n&&i.project.markers&&e.serverId){const c=i.project.markers.find(l=>l.id===n);c&&(c.serverPhotoIds=c.serverPhotoIds||[],c.serverPhotoIds.includes(e.serverId)||(c.serverPhotoIds.push(e.serverId),yield i.saveProject()))}console.log("Foto subida a la nube:",r.photo.imageUrl)}}catch(r){console.log("Error subiendo foto a la nube:",r?.message)}})()}fileToBase64(e){return new Promise((t,n)=>{const i=new Image,r=document.createElement("canvas"),a=r.getContext("2d");i.onload=()=>{let s=i.width,d=i.height;s>d?s>800&&(d=Math.round(800*d/s),s=800):d>800&&(s=Math.round(800*s/d),d=800),r.width=s,r.height=d,a?.drawImage(i,0,0,s,d);const _=r.toDataURL("image/jpeg",.6).split(",")[1];t(_)},i.onerror=n;const c=new FileReader;c.onerror=n,c.onload=()=>{i.src=c.result},c.readAsDataURL(e)})}takePhotoForMarker(e){var t=this;return(0,p.A)(function*(){yield t.takePhotoForMarkerId(e.id)})()}addMarkerToMap(e){const t=e.photoIds&&e.photoIds.length>0,n=t?"#10b981":"#f59e0b",c=P.divIcon({className:t?"project-marker has-photo":"project-marker",html:`\n      <svg width="32" height="42" viewBox="0 0 32 42" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path d="M16 0C7.163 0 0 7.163 0 16c0 10.5 14.4 25 15.1 25.7a1.2 1.2 0 001.8 0C17.6 41 32 26.5 32 16c0-8.837-7.163-16-16-16z" fill="${n}"/>\n        <circle cx="16" cy="16" r="11" fill="white"/>\n        <text x="16" y="21" text-anchor="middle" font-size="14" font-weight="bold" fill="${n}" font-family="Arial, sans-serif">${e.order||"?"}</text>\n      </svg>\n      ${t?'<span class="photo-badge"></span>':""}\n    `,iconSize:[32,42],iconAnchor:[16,42]}),l=P.marker([e.coordinate.lat,e.coordinate.lng],{icon:c,pane:"markersPane"});l.on("click",()=>this.showMarkerOptionsById(e.id)),l.addTo(this.markersLayer)}showMarkerOptionsById(e){var t=this;return(0,p.A)(function*(){const n=t.project?.markers?.find(i=>i.id===e);n&&(yield t.showMarkerOptions(n))})()}showMarkerOptions(e){var t=this;return(0,p.A)(function*(){const n=e.id,i=e.photoIds&&e.photoIds.length>0,r=i?t.photos.filter(l=>e.photoIds.includes(l.id)):[],a=[];i&&a.push({text:`Ver ${r.length} foto${r.length>1?"s":""}`,icon:"images-outline",handler:()=>{const l=t.project?.markers?.find(s=>s.id===n);if(l){const s=t.photos.filter(d=>l.photoIds?.includes(d.id));t.showMarkerPhotos(l,s)}}}),a.push({text:"Tomar foto",icon:"camera-outline",handler:()=>(t.pendingPhotoMarkerId=n,t.hiddenPhotoInput?.nativeElement&&t.hiddenPhotoInput.nativeElement.click(),!1)}),a.push({text:"Analizar con IA",icon:"sparkles-outline",handler:()=>{const l=t.project?.markers?.find(s=>s.id===n);if(l&&l.photoIds&&l.photoIds.length>0){const s=t.photos.filter(d=>l.photoIds?.includes(d.id));t.analyzeMarkerPhotosWithAI(s)}else t.showNoPhotosAlert()}}),a.push({text:"Editar notas",icon:"create-outline",handler:()=>{const l=t.project?.markers?.find(s=>s.id===n);l&&t.editMarkerNotes(l)}}),a.push({text:"Eliminar punto",icon:"trash-outline",role:"destructive",handler:()=>{const l=t.project?.markers?.find(s=>s.id===n);l&&t.deleteMarker(l)}}),a.push({text:"Cancelar",icon:"close",role:"cancel"}),yield(yield t.actionSheetCtrl.create({header:e.name,subHeader:e.description||e.aiDescription||`${e.coordinate.lat.toFixed(5)}, ${e.coordinate.lng.toFixed(5)}`,buttons:a})).present()})()}showNoPhotosAlert(){var e=this;return(0,p.A)(function*(){yield(yield e.alertCtrl.create({header:"Sin fotos",message:"Primero debes tomar una foto para poder analizarla con IA.",buttons:["Entendido"]})).present()})()}analyzeMarkerPhotosWithAI(e){var t=this;return(0,p.A)(function*(){for(const n of e)n.aiDescription||(yield t.analyzePhotoWithAI(n));t.renderProjectElements()})()}editMarkerNotes(e){var t=this;return(0,p.A)(function*(){var i;yield(yield t.alertCtrl.create({header:"Editar notas",inputs:[{name:"notes",type:"textarea",placeholder:"Escribe tus notas aqu\xed...",value:e.description||""}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Guardar",handler:(i=(0,p.A)(function*(r){e.description=r.notes,yield t.saveProject(),t.renderProjectElements()}),function(a){return i.apply(this,arguments)})}]})).present()})()}showMarkerPhotos(e,t){var n=this;return(0,p.A)(function*(){if(1===t.length)n.showPhotoDetail(t[0],e);else{const i=t.map((a,c)=>({text:`Foto ${c+1} - ${new Date(a.timestamp||"").toLocaleDateString("es-ES")}`,handler:()=>n.showPhotoDetail(a,e)}));i.push({text:"Cancelar",role:"cancel"}),yield(yield n.actionSheetCtrl.create({header:"Seleccionar foto",buttons:i})).present()}})()}showPhotoDetail(e,t){var n=this;return(0,p.A)(function*(){n.viewerPhoto=e,n.viewerMarker=t,n.showPhotoViewer=!0})()}closePhotoViewer(){this.showPhotoViewer=!1,this.viewerPhoto=null,this.viewerMarker=null}editViewerPhotoNotes(){var e=this;return(0,p.A)(function*(){if(e.viewerPhoto){yield e.editPhotoNotes(e.viewerPhoto);const t=e.photos.find(n=>n.id===e.viewerPhoto?.id);t&&(e.viewerPhoto=t)}})()}analyzeViewerPhotoWithAI(){var e=this;return(0,p.A)(function*(){if(e.viewerPhoto){const t=e.viewerPhoto;e.closePhotoViewer(),yield e.analyzePhotoWithAI(t)}})()}deleteViewerPhoto(){var e=this;return(0,p.A)(function*(){if(e.viewerPhoto&&e.viewerMarker){const t=e.viewerPhoto,n=e.viewerMarker;e.closePhotoViewer(),yield e.deleteMarkerPhoto(t,n)}})()}deleteMarkerPhoto(e,t){var n=this;return(0,p.A)(function*(){var r;yield(yield n.alertCtrl.create({header:"Eliminar foto",message:"\xbfSeguro que quieres eliminar esta foto?",buttons:[{text:"Cancelar",role:"cancel"},{text:"Eliminar",role:"destructive",handler:(r=(0,p.A)(function*(){if(e.serverId)try{yield(0,b._)(n.apiService.deleteCloudPhoto(e.serverId))}catch{}yield n.storageService.deletePhoto(e.id),n.photos=n.photos.filter(a=>a.id!==e.id),t.photoIds&&(t.photoIds=t.photoIds.filter(a=>a!==e.id)),t.serverPhotoIds&&e.serverId&&(t.serverPhotoIds=t.serverPhotoIds.filter(a=>a!==e.serverId)),yield n.saveProject(),n.renderProjectElements()}),function(){return r.apply(this,arguments)})}]})).present()})()}editPhotoNotes(e){var t=this;return(0,p.A)(function*(){var i;yield(yield t.alertCtrl.create({header:"Editar notas de la foto",inputs:[{name:"notes",type:"textarea",placeholder:"Escribe tus notas...",value:e.notes||""}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Guardar",handler:(i=(0,p.A)(function*(r){e.notes=r.notes,yield t.storageService.updatePhoto(e);const a=t.photos.findIndex(c=>c.id===e.id);a>=0&&(t.photos[a]=e)}),function(a){return i.apply(this,arguments)})}]})).present()})()}showOrphanPhotoOptions(e){var t=this;return(0,p.A)(function*(){const n=[{text:"Editar notas",icon:"create-outline",handler:()=>t.editPhotoNotes(e)},{text:"Analizar con IA",icon:"sparkles-outline",handler:()=>t.analyzePhotoWithAI(e)},{text:"Eliminar foto",icon:"trash-outline",role:"destructive",handler:()=>t.deleteOrphanPhoto(e)},{text:"Cancelar",icon:"close",role:"cancel"}];yield(yield t.actionSheetCtrl.create({header:"Foto",subHeader:e.notes||e.aiDescription||`${e.latitude?.toFixed(5)}, ${e.longitude?.toFixed(5)}`,buttons:n})).present()})()}deleteOrphanPhoto(e){var t=this;return(0,p.A)(function*(){var i;yield(yield t.alertCtrl.create({header:"Eliminar foto",message:"\xbfSeguro que quieres eliminar esta foto?",buttons:[{text:"Cancelar",role:"cancel"},{text:"Eliminar",role:"destructive",handler:(i=(0,p.A)(function*(){if(e.serverId)try{yield(0,b._)(t.apiService.deleteCloudPhoto(e.serverId))}catch{}yield t.storageService.deletePhoto(e.id),t.photos=t.photos.filter(r=>r.id!==e.id),t.renderProjectElements()}),function(){return i.apply(this,arguments)})}]})).present()})()}deleteMarker(e){var t=this;return(0,p.A)(function*(){const n=t.project?.markers?.find(c=>c.id===e.id);if(!n)return;const i=n.photoIds&&n.photoIds.length>0,r=n.photoIds?.length||0;var c;yield(yield t.alertCtrl.create({header:"Eliminar punto",message:i?`\xbfSeguro que quieres eliminar "${n.name}" y sus ${r} foto${r>1?"s":""} asociada${r>1?"s":""}?`:`\xbfSeguro que quieres eliminar "${n.name}"?`,buttons:[{text:"Cancelar",role:"cancel"},{text:"Eliminar",role:"destructive",handler:(c=(0,p.A)(function*(){if(t.project){const l=t.project.markers?.find(s=>s.id===e.id);if(l?.photoIds&&l.photoIds.length>0)for(const s of l.photoIds){const d=t.photos.find(u=>u.id===s);if(d?.serverId)try{yield(0,b._)(t.apiService.deleteCloudPhoto(d.serverId))}catch{}yield t.storageService.deletePhoto(s),t.photos=t.photos.filter(u=>u.id!==s)}t.project.markers=t.project.markers?.filter(s=>s.id!==e.id),yield t.saveProject(),t.renderProjectElements()}}),function(){return c.apply(this,arguments)})}]})).present()})()}showZoneOptions(e){var t=this;return(0,p.A)(function*(){const n=t.getZoneInfo(e),i=[{text:"Ver informaci\xf3n detallada",icon:"information-circle-outline",handler:()=>t.showZoneDetails(e,n)},{text:"Editar nombre/descripci\xf3n",icon:"create-outline",handler:()=>t.editZone(e)},{text:"Eliminar zona",icon:"trash-outline",role:"destructive",handler:()=>t.deleteZone(e)},{text:"Cancelar",icon:"close",role:"cancel"}];yield(yield t.actionSheetCtrl.create({header:e.name,subHeader:`\xc1rea: ${t.formatArea(n.area)} | Per\xedmetro: ${t.formatDistance(n.perimeter)}`,buttons:i})).present()})()}showZoneDetails(e,t){var n=this;return(0,p.A)(function*(){const i=`\n\u{1f4d0} \xc1REA: ${n.formatArea(t.area)}\n\n\u{1f4cf} PER\xcdMETRO: ${n.formatDistance(t.perimeter)}\n\n\u{1f4cd} V\xc9RTICES: ${t.vertices} puntos\n\n\u{1f4e6} DIMENSIONES:\n   \u2022 Ancho: ${n.formatDistance(t.bbox.width)}\n   \u2022 Alto: ${n.formatDistance(t.bbox.height)}\n\n${e.description?"\u{1f4dd} DESCRIPCI\xd3N:\n"+e.description:""}\n    `.trim();yield(yield n.alertCtrl.create({header:e.name,subHeader:"Informaci\xf3n de la zona",message:i,buttons:["Cerrar"]})).present()})()}editZone(e){var t=this;return(0,p.A)(function*(){var i;yield(yield t.alertCtrl.create({header:"Editar zona",inputs:[{name:"name",type:"text",placeholder:"Nombre de la zona",value:e.name},{name:"description",type:"textarea",placeholder:"Descripci\xf3n (opcional)",value:e.description||""}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Guardar",handler:(i=(0,p.A)(function*(r){r.name?.trim()&&(e.name=r.name,e.description=r.description,yield t.saveProject(),t.renderProjectElements())}),function(a){return i.apply(this,arguments)})}]})).present()})()}deleteZone(e){var t=this;return(0,p.A)(function*(){var i;yield(yield t.alertCtrl.create({header:"Eliminar zona",message:`\xbfSeguro que quieres eliminar "${e.name}"?`,buttons:[{text:"Cancelar",role:"cancel"},{text:"Eliminar",role:"destructive",handler:(i=(0,p.A)(function*(){t.project&&(t.project.zones=t.project.zones?.filter(r=>r.id!==e.id),yield t.saveProject(),t.renderProjectElements())}),function(){return i.apply(this,arguments)})}]})).present()})()}showPathOptions(e){var t=this;return(0,p.A)(function*(){const n=t.getPathInfo(e),i=[{text:"Ver informaci\xf3n detallada",icon:"information-circle-outline",handler:()=>t.showPathDetails(e,n)},{text:"Editar nombre/descripci\xf3n",icon:"create-outline",handler:()=>t.editPath(e)},{text:"Eliminar trazado",icon:"trash-outline",role:"destructive",handler:()=>t.deletePath(e)},{text:"Cancelar",icon:"close",role:"cancel"}];yield(yield t.actionSheetCtrl.create({header:e.name,subHeader:`Longitud: ${t.formatDistance(n.length)} | ${n.segments} tramos`,buttons:i})).present()})()}showPathDetails(e,t){var n=this;return(0,p.A)(function*(){const i=`\n\u{1f4cf} LONGITUD TOTAL: ${n.formatDistance(t.length)}\n\n\u{1f517} TRAMOS: ${t.segments} segmentos\n\n\u{1f4cd} PUNTOS: ${e.coordinates.length} v\xe9rtices\n\n\u{1f4e6} EXTENSI\xd3N:\n   \u2022 Ancho: ${n.formatDistance(t.bbox.width)}\n   \u2022 Alto: ${n.formatDistance(t.bbox.height)}\n\n${e.description?"\u{1f4dd} DESCRIPCI\xd3N:\n"+e.description:""}\n    `.trim();yield(yield n.alertCtrl.create({header:e.name,subHeader:"Informaci\xf3n del trazado",message:i,buttons:["Cerrar"]})).present()})()}editPath(e){var t=this;return(0,p.A)(function*(){var i;yield(yield t.alertCtrl.create({header:"Editar trazado",inputs:[{name:"name",type:"text",placeholder:"Nombre del trazado",value:e.name},{name:"description",type:"textarea",placeholder:"Descripci\xf3n (opcional)",value:e.description||""}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Guardar",handler:(i=(0,p.A)(function*(r){r.name?.trim()&&(e.name=r.name,e.description=r.description,yield t.saveProject(),t.renderProjectElements())}),function(a){return i.apply(this,arguments)})}]})).present()})()}deletePath(e){var t=this;return(0,p.A)(function*(){var i;yield(yield t.alertCtrl.create({header:"Eliminar trazado",message:`\xbfSeguro que quieres eliminar "${e.name}"?`,buttons:[{text:"Cancelar",role:"cancel"},{text:"Eliminar",role:"destructive",handler:(i=(0,p.A)(function*(){t.project&&(t.project.paths=t.project.paths?.filter(r=>r.id!==e.id),yield t.saveProject(),t.renderProjectElements())}),function(){return i.apply(this,arguments)})}]})).present()})()}createPhotoPopup(e){const t=e.imageUrl||e.localPath||"";return`<div class="photo-popup">${t?`<img src="${t}" style="max-width:150px;border-radius:8px;">`:""}<p>${e.notes||e.aiDescription||"Sin descripcion"}</p><small>${e.latitude?.toFixed(5)}, ${e.longitude?.toFixed(5)}</small></div>`}takePhoto(){var e=this;return(0,p.A)(function*(){try{const t=yield e.gpsService.getCurrentPosition(),n=yield e.cameraService.takePhoto();if(n&&e.project){const i=n.base64?`data:image/jpeg;base64,${n.base64}`:n.webviewPath||n.webPath,r={id:`photo_${Date.now()}`,projectId:e.project.id,localPath:n.filepath,imageUrl:i,latitude:t.latitude,longitude:t.longitude,altitude:t.altitude,timestamp:(new Date).toISOString(),synced:!1};yield e.storageService.savePhoto(r),e.photos.push(r),e.renderProjectElements(),e.map&&e.map.setView([t.latitude,t.longitude],18)}}catch{}})()}importPhotosFromGallery(){this.galleryPhotoInput?.nativeElement&&this.galleryPhotoInput.nativeElement.click()}onGalleryPhotosSelected(e){var t=this;return(0,p.A)(function*(){const n=e.target,i=n.files;if(!i||0===i.length||!t.project)return void(n.value="");let r=0,a=0;for(let c=0;c<i.length;c++){const l=i[c];try{const s=yield S.default.parse(l,{gps:!0});let d,u;if(s?.latitude&&s?.longitude)d=s.latitude,u=s.longitude,r++;else{a++;try{const M=yield t.gpsService.getCurrentPosition();d=M.latitude,u=M.longitude}catch{if(t.map){const w=t.map.getCenter();d=w.lat,u=w.lng}}}if(!d||!u)continue;const x=`data:image/jpeg;base64,${yield t.fileToBase64(l)}`,f={id:`photo_${Date.now()}_${c}`,projectId:t.project.id,localPath:`gallery_${Date.now()}_${c}.jpeg`,imageUrl:x,latitude:d,longitude:u,timestamp:s?.DateTimeOriginal?.toISOString()||(new Date).toISOString(),synced:!1,notes:l.name};yield t.storageService.savePhoto(f),t.photos.push(f),t.project.serverId&&t.uploadPhotoToCloud(f,x)}catch(s){console.error("Error procesando foto:",l.name,s)}}n.value="",t.renderProjectElements(),t.fitBoundsToContent(),a>0&&(yield(yield t.alertCtrl.create({header:"Fotos sin GPS",message:r>0?`${a} foto(s) no ten\xedan coordenadas GPS y se ubicaron en tu posici\xf3n actual o centro del mapa.`:"Las fotos no ten\xedan coordenadas GPS. Se ubicaron en tu posici\xf3n actual o centro del mapa.",buttons:["Entendido"],cssClass:"gps-warning-alert"})).present())})()}takeQuickPhoto(){this.quickCameraInput?.nativeElement&&this.quickCameraInput.nativeElement.click()}onQuickCameraPhoto(e){var t=this;return(0,p.A)(function*(){const n=e.target,i=n.files?.[0];if(i&&t.project)try{let r,a;try{const d=yield t.gpsService.getCurrentPosition();r=d.latitude,a=d.longitude}catch{if(!t.map)return t.showToast("No se pudo obtener la ubicacion","warning"),void(n.value="");{const u=t.map.getCenter();r=u.lat,a=u.lng}}const l=`data:image/jpeg;base64,${yield t.fileToBase64(i)}`,s={id:`photo_${Date.now()}`,projectId:t.project.id,localPath:`quick_${Date.now()}.jpeg`,imageUrl:l,latitude:r,longitude:a,timestamp:(new Date).toISOString(),synced:!1};yield t.storageService.savePhoto(s),t.photos.push(s),t.project.serverId&&t.uploadPhotoToCloud(s,l),t.renderProjectElements(),t.map&&t.map.setView([r,a],18)}catch(r){console.error("Error con foto rapida:",r)}finally{n.value=""}else n.value=""})()}analyzePhotoWithAI(e){var t=this;return(0,p.A)(function*(){t.isAnalyzingPhoto=!0,t.aiLoadingMessage="Analizando imagen con IA...";try{const n=e.imageUrl||e.localPath||"",i=yield t.claudeService.analyzeImage(n);e.aiDescription=i,yield t.storageService.updatePhoto(e);const r=t.photos.findIndex(a=>a.id===e.id);r>=0&&(t.photos[r]=e),t.renderProjectElements()}catch{}finally{t.isAnalyzingPhoto=!1,t.aiLoadingMessage=""}})()}captureMapScreenshot(){var e=this;return(0,p.A)(function*(){if(!e.map||!e.project)return"";try{const i=document.createElement("canvas");i.width=800,i.height=500;const r=i.getContext("2d");if(!r)return"";const a=e.getContentBounds();if(!a)return"";try{const l=yield e.loadStaticMapImage(a,800,500);l?r.drawImage(l,0,0,800,500):e.drawFallbackBackground(r,800,500)}catch{console.log("Error cargando mapa satelital, usando fallback"),e.drawFallbackBackground(r,800,500)}const c=(l,s)=>({x:(s-a.west)/(a.east-a.west)*800,y:(a.north-l)/(a.north-a.south)*500});return e.project.zones&&e.project.zones.forEach(l=>{if(l.coordinates.length<3)return;r.beginPath();const s=c(l.coordinates[0].lat,l.coordinates[0].lng);r.moveTo(s.x,s.y),l.coordinates.forEach((d,u)=>{if(u>0){const _=c(d.lat,d.lng);r.lineTo(_.x,_.y)}}),r.closePath(),r.fillStyle="rgba(239, 68, 68, 0.4)",r.fill(),r.strokeStyle="#ef4444",r.lineWidth=3,r.stroke()}),e.project.paths&&e.project.paths.forEach(l=>{if(l.coordinates.length<2)return;r.beginPath();const s=c(l.coordinates[0].lat,l.coordinates[0].lng);r.moveTo(s.x,s.y),l.coordinates.forEach((d,u)=>{if(u>0){const _=c(d.lat,d.lng);r.lineTo(_.x,_.y)}}),r.strokeStyle="#3b82f6",r.lineWidth=5,r.lineCap="round",r.lineJoin="round",r.stroke()}),e.project.markers&&e.project.markers.forEach(l=>{const s=c(l.coordinate.lat,l.coordinate.lng),u=l.photoIds&&l.photoIds.length>0?"#10b981":"#f59e0b",_=l.order||"?";r.shadowColor="rgba(0,0,0,0.5)",r.shadowBlur=6,r.shadowOffsetY=3,r.beginPath(),r.fillStyle=u,r.arc(s.x,s.y-18,16,0,2*Math.PI),r.fill(),r.beginPath(),r.moveTo(s.x-10,s.y-8),r.lineTo(s.x,s.y+2),r.lineTo(s.x+10,s.y-8),r.fill(),r.shadowColor="transparent",r.beginPath(),r.fillStyle="white",r.arc(s.x,s.y-18,11,0,2*Math.PI),r.fill(),r.fillStyle=u,r.font="bold 14px Arial",r.textAlign="center",r.textBaseline="middle",r.fillText(String(_),s.x,s.y-17)}),r.shadowColor="transparent",r.fillStyle="rgba(0,0,0,0.7)",r.fillRect(0,465,800,35),r.fillStyle="white",r.font="bold 14px Arial",r.textAlign="center",r.fillText(`${e.project.name} - ${e.project.markers?.length||0} puntos, ${e.project.zones?.length||0} zonas, ${e.project.paths?.length||0} viales`,400,485),i.toDataURL("image/jpeg",.9)}catch(t){return console.error("Error generando mapa:",t),""}})()}loadStaticMapImage(e,t,n){return new Promise(i=>{const r=`https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/export?bbox=${e.west},${e.south},${e.east},${e.north}&bboxSR=4326&imageSR=4326&size=${t},${n}&format=jpg&f=image`,a=new Image;a.crossOrigin="anonymous";const c=setTimeout(()=>{console.log("Timeout cargando mapa satelital"),i(null)},5e3);a.onload=()=>{clearTimeout(c),i(a)},a.onerror=()=>{clearTimeout(c),console.log("Error cargando imagen de mapa"),i(null)},a.src=r})}drawFallbackBackground(e,t,n){const i=e.createLinearGradient(0,0,t,n);i.addColorStop(0,"#2d5016"),i.addColorStop(.3,"#3a6b1e"),i.addColorStop(.6,"#4a7c2a"),i.addColorStop(1,"#3d6422"),e.fillStyle=i,e.fillRect(0,0,t,n),e.fillStyle="rgba(0,0,0,0.1)";for(let r=0;r<100;r++){const a=Math.random()*t,c=Math.random()*n,l=30*Math.random()+10;e.beginPath(),e.arc(a,c,l,0,2*Math.PI),e.fill()}}getContentBounds(){if(!this.project)return null;const e=[],t=[];if(this.project.markers?.forEach(s=>{e.push(s.coordinate.lat),t.push(s.coordinate.lng)}),this.project.zones?.forEach(s=>{s.coordinates.forEach(d=>{e.push(d.lat),t.push(d.lng)})}),this.project.paths?.forEach(s=>{s.coordinates.forEach(d=>{e.push(d.lat),t.push(d.lng)})}),0===e.length)return null;const n=Math.max(...e),i=Math.min(...e),r=Math.max(...t),a=Math.min(...t),c=.1*(n-i)||.001,l=.1*(r-a)||.001;return{north:n+c,south:i-c,east:r+l,west:a-l}}showExportOptions(){var e=this;return(0,p.A)(function*(){yield(yield e.actionSheetCtrl.create({header:"Exportar Proyecto",buttons:[{text:"Exportar a KMZ (Google Earth)",icon:"globe-outline",handler:()=>e.exportToKMZ()},{text:"Generar Informe Word",icon:"document-text-outline",handler:()=>e.exportToWord()},{text:"Cancelar",icon:"close",role:"cancel"}]})).present()})()}exportToKMZ(){var e=this;return(0,p.A)(function*(){e.project&&(yield e.saveKmlToProject())})()}exportToWord(){var e=this;return(0,p.A)(function*(){if(e.project&&!e.isGeneratingPDD){e.isGeneratingPDD=!0;try{e.aiLoadingMessage="Capturando mapa...";const t=yield e.captureMapScreenshot(),n=[];for(const s of e.photos){let u,_,d="";if(s.imageUrl)d=s.imageUrl;else if(s.localPath)try{d=yield e.cameraService.getPhotoBase64(s.localPath)}catch{}const x=e.project?.markers?.find(f=>f.photoIds?.includes(s.id));x&&(u=x.order,_=x.name),n.push({id:s.id,base64:d,description:s.notes,aiDescription:s.aiDescription,latitude:s.latitude,longitude:s.longitude,timestamp:s.timestamp,location:s.location,catastroRef:s.catastroRef,markerOrder:u,markerName:_})}n.sort((s,d)=>void 0===s.markerOrder&&void 0===d.markerOrder?0:void 0===s.markerOrder?1:void 0===d.markerOrder?-1:s.markerOrder-d.markerOrder);const i=e.project.markers?.map(s=>({order:s.order||0,name:s.name,description:s.description,aiDescription:s.aiDescription,latitude:s.coordinate.lat,longitude:s.coordinate.lng,photoCount:s.photoIds?.length||0})).sort((s,d)=>s.order-d.order)||[],r=e.project.zones?.map(s=>{const d=e.getZoneInfo(s);return{name:s.name,description:s.description,area:d.area,areaFormatted:e.formatArea(d.area),perimeter:d.perimeter,perimeterFormatted:e.formatDistance(d.perimeter),vertices:d.vertices,dimensions:`${e.formatDistance(d.bbox.width)} x ${e.formatDistance(d.bbox.height)}`}}),a=e.project.paths?.map(s=>{const d=e.getPathInfo(s);return{name:s.name,description:s.description,length:d.length,lengthFormatted:e.formatDistance(d.length),segments:d.segments,dimensions:`${e.formatDistance(d.bbox.width)} x ${e.formatDistance(d.bbox.height)}`}});e.aiLoadingMessage="Generando resumen con IA...";let c="";try{const s={projectName:e.project.name,projectLocation:e.project.location,zones:r?.map(u=>({name:u.name,description:u.description,area:u.areaFormatted,perimeter:u.perimeterFormatted,vertices:u.vertices})),paths:a?.map(u=>({name:u.name,description:u.description,length:u.lengthFormatted,segments:u.segments})),photos:e.photos.map(u=>({description:u.notes,aiDescription:u.aiDescription,location:u.location,latitude:u.latitude,longitude:u.longitude}))};c=(yield e.claudeService.generateProjectReport(s)).summary||""}catch{c="Resumen no disponible (sin conexi\xf3n a IA)"}e.aiLoadingMessage="";const l={projectName:e.project.name,projectDescription:e.project.description,projectLocation:e.project.location,createdAt:e.project.createdAt.toString(),aiSummary:c,mapScreenshot:t,markers:i,photos:n,zones:r,paths:a,notes:e.project.notes};e.pendingReportData=l,e.reportPreviewRawHtml=e.reportService.generateHtmlPreview(l),e.reportPreviewHtml=e.sanitizer.bypassSecurityTrustHtml(e.reportPreviewRawHtml),e.showReportPreview=!0}catch(t){console.error("Error generando informe:",t)}finally{e.isGeneratingPDD=!1}}})()}closeReportPreview(){this.showReportPreview=!1,this.reportPreviewHtml="",this.reportPreviewRawHtml="",this.pendingReportData=null}downloadReport(){var e=this;return(0,p.A)(function*(){if(e.pendingReportData&&e.project)try{yield e.reportService.downloadReport(e.pendingReportData),e.closeReportPreview()}catch(t){console.error("Error descargando informe:",t)}})()}saveReportToProject(){var e=this;return(0,p.A)(function*(){if(console.log("saveReportToProject llamado",{pendingReportData:!!e.pendingReportData,project:!!e.project}),e.pendingReportData&&e.project)try{const t=new Date,r=`Informe PDD ${t.toLocaleDateString("es-ES")} ${t.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}`,a=localStorage.getItem("token"),c=e.project.serverId||e.project.id;let l=`report_${Date.now()}`,s=!1;if(a)try{console.log("Guardando informe en la nube:",r);const _=yield(0,b._)(e.apiService.createReport(c,r,e.reportPreviewRawHtml));console.log("Informe guardado en la nube"),_?.report?.id&&(l=_.report.id),s=!0}catch(_){console.warn("Error guardando en la nube, guardando solo localmente:",_)}const d={id:l,name:r,htmlContent:e.reportPreviewRawHtml,createdAt:t.toISOString()};e.project.reports=e.project.reports||[],e.project.reports.push(d),yield e.saveProject(),console.log("Informe guardado localmente. Total informes:",e.project.reports.length,"Cloud:",s),yield(yield e.alertCtrl.create({header:"Informe guardado",message:`El informe "${r}" se ha guardado correctamente.`,buttons:["OK"]})).present(),e.closeReportPreview()}catch(t){console.error("Error guardando informe:",t),yield(yield e.alertCtrl.create({header:"Error",message:"No se pudo guardar el informe: "+t.message,buttons:["OK"]})).present()}else console.error("No hay datos de reporte o proyecto")})()}downloadReportAsHtml(e,t){const n=new Blob([t],{type:"text/html"}),i=URL.createObjectURL(n),r=document.createElement("a");r.href=i,r.download=`${e.replace(/[^a-zA-Z0-9]/g,"_")}.html`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),this.showToast("Informe descargado","success")}saveKmlToProject(){var e=this;return(0,p.A)(function*(){if(console.log("saveKmlToProject llamado",{project:!!e.project}),e.project)try{const t={name:e.project.name,description:e.project.description,location:e.project.location,createdAt:e.project.createdAt.toString(),photos:e.photos.map(f=>({id:f.id,url:f.imageUrl||f.localPath||"",description:f.notes||f.aiDescription,latitude:f.latitude,longitude:f.longitude,timestamp:f.timestamp})),zones:e.project.zones?.map(f=>({name:f.name,description:f.description,coordinates:f.coordinates})),paths:e.project.paths?.map(f=>({name:f.name,description:f.description,coordinates:f.coordinates})),markers:e.project.markers?.map(f=>{const M=f.photoIds?.map(w=>{const k=e.photos.find(le=>le.id===w);return k?{id:k.id,base64:k.imageUrl||k.localPath||"",notes:k.notes,aiDescription:k.aiDescription}:null}).filter(w=>null!==w)||[];return{name:f.name,description:f.description,aiDescription:f.aiDescription,coordinate:f.coordinate,photos:M}})};console.log("Generando KML...",t);const n=e.kmlService.generateKml(t),i=new Date,c=`Informe KML ${i.toLocaleDateString("es-ES")} ${i.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}`;console.log("Guardando KML:",c);const l=localStorage.getItem("token"),s=e.project.serverId||e.project.id;let d=`kml_${Date.now()}`,u=!1;if(l)try{const f=yield(0,b._)(e.apiService.createKml(s,c,n));console.log("KML guardado en la nube"),f?.kml?.id&&(d=f.kml.id),u=!0}catch(f){console.warn("Error guardando KML en la nube, guardando solo localmente:",f)}const _={id:d,name:c,kmlContent:n,createdAt:i.toISOString()};e.project.kmls=e.project.kmls||[],e.project.kmls.push(_),yield e.saveProject(),console.log("KML guardado localmente. Total KMLs:",e.project.kmls.length,"Cloud:",u),yield(yield e.alertCtrl.create({header:"Archivo KML guardado",message:`El archivo "${c}.kml" se ha guardado correctamente.`,buttons:["OK"]})).present()}catch(t){console.error("Error guardando KML:",t),yield(yield e.alertCtrl.create({header:"Error",message:"No se pudo guardar el archivo KML: "+t.message,buttons:["OK"]})).present()}else console.error("No hay proyecto")})()}downloadKmlFile(e,t){const n=new Blob([t],{type:"application/vnd.google-earth.kml+xml"}),i=URL.createObjectURL(n),r=document.createElement("a");r.href=i,r.download=`${e.replace(/[^a-zA-Z0-9_-]/g,"_")}.kml`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),this.showToast("Archivo KML descargado","success")}blobToBase64(e){return new Promise((t,n)=>{const i=new FileReader;i.onerror=n,i.onload=()=>t(i.result),i.readAsDataURL(e)})}locateMe(){var e=this;return(0,p.A)(function*(){try{const t=yield e.gpsService.getCurrentPosition();e.map&&e.map.setView([t.latitude,t.longitude],18)}catch{}})()}saveProject(){var e=this;return(0,p.A)(function*(){e.project&&(e.project.updatedAt=new Date,yield e.storageService.saveProject(e.project),e.project.serverId&&e.syncProjectContent())})()}syncProjectContent(){var e=this;return(0,p.A)(function*(){if(e.project?.serverId)try{const t={zones:e.project.zones||[],paths:e.project.paths||[],markers:e.project.markers||[],coordinates:e.project.coordinates};yield(0,b._)(e.apiService.put(`/projects/${e.project.serverId}/content`,t)),console.log("Contenido sincronizado con servidor")}catch(t){console.log("Error sincronizando contenido:",t?.message)}})()}goBack(){this.navCtrl.back()}showToast(e,t){var n=this;return(0,p.A)(function*(){yield(yield n.toastCtrl.create({message:e,duration:2e3,position:"top",color:t})).present()})()}get zoneCount(){return this.project?.zones?.length||0}get pathCount(){return this.project?.paths?.length||0}get markerCount(){return this.project?.markers?.length||0}get photoCount(){return this.photos.length}haversineDistance(e,t,n,i){const a=this.toRad(n-e),c=this.toRad(i-t),l=Math.sin(a/2)*Math.sin(a/2)+Math.cos(this.toRad(e))*Math.cos(this.toRad(n))*Math.sin(c/2)*Math.sin(c/2);return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371e3}toRad(e){return e*(Math.PI/180)}calculatePolygonArea(e){if(e.length<3)return 0;const t=e.reduce((c,l)=>c+l.lat,0)/e.length,i=111320*Math.cos(this.toRad(t)),r=e.map(c=>({x:(c.lng-e[0].lng)*i,y:111320*(c.lat-e[0].lat)}));let a=0;for(let c=0;c<r.length;c++){const l=(c+1)%r.length;a+=r[c].x*r[l].y,a-=r[l].x*r[c].y}return Math.abs(a/2)}calculatePathLength(e,t=!1){if(e.length<2)return 0;let n=0;for(let i=0;i<e.length-1;i++)n+=this.haversineDistance(e[i].lat,e[i].lng,e[i+1].lat,e[i+1].lng);return t&&e.length>2&&(n+=this.haversineDistance(e[e.length-1].lat,e[e.length-1].lng,e[0].lat,e[0].lng)),n}calculateBoundingBox(e){if(0===e.length)return{width:0,height:0,minLat:0,maxLat:0,minLng:0,maxLng:0};const t=e.map(x=>x.lat),n=e.map(x=>x.lng),i=Math.min(...t),r=Math.max(...t),a=Math.min(...n),c=Math.max(...n);return{width:(c-a)*(111320*Math.cos(this.toRad((i+r)/2))),height:111320*(r-i),minLat:i,maxLat:r,minLng:a,maxLng:c}}formatArea(e){return e>=1e4?`${(e/1e4).toFixed(2)} ha (${e.toFixed(0)} m\xb2)`:`${e.toFixed(2)} m\xb2`}formatDistance(e){return e>=1e3?`${(e/1e3).toFixed(2)} km`:`${e.toFixed(2)} m`}getZoneInfo(e){const t=this.calculatePolygonArea(e.coordinates),n=this.calculatePathLength(e.coordinates,!0),i=this.calculateBoundingBox(e.coordinates);return{area:t,perimeter:n,vertices:e.coordinates.length,bbox:{width:i.width,height:i.height}}}getPathInfo(e){const t=this.calculatePathLength(e.coordinates,!1),n=this.calculateBoundingBox(e.coordinates);return{length:t,segments:e.coordinates.length-1,bbox:{width:n.width,height:n.height}}}static#e=g=()=>(this.\u0275fac=function(t){return new(t||v)(o.rXU(D.nX),o.rXU(A.q9),o.rXU(j.hG),o.rXU(j.K_),o.rXU(j.GD),o.rXU($.up),o.rXU(T.n),o.rXU(R.a),o.rXU(z.j),o.rXU(L.o),o.rXU(F.c),o.rXU(G.G),o.rXU(N.G))},this.\u0275cmp=o.VBU({type:v,selectors:[["app-project-editor"]],viewQuery:function(t,n){if(1&t&&(o.GBs(B,5),o.GBs(U,5),o.GBs(V,5)),2&t){let i;o.mGM(i=o.lsd())&&(n.hiddenPhotoInput=i.first),o.mGM(i=o.lsd())&&(n.galleryPhotoInput=i.first),o.mGM(i=o.lsd())&&(n.quickCameraInput=i.first)}},standalone:!1,decls:41,vars:13,consts:[["hiddenPhotoInput",""],["galleryPhotoInput",""],["quickCameraInput",""],["color","primary"],["slot","start"],[3,"click"],["slot","icon-only","name","arrow-back"],[3,"fullscreen"],["id","editorMap",1,"editor-map"],[1,"stats-panel"],[1,"stat-item"],["name","shapes-outline"],["name","git-branch-outline"],["name","location-outline"],["name","camera-outline"],["class","drawing-controls",4,"ngIf"],["class","tools-panel",4,"ngIf"],["color","light",1,"locate-btn",3,"click"],["slot","icon-only","name","locate"],["class","export-pdd-btn","color","primary",3,"disabled","click",4,"ngIf"],["class","export-kml-btn","color","success",3,"click",4,"ngIf"],["class","report-preview-overlay",4,"ngIf"],["class","ai-loading-overlay",4,"ngIf"],["type","file","accept","image/*","capture","environment",2,"position","fixed","top","-1000px","left","-1000px","opacity","0","width","1px","height","1px","pointer-events","none",3,"change"],["type","file","accept","image/*","multiple","",2,"position","fixed","top","-1000px","left","-1000px","opacity","0","width","1px","height","1px","pointer-events","none",3,"change"],["class","photo-viewer-overlay",4,"ngIf"],[1,"drawing-controls"],[1,"drawing-info"],[4,"ngIf"],[1,"drawing-buttons"],["size","small","color","medium",3,"click","disabled"],["slot","start","name","arrow-undo"],["size","small","color","danger",3,"click"],["slot","start","name","close"],["size","small","color","success",3,"disabled","click",4,"ngIf"],["size","small","color","success",3,"click","disabled"],["slot","start","name","checkmark"],[1,"tools-panel"],["color","light","title","Dibujar zona",1,"tool-btn",3,"click"],["slot","icon-only","name","shapes-outline"],["color","light","title","Trazar vial",1,"tool-btn",3,"click"],["slot","icon-only","name","git-branch-outline"],["color","light","title","Agregar punto",1,"tool-btn",3,"click"],["slot","icon-only","name","location-outline"],["color","light","title","Fototeca",1,"tool-btn",3,"click"],["slot","icon-only","name","images-outline"],["color","primary","title","Tomar foto",1,"tool-btn",3,"click"],["slot","icon-only","name","camera-outline"],["color","primary",1,"export-pdd-btn",3,"click","disabled"],["name","crescent","slot","start",4,"ngIf"],["slot","start","name","document-text-outline",4,"ngIf"],["name","crescent","slot","start"],["slot","start","name","document-text-outline"],["color","success",1,"export-kml-btn",3,"click"],["slot","start","name","earth-outline"],[1,"report-preview-overlay"],[1,"report-preview-header"],["fill","clear",3,"click"],["slot","icon-only","name","close"],[1,"report-preview-content",3,"innerHTML"],[1,"report-preview-actions"],["color","medium",3,"click"],["slot","start","name","close-outline"],["color","success",3,"click"],["slot","start","name","save-outline"],[1,"ai-loading-overlay"],[1,"ai-loading-content"],[1,"ai-loading-spinner"],["name","crescent","color","primary"],[1,"ai-loading-icon"],["name","sparkles"],[1,"ai-loading-text"],[1,"ai-title"],[1,"ai-message"],[1,"photo-viewer-overlay"],[1,"photo-viewer-topbar"],[1,"topbar-title"],[1,"close-btn",3,"click"],["name","close"],[1,"photo-viewer-scroll"],["alt","Foto",3,"src"],["class","photo-notes",4,"ngIf"],["class","photo-ai",4,"ngIf"],[1,"photo-viewer-bottom"],[1,"viewer-btn",3,"click"],["name","create-outline"],["name","sparkles-outline"],[1,"viewer-btn","delete",3,"click"],["name","trash-outline"],[1,"photo-notes"],[1,"note-header"],["name","document-text"],[1,"photo-ai"]],template:function(t,n){if(1&t){const i=o.RV6();o.j41(0,"ion-header")(1,"ion-toolbar",3)(2,"ion-buttons",4)(3,"ion-button",5),o.bIt("click",function(){return m.eBV(i),m.Njj(n.goBack())}),o.nrm(4,"ion-icon",6),o.k0s()(),o.j41(5,"ion-title"),o.EFF(6),o.k0s()()(),o.j41(7,"ion-content",7),o.nrm(8,"div",8),o.j41(9,"div",9)(10,"div",10),o.nrm(11,"ion-icon",11),o.j41(12,"span"),o.EFF(13),o.k0s()(),o.j41(14,"div",10),o.nrm(15,"ion-icon",12),o.j41(16,"span"),o.EFF(17),o.k0s()(),o.j41(18,"div",10),o.nrm(19,"ion-icon",13),o.j41(20,"span"),o.EFF(21),o.k0s()(),o.j41(22,"div",10),o.nrm(23,"ion-icon",14),o.j41(24,"span"),o.EFF(25),o.k0s()()(),o.DNE(26,Y,13,5,"div",15)(27,Z,11,0,"div",16),o.j41(28,"ion-button",17),o.bIt("click",function(){return m.eBV(i),m.Njj(n.locateMe())}),o.nrm(29,"ion-icon",18),o.k0s(),o.DNE(30,q,4,4,"ion-button",19)(31,ee,3,0,"ion-button",20)(32,te,14,1,"div",21)(33,oe,11,1,"div",22),o.j41(34,"input",23,0),o.bIt("change",function(a){return m.eBV(i),m.Njj(n.onHiddenPhotoInputChange(a))}),o.k0s(),o.j41(36,"input",24,1),o.bIt("change",function(a){return m.eBV(i),m.Njj(n.onGalleryPhotosSelected(a))}),o.k0s(),o.j41(38,"input",23,2),o.bIt("change",function(a){return m.eBV(i),m.Njj(n.onQuickCameraPhoto(a))}),o.k0s()(),o.DNE(40,ie,24,8,"div",25)}2&t&&(o.R7$(6),o.JRh((null==n.project?null:n.project.name)||"Editor"),o.R7$(),o.Y8G("fullscreen",!0),o.R7$(6),o.JRh(n.zoneCount),o.R7$(4),o.JRh(n.pathCount),o.R7$(4),o.JRh(n.markerCount),o.R7$(4),o.JRh(n.photoCount),o.R7$(),o.Y8G("ngIf","none"!==n.drawMode),o.R7$(),o.Y8G("ngIf","none"===n.drawMode),o.R7$(3),o.Y8G("ngIf","none"===n.drawMode&&!n.showReportPreview),o.R7$(),o.Y8G("ngIf","none"===n.drawMode&&!n.showReportPreview),o.R7$(),o.Y8G("ngIf",n.showReportPreview),o.R7$(),o.Y8G("ngIf",n.isAnalyzingPhoto||n.isGeneratingPDD),o.R7$(7),o.Y8G("ngIf",n.showPhotoViewer&&n.viewerPhoto))},dependencies:[C.bT,j.Jm,j.QW,j.W9,j.eU,j.iq,j.w2,j.BC,j.ai,C.vh],styles:['.editor-map[_ngcontent-%COMP%]{position:absolute;inset:0;width:100%;height:100%;z-index:1}.stats-panel[_ngcontent-%COMP%]{position:absolute;top:10px;left:10px;z-index:1000;display:flex;gap:8px;background:#fffffff2;padding:8px 12px;border-radius:12px;box-shadow:0 2px 8px #00000026}.stats-panel[_ngcontent-%COMP%]   .stat-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:4px;font-size:13px;font-weight:600;color:#333}.stats-panel[_ngcontent-%COMP%]   .stat-item[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:16px;color:var(--ion-color-primary)}.tools-panel[_ngcontent-%COMP%]{position:absolute;right:10px;top:50%;transform:translateY(-50%);z-index:1000;display:flex;flex-direction:column;gap:8px}.tools-panel[_ngcontent-%COMP%]   .tool-btn[_ngcontent-%COMP%]{--border-radius: 12px;--padding-start: 12px;--padding-end: 12px;--box-shadow: 0 2px 8px rgba(0, 0, 0, .2);width:48px;height:48px}.tools-panel[_ngcontent-%COMP%]   .tool-btn[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:22px}.drawing-controls[_ngcontent-%COMP%]{position:absolute;bottom:20px;left:10px;right:10px;z-index:1000;background:#fffffffa;border-radius:16px;padding:12px 16px;box-shadow:0 4px 16px #0003}.drawing-controls[_ngcontent-%COMP%]   .drawing-info[_ngcontent-%COMP%]{text-align:center;font-weight:600;color:var(--ion-color-primary);margin-bottom:10px;font-size:14px}.drawing-controls[_ngcontent-%COMP%]   .drawing-buttons[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:8px;flex-wrap:wrap}.drawing-controls[_ngcontent-%COMP%]   .drawing-buttons[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{--border-radius: 8px;font-size:12px}.locate-btn[_ngcontent-%COMP%]{position:absolute;top:60px;left:10px;z-index:1000;--border-radius: 50%;--padding-start: 10px;--padding-end: 10px;width:44px;height:44px;--box-shadow: 0 2px 8px rgba(0, 0, 0, .2)}.locate-btn[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:20px}.export-pdd-btn[_ngcontent-%COMP%]{position:absolute;bottom:20px;left:10px;z-index:1000;--border-radius: 12px;--box-shadow: 0 4px 12px rgba(59, 130, 246, .4);font-weight:600;font-size:13px}.export-kml-btn[_ngcontent-%COMP%]{position:absolute;bottom:20px;right:10px;z-index:1000;--border-radius: 12px;--box-shadow: 0 4px 12px rgba(16, 185, 129, .4);font-weight:600;font-size:13px}.report-preview-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;z-index:2000;background:#fff;display:flex;flex-direction:column}.report-preview-overlay[_ngcontent-%COMP%]   .report-preview-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--ion-color-primary);color:#fff}.report-preview-overlay[_ngcontent-%COMP%]   .report-preview-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:18px;font-weight:600}.report-preview-overlay[_ngcontent-%COMP%]   .report-preview-header[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{--color: white}.report-preview-overlay[_ngcontent-%COMP%]   .report-preview-content[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:0;background:#f5f5f5}.report-preview-overlay[_ngcontent-%COMP%]   .report-preview-actions[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:12px;padding:12px 16px;background:#fff;border-top:1px solid #e0e0e0;box-shadow:0 -2px 8px #0000001a}.report-preview-overlay[_ngcontent-%COMP%]   .report-preview-actions[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{--border-radius: 8px;font-weight:600}[_nghost-%COMP%]     .draw-point .draw-dot{width:24px;height:24px;background:var(--ion-color-primary);border:2px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;box-shadow:0 2px 6px #0000004d}[_nghost-%COMP%]     .photo-marker .photo-marker-dot{width:24px;height:24px;background:#10b981;border:2px solid white;border-radius:50%;box-shadow:0 2px 6px #0000004d;position:relative}[_nghost-%COMP%]     .photo-marker .photo-marker-dot:after{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:10px;height:8px;background:#fff;border-radius:2px}[_nghost-%COMP%]     .project-marker{position:relative;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3))}[_nghost-%COMP%]     .project-marker svg{display:block}[_nghost-%COMP%]     .project-marker .photo-badge{position:absolute;top:-2px;right:-4px;width:14px;height:14px;background:#3b82f6;border:2px solid white;border-radius:50%;box-shadow:0 1px 3px #0000004d}[_nghost-%COMP%]     .element-popup{padding:4px;min-width:120px}[_nghost-%COMP%]     .element-popup strong{display:block;margin-bottom:4px;color:#333}[_nghost-%COMP%]     .element-popup p{margin:4px 0;font-size:12px;color:#666}[_nghost-%COMP%]     .element-popup small{color:#999;font-size:10px}[_nghost-%COMP%]     .element-popup .ai-desc{background:#f3f4f6;padding:4px 8px;border-radius:4px;font-style:italic}[_nghost-%COMP%]     .photo-popup{text-align:center;min-width:160px}[_nghost-%COMP%]     .photo-popup img{display:block;margin:0 auto 8px}[_nghost-%COMP%]     .photo-popup p{margin:4px 0;font-size:12px;color:#333}[_nghost-%COMP%]     .photo-popup small{color:#999;font-size:10px}[_nghost-%COMP%]     .leaflet-control-zoom{margin-bottom:60px!important}.ai-loading-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;z-index:9999;background:#000000b3;display:flex;align-items:center;justify-content:center;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-content[_ngcontent-%COMP%]{background:#fff;border-radius:20px;padding:32px 48px;display:flex;flex-direction:column;align-items:center;gap:16px;box-shadow:0 8px 32px #0000004d;animation:_ngcontent-%COMP%_fadeInScale .3s ease-out;max-width:280px;text-align:center}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-spinner[_ngcontent-%COMP%]{position:relative;width:80px;height:80px;display:flex;align-items:center;justify-content:center}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-spinner[_ngcontent-%COMP%]   ion-spinner[_ngcontent-%COMP%]{--color: var(--ion-color-primary);width:80px;height:80px}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-icon[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-icon[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:32px;color:var(--ion-color-primary);animation:_ngcontent-%COMP%_sparkle 1.5s ease-in-out infinite}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-text[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:4px}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-text[_ngcontent-%COMP%]   .ai-title[_ngcontent-%COMP%]{font-size:18px;font-weight:700;color:#333}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-text[_ngcontent-%COMP%]   .ai-message[_ngcontent-%COMP%]{font-size:14px;color:#666}@keyframes _ngcontent-%COMP%_fadeInScale{0%{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}@keyframes _ngcontent-%COMP%_sparkle{0%,to{opacity:1;transform:translate(-50%,-50%) scale(1)}50%{opacity:.6;transform:translate(-50%,-50%) scale(1.1)}}.photo-viewer-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#0a0a0a;z-index:99999;display:flex;flex-direction:column}.photo-viewer-topbar[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#111;border-bottom:1px solid #222;flex-shrink:0}.photo-viewer-topbar[_ngcontent-%COMP%]   .topbar-title[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:17px;font-weight:600;color:#fff}.photo-viewer-topbar[_ngcontent-%COMP%]   .topbar-title[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:12px;color:#888}.photo-viewer-topbar[_ngcontent-%COMP%]   .close-btn[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:50%;background:#333;border:none;color:#fff;display:flex;align-items:center;justify-content:center}.photo-viewer-topbar[_ngcontent-%COMP%]   .close-btn[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:22px}.photo-viewer-scroll[_ngcontent-%COMP%]{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px}.photo-viewer-scroll[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;border-radius:12px;display:block}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-notes[_ngcontent-%COMP%], .photo-viewer-scroll[_ngcontent-%COMP%]   .photo-ai[_ngcontent-%COMP%]{margin-top:16px;padding:14px;border-radius:10px}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-notes[_ngcontent-%COMP%]   .note-header[_ngcontent-%COMP%], .photo-viewer-scroll[_ngcontent-%COMP%]   .photo-ai[_ngcontent-%COMP%]   .note-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-weight:600;font-size:14px;margin-bottom:8px}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-notes[_ngcontent-%COMP%]   .note-header[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%], .photo-viewer-scroll[_ngcontent-%COMP%]   .photo-ai[_ngcontent-%COMP%]   .note-header[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:18px}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-notes[_ngcontent-%COMP%]   p[_ngcontent-%COMP%], .photo-viewer-scroll[_ngcontent-%COMP%]   .photo-ai[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-size:14px;line-height:1.5;color:#ddd}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-notes[_ngcontent-%COMP%]{background:#10b98126;border-left:3px solid #10b981}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-notes[_ngcontent-%COMP%]   .note-header[_ngcontent-%COMP%]{color:#34d399}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-ai[_ngcontent-%COMP%]{background:#f59e0b26;border-left:3px solid #f59e0b}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-ai[_ngcontent-%COMP%]   .note-header[_ngcontent-%COMP%]{color:#fbbf24}.photo-viewer-bottom[_ngcontent-%COMP%]{display:flex;gap:10px;padding:12px 16px;background:#111;border-top:1px solid #222;flex-shrink:0}.photo-viewer-bottom[_ngcontent-%COMP%]   .viewer-btn[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:12px 8px;background:#1e293b;border:1px solid #334155;border-radius:10px;color:#94a3b8;font-size:13px;font-weight:500}.photo-viewer-bottom[_ngcontent-%COMP%]   .viewer-btn[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:18px}.photo-viewer-bottom[_ngcontent-%COMP%]   .viewer-btn.delete[_ngcontent-%COMP%]{background:#ef444426;border-color:#ef44444d;color:#f87171}']}))}return g(),v})()}];let se=(()=>{var g;class v{static#e=g=()=>(this.\u0275fac=function(t){return new(t||v)},this.\u0275mod=o.$C({type:v}),this.\u0275inj=m.G2t({imports:[E.iI.forChild(ae),E.iI]}))}return g(),v})(),ce=(()=>{var g;class v{static#e=g=()=>(this.\u0275fac=function(t){return new(t||v)},this.\u0275mod=o.$C({type:v}),this.\u0275inj=m.G2t({imports:[C.MD,O.YN,j.bv,se]}))}return g(),v})()}}]);