"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4125],{4125:(it,k,x)=>{x.r(k),x.d(k,{ProjectEditorPageModule:()=>nt});var j=x(2200),I=x(4341),_=x(7343),C=x(8132),p=x(467),M=x(4843),P=x(8244),o=x(3664),m=x(2615),O=x(2704),E=x(5032),D=x(345),S=x(7291),A=x(2092),R=x(9473),L=x(772),$=x(8426),z=x(6382),T=x(3366);const F=["hiddenPhotoInput"];function G(u,v){if(1&u&&(o.j41(0,"span"),o.EFF(1),o.k0s()),2&u){const h=o.XpG(2);o.R7$(),o.SpI("Dibujando zona (",h.currentPoints.length," puntos)")}}function N(u,v){if(1&u&&(o.j41(0,"span"),o.EFF(1),o.k0s()),2&u){const h=o.XpG(2);o.R7$(),o.SpI("Trazando vial (",h.currentPoints.length," puntos)")}}function B(u,v){1&u&&(o.j41(0,"span"),o.EFF(1,"Toca para colocar punto"),o.k0s())}function V(u,v){if(1&u){const h=o.RV6();o.j41(0,"ion-button",32),o.bIt("click",function(){m.eBV(h);const e=o.XpG(2);return m.Njj(e.finishDrawing())}),o.nrm(1,"ion-icon",33),o.EFF(2," Guardar "),o.k0s()}if(2&u){const h=o.XpG(2);o.Y8G("disabled",h.currentPoints.length<2)}}function U(u,v){if(1&u){const h=o.RV6();o.j41(0,"div",23)(1,"div",24),o.DNE(2,G,2,1,"span",25)(3,N,2,1,"span",25)(4,B,2,0,"span",25),o.k0s(),o.j41(5,"div",26)(6,"ion-button",27),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.undoLastPoint())}),o.nrm(7,"ion-icon",28),o.EFF(8," Deshacer "),o.k0s(),o.j41(9,"ion-button",29),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.cancelDrawing())}),o.nrm(10,"ion-icon",30),o.EFF(11," Cancelar "),o.k0s(),o.DNE(12,V,3,1,"ion-button",31),o.k0s()()}if(2&u){const h=o.XpG();o.R7$(2),o.Y8G("ngIf","zone"===h.drawMode),o.R7$(),o.Y8G("ngIf","path"===h.drawMode),o.R7$(),o.Y8G("ngIf","marker"===h.drawMode),o.R7$(2),o.Y8G("disabled",0===h.currentPoints.length),o.R7$(6),o.Y8G("ngIf","marker"!==h.drawMode)}}function X(u,v){if(1&u){const h=o.RV6();o.j41(0,"div",34)(1,"ion-button",35),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.setDrawMode("zone"))}),o.nrm(2,"ion-icon",36),o.k0s(),o.j41(3,"ion-button",37),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.setDrawMode("path"))}),o.nrm(4,"ion-icon",38),o.k0s(),o.j41(5,"ion-button",39),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.setDrawMode("marker"))}),o.nrm(6,"ion-icon",40),o.k0s()()}}function K(u,v){1&u&&o.nrm(0,"ion-spinner",44)}function H(u,v){1&u&&o.nrm(0,"ion-icon",45)}function Y(u,v){if(1&u){const h=o.RV6();o.j41(0,"ion-button",41),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.exportToWord())}),o.DNE(1,K,1,0,"ion-spinner",42)(2,H,1,0,"ion-icon",43),o.EFF(3),o.k0s()}if(2&u){const h=o.XpG();o.Y8G("disabled",h.isGeneratingPDD),o.R7$(),o.Y8G("ngIf",h.isGeneratingPDD),o.R7$(),o.Y8G("ngIf",!h.isGeneratingPDD),o.R7$(),o.SpI(" ",h.isGeneratingPDD?"Generando...":"Informe PDD"," ")}}function Z(u,v){if(1&u){const h=o.RV6();o.j41(0,"ion-button",46),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.exportToKMZ())}),o.nrm(1,"ion-icon",47),o.EFF(2," Archivo KML "),o.k0s()}}function W(u,v){if(1&u){const h=o.RV6();o.j41(0,"div",48)(1,"div",49)(2,"h2"),o.EFF(3,"Vista Previa del Informe"),o.k0s(),o.j41(4,"ion-button",50),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.closeReportPreview())}),o.nrm(5,"ion-icon",51),o.k0s()(),o.nrm(6,"div",52),o.j41(7,"div",53)(8,"ion-button",54),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.closeReportPreview())}),o.nrm(9,"ion-icon",55),o.EFF(10," Cancelar "),o.k0s(),o.j41(11,"ion-button",56),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.saveReportToProject())}),o.nrm(12,"ion-icon",57),o.EFF(13," Guardar en Proyecto "),o.k0s()()()}if(2&u){const h=o.XpG();o.R7$(6),o.Y8G("innerHTML",h.reportPreviewHtml,o.npT)}}function J(u,v){if(1&u&&(o.j41(0,"div",58)(1,"div",59)(2,"div",60),o.nrm(3,"ion-spinner",61),o.k0s(),o.j41(4,"div",62),o.nrm(5,"ion-icon",63),o.k0s(),o.j41(6,"div",64)(7,"span",65),o.EFF(8,"Procesando con IA"),o.k0s(),o.j41(9,"span",66),o.EFF(10),o.k0s()()()()),2&u){const h=o.XpG();o.R7$(10),o.JRh(h.aiLoadingMessage||(h.isAnalyzingPhoto?"Analizando imagen...":"Generando informe..."))}}function Q(u,v){if(1&u&&(o.j41(0,"div",82)(1,"div",83),o.nrm(2,"ion-icon",84),o.EFF(3," Notas"),o.k0s(),o.j41(4,"p"),o.EFF(5),o.k0s()()),2&u){const h=o.XpG(2);o.R7$(5),o.JRh(h.viewerPhoto.notes)}}function q(u,v){if(1&u&&(o.j41(0,"div",85)(1,"div",83),o.nrm(2,"ion-icon",63),o.EFF(3," Analisis IA"),o.k0s(),o.j41(4,"p"),o.EFF(5),o.k0s()()),2&u){const h=o.XpG(2);o.R7$(5),o.JRh(h.viewerPhoto.aiDescription)}}function tt(u,v){if(1&u){const h=o.RV6();o.j41(0,"div",67)(1,"div",68)(2,"div",69)(3,"h3"),o.EFF(4),o.k0s(),o.j41(5,"span"),o.EFF(6),o.nI1(7,"date"),o.k0s()(),o.j41(8,"button",70),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.closePhotoViewer())}),o.nrm(9,"ion-icon",71),o.k0s()(),o.j41(10,"div",72),o.nrm(11,"img",73),o.DNE(12,Q,6,1,"div",74)(13,q,6,1,"div",75),o.k0s(),o.j41(14,"div",76)(15,"button",77),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.editViewerPhotoNotes())}),o.nrm(16,"ion-icon",78),o.EFF(17," Editar "),o.k0s(),o.j41(18,"button",77),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.analyzeViewerPhotoWithAI())}),o.nrm(19,"ion-icon",79),o.EFF(20," IA "),o.k0s(),o.j41(21,"button",80),o.bIt("click",function(){m.eBV(h);const e=o.XpG();return m.Njj(e.deleteViewerPhoto())}),o.nrm(22,"ion-icon",81),o.EFF(23," Eliminar "),o.k0s()()()}if(2&u){const h=o.XpG();o.R7$(4),o.JRh((null==h.viewerMarker?null:h.viewerMarker.name)||"Foto"),o.R7$(2),o.JRh(o.i5U(7,5,h.viewerPhoto.timestamp,"dd/MM/yyyy HH:mm")),o.R7$(5),o.Y8G("src",h.viewerPhoto.imageUrl||h.viewerPhoto.localPath,o.B4B),o.R7$(),o.Y8G("ngIf",h.viewerPhoto.notes),o.R7$(),o.Y8G("ngIf",h.viewerPhoto.aiDescription)}}const et=[{path:"",component:(()=>{var u;class v{constructor(t,e,n,i,r,s,l,c,a,d,f,g,w){this.route=t,this.navCtrl=e,this.alertCtrl=n,this.toastCtrl=i,this.actionSheetCtrl=r,this.sanitizer=s,this.storageService=l,this.gpsService=c,this.cameraService=a,this.claudeService=d,this.kmlService=f,this.reportService=g,this.apiService=w,this.pendingPhotoMarkerId=null,this.project=null,this.photos=[],this.isGeneratingPDD=!1,this.isAnalyzingPhoto=!1,this.aiLoadingMessage="",this.showReportPreview=!1,this.reportPreviewHtml="",this.reportPreviewRawHtml="",this.pendingReportData=null,this.showPhotoViewer=!1,this.viewerPhoto=null,this.viewerMarker=null,this.drawMode="none",this.currentPoints=[],this.map=null,this.satelliteLayer=null,this.zonesLayer=null,this.pathsLayer=null,this.markersLayer=null,this.drawLayer=null,this.currentDrawing=null}ngOnInit(){var t=this;return(0,p.A)(function*(){const e=t.route.snapshot.paramMap.get("id");e&&(yield t.loadProject(e))})()}ngOnDestroy(){this.map&&(this.map.remove(),this.map=null)}ionViewDidEnter(){setTimeout(()=>this.initMapWithLocation(),300)}initMapWithLocation(){var t=this;return(0,p.A)(function*(){if((t.project?.markers?.length||0)>0||(t.project?.zones?.length||0)>0||(t.project?.paths?.length||0)>0||t.photos.length>0)t.initMap();else try{const n=yield t.gpsService.getCurrentPosition();t.project&&!t.project.coordinates&&(t.project.coordinates={lat:n.latitude,lng:n.longitude},yield t.saveProject()),t.initMap(n.latitude,n.longitude)}catch{console.log("No se pudo obtener ubicaci\xf3n, usando default"),t.initMap()}})()}loadProject(t){var e=this;return(0,p.A)(function*(){const n=yield e.storageService.getProject(t);if(e.photos=yield e.storageService.getPhotos(t),!n)return e.showToast("Proyecto no encontrado","danger"),void e.navCtrl.back();e.project=n,e.project.zones||(e.project.zones=[]),e.project.paths||(e.project.paths=[]),e.project.markers||(e.project.markers=[]),yield e.ensureMarkerOrders()})()}ensureMarkerOrders(){var t=this;return(0,p.A)(function*(){if(!t.project?.markers)return;let e=!1,n=0;for(const i of t.project.markers)i.order&&i.order>n&&(n=i.order);for(const i of t.project.markers)i.order||(n++,i.order=n,e=!0);e&&(yield t.saveProject())})()}initMap(t,e){if(this.map||!this.project||!document.getElementById("editorMap"))return;const i=t||this.project.coordinates?.lat||40.416775,r=e||this.project.coordinates?.lng||-3.70379;delete P.Icon.Default.prototype._getIconUrl,P.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"}),this.map=P.map("editorMap",{zoomControl:!1,maxZoom:22,minZoom:3}).setView([i,r],16),this.map.createPane("zonesPane"),this.map.getPane("zonesPane").style.zIndex="400",this.map.createPane("pathsPane"),this.map.getPane("pathsPane").style.zIndex="450",this.map.createPane("markersPane"),this.map.getPane("markersPane").style.zIndex="500",this.satelliteLayer=P.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:22,maxNativeZoom:19}).addTo(this.map),this.zonesLayer=P.layerGroup().addTo(this.map),this.pathsLayer=P.layerGroup().addTo(this.map),this.markersLayer=P.layerGroup().addTo(this.map),this.drawLayer=P.layerGroup().addTo(this.map),P.control.zoom({position:"bottomright"}).addTo(this.map),this.map.on("click",s=>this.onMapClick(s)),this.renderProjectElements()}renderProjectElements(){if(!this.project||!this.map)return;this.zonesLayer?.clearLayers(),this.pathsLayer?.clearLayers(),this.markersLayer?.clearLayers(),this.project.zones?.forEach(e=>{const n=e.coordinates.map(r=>P.latLng(r.lat,r.lng)),i=P.polygon(n,{color:e.color||"#ef4444",weight:5,fillOpacity:.25,opacity:.9,pane:"zonesPane"});i.on("click",r=>{P.DomEvent.stopPropagation(r),this.showZoneOptions(e)}),i.addTo(this.zonesLayer)}),this.project.paths?.forEach(e=>{const n=e.coordinates.map(s=>P.latLng(s.lat,s.lng)),i=P.polyline(n,{color:"transparent",weight:30,opacity:0,pane:"pathsPane"});i.on("click",s=>{P.DomEvent.stopPropagation(s),this.showPathOptions(e)}),i.addTo(this.pathsLayer);const r=P.polyline(n,{color:e.color||"#3b82f6",weight:10,opacity:.95,lineCap:"round",lineJoin:"round",pane:"pathsPane"});r.on("click",s=>{P.DomEvent.stopPropagation(s),this.showPathOptions(e)}),r.addTo(this.pathsLayer)}),this.project.markers?.forEach(e=>{this.addMarkerToMap(e)});const t=new Set;this.project.markers?.forEach(e=>{e.photoIds?.forEach(n=>t.add(n))}),this.photos.forEach(e=>{if(e.latitude&&e.longitude&&!t.has(e.id)){const n=P.divIcon({className:"photo-marker orphan-photo",html:'<div class="photo-marker-dot"></div>',iconSize:[24,24],iconAnchor:[12,12]}),i=P.marker([e.latitude,e.longitude],{icon:n,pane:"markersPane"});i.on("click",()=>this.showOrphanPhotoOptions(e)),i.addTo(this.markersLayer)}}),this.fitBoundsToContent()}fitBoundsToContent(){if(!this.map||!this.project)return;const t=[];if(this.project.zones?.forEach(e=>e.coordinates.forEach(n=>t.push(P.latLng(n.lat,n.lng)))),this.project.paths?.forEach(e=>e.coordinates.forEach(n=>t.push(P.latLng(n.lat,n.lng)))),this.project.markers?.forEach(e=>t.push(P.latLng(e.coordinate.lat,e.coordinate.lng))),this.photos.forEach(e=>{e.latitude&&e.longitude&&t.push(P.latLng(e.latitude,e.longitude))}),t.length>0){const e=P.latLngBounds(t);this.map.fitBounds(e,{padding:[50,50],maxZoom:18})}}setDrawMode(t){this.drawMode!==t?(this.cancelDrawing(),this.drawMode=t,this.setLayersInteractive("none"===t)):this.cancelDrawing()}setLayersInteractive(t){this.zonesLayer?.eachLayer(e=>{t?(e.options.interactive=!0,e._path&&(e._path.style.pointerEvents="auto")):(e.options.interactive=!1,e._path&&(e._path.style.pointerEvents="none"))}),this.pathsLayer?.eachLayer(e=>{t?(e.options.interactive=!0,e._path&&(e._path.style.pointerEvents="auto")):(e.options.interactive=!1,e._path&&(e._path.style.pointerEvents="none"))}),this.markersLayer?.eachLayer(e=>{t?(e.options.interactive=!0,e._icon&&(e._icon.style.pointerEvents="auto")):(e.options.interactive=!1,e._icon&&(e._icon.style.pointerEvents="none"))})}onMapClick(t){if("none"!==this.drawMode){if("marker"===this.drawMode)return void this.addNewMarker(t.latlng);this.currentPoints.push(t.latlng),this.updateDrawing()}}updateDrawing(){!this.drawLayer||0===this.currentPoints.length||(this.drawLayer.clearLayers(),this.currentPoints.forEach((t,e)=>{const n=P.divIcon({className:"draw-point",html:`<div class="draw-dot">${e+1}</div>`,iconSize:[24,24],iconAnchor:[12,12]});P.marker(t,{icon:n}).addTo(this.drawLayer)}),this.currentPoints.length>=2&&("zone"===this.drawMode?this.currentDrawing=P.polygon(this.currentPoints,{color:"#ef4444",weight:3,fillOpacity:.2,dashArray:"10, 5"}).addTo(this.drawLayer):"path"===this.drawMode&&(this.currentDrawing=P.polyline(this.currentPoints,{color:"#3b82f6",weight:4,dashArray:"10, 5"}).addTo(this.drawLayer))))}finishDrawing(){var t=this;return(0,p.A)(function*(){t.currentPoints.length<2||"zone"===t.drawMode&&t.currentPoints.length<3||(yield(yield t.alertCtrl.create({header:"zone"===t.drawMode?"Nueva Zona":"Nuevo Vial",inputs:[{name:"name",type:"text",placeholder:"zone"===t.drawMode?"Nombre de la zona":"Nombre del vial"},{name:"description",type:"textarea",placeholder:"Descripcion (opcional)"}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Guardar",handler:n=>!!n.name?.trim()&&(t.saveDrawing(n.name,n.description),!0)}]})).present())})()}saveDrawing(t,e){var n=this;return(0,p.A)(function*(){if(!n.project)return;const i=n.currentPoints.map(s=>({lat:s.lat,lng:s.lng})),r=`${n.drawMode}_${Date.now()}`;if("zone"===n.drawMode){const s={id:r,name:t,description:e,coordinates:i,color:"#ef4444",createdAt:(new Date).toISOString()};n.project.zones=n.project.zones||[],n.project.zones.push(s)}else if("path"===n.drawMode){const s={id:r,name:t,description:e,coordinates:i,color:"#3b82f6",createdAt:(new Date).toISOString()};n.project.paths=n.project.paths||[],n.project.paths.push(s)}yield n.saveProject(),n.cancelDrawing(),n.renderProjectElements()})()}cancelDrawing(){this.drawMode="none",this.currentPoints=[],this.currentDrawing=null,this.drawLayer?.clearLayers(),this.setLayersInteractive(!0)}undoLastPoint(){this.currentPoints.length>0&&(this.currentPoints.pop(),this.updateDrawing())}addNewMarker(t){var e=this;return(0,p.A)(function*(){var i;yield(yield e.alertCtrl.create({header:"Nuevo Punto",inputs:[{name:"name",type:"text",placeholder:"Nombre del punto"},{name:"description",type:"textarea",placeholder:"Descripcion/notas"}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Guardar",handler:(i=(0,p.A)(function*(r){return!!r.name?.trim()&&(yield e.saveMarker(t,r.name,r.description),!0)}),function(s){return i.apply(this,arguments)})}]})).present(),e.drawMode="none"})()}saveMarker(t,e,n){var i=this;return(0,p.A)(function*(){if(!i.project)return;i.project.markers=i.project.markers||[];const s=i.project.markers.reduce((c,a)=>Math.max(c,a.order||0),0)+1,l={id:`marker_${Date.now()}`,name:e,description:n,coordinate:{lat:t.lat,lng:t.lng},order:s,createdAt:(new Date).toISOString()};i.project.markers.push(l),yield i.saveProject(),i.renderProjectElements()})()}takePhotoForMarkerId(t){var e=this;return(0,p.A)(function*(){const n=e.project?.markers?.find(i=>i.id===t);if(n)try{console.log("Abriendo c\xe1mara para marcador:",n.name);const i=yield e.cameraService.takePhoto();if(console.log("Foto capturada:",i?"OK":"null"),i&&e.project){const r=i.base64?`data:image/jpeg;base64,${i.base64}`:i.webviewPath||i.webPath,s={id:`photo_${Date.now()}`,projectId:e.project.id,localPath:i.filepath,imageUrl:r,latitude:n.coordinate.lat,longitude:n.coordinate.lng,timestamp:(new Date).toISOString(),synced:!1,notes:`Punto ${n.order||"?"}: ${n.name}`};yield e.storageService.savePhoto(s),e.photos.push(s);const l=e.project.markers?.find(c=>c.id===t);l&&(l.photoIds=l.photoIds||[],l.photoIds.push(s.id),console.log("Foto a\xf1adida al marcador. Total fotos:",l.photoIds.length)),yield e.saveProject(),e.renderProjectElements()}}catch(i){console.error("Error tomando foto:",i)}else console.error("Marcador no encontrado:",t)})()}onHiddenPhotoInputChange(t){var e=this;return(0,p.A)(function*(){const n=t.target,i=n.files?.[0];try{yield e.actionSheetCtrl.dismiss()}catch{}if(!i||!e.pendingPhotoMarkerId||!e.project)return console.log("No file, markerId or project:",{file:!!i,markerId:e.pendingPhotoMarkerId,project:!!e.project}),e.pendingPhotoMarkerId=null,void(n.value="");const r=e.pendingPhotoMarkerId,s=e.project.markers?.find(l=>l.id===r);if(!s)return console.error("Marcador no encontrado:",r),e.pendingPhotoMarkerId=null,void(n.value="");try{const c=`data:image/jpeg;base64,${yield e.fileToBase64(i)}`,a={id:`photo_${Date.now()}`,projectId:e.project.id,localPath:`web_${Date.now()}.jpeg`,imageUrl:c,latitude:s.coordinate.lat,longitude:s.coordinate.lng,timestamp:(new Date).toISOString(),synced:!1,notes:`Punto ${s.order||"?"}: ${s.name}`};yield e.storageService.savePhoto(a),e.photos.push(a);const d=e.project.markers?.find(f=>f.id===r);d&&(d.photoIds=d.photoIds||[],d.photoIds.push(a.id),console.log("Foto a\xf1adida al marcador. Total fotos:",d.photoIds.length)),yield e.saveProject(),e.renderProjectElements()}catch(l){console.error("Error procesando foto:",l),(l?.message?.includes("cuota")||l?.message?.includes("quota"))&&e.showToast("Sin espacio. Elimina fotos antiguas.","warning")}finally{e.pendingPhotoMarkerId=null,n.value=""}})()}fileToBase64(t){return new Promise((e,n)=>{const i=new Image,r=document.createElement("canvas"),s=r.getContext("2d");i.onload=()=>{let a=i.width,d=i.height;a>d?a>800&&(d=Math.round(800*d/a),a=800):d>800&&(a=Math.round(800*a/d),d=800),r.width=a,r.height=d,s?.drawImage(i,0,0,a,d);const g=r.toDataURL("image/jpeg",.6).split(",")[1];e(g)},i.onerror=n;const l=new FileReader;l.onerror=n,l.onload=()=>{i.src=l.result},l.readAsDataURL(t)})}takePhotoForMarker(t){var e=this;return(0,p.A)(function*(){yield e.takePhotoForMarkerId(t.id)})()}addMarkerToMap(t){const e=t.photoIds&&t.photoIds.length>0,n=e?"#10b981":"#f59e0b",l=P.divIcon({className:e?"project-marker has-photo":"project-marker",html:`\n      <svg width="32" height="42" viewBox="0 0 32 42" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path d="M16 0C7.163 0 0 7.163 0 16c0 10.5 14.4 25 15.1 25.7a1.2 1.2 0 001.8 0C17.6 41 32 26.5 32 16c0-8.837-7.163-16-16-16z" fill="${n}"/>\n        <circle cx="16" cy="16" r="11" fill="white"/>\n        <text x="16" y="21" text-anchor="middle" font-size="14" font-weight="bold" fill="${n}" font-family="Arial, sans-serif">${t.order||"?"}</text>\n      </svg>\n      ${e?'<span class="photo-badge"></span>':""}\n    `,iconSize:[32,42],iconAnchor:[16,42]}),c=P.marker([t.coordinate.lat,t.coordinate.lng],{icon:l,pane:"markersPane"});c.on("click",()=>this.showMarkerOptionsById(t.id)),c.addTo(this.markersLayer)}showMarkerOptionsById(t){var e=this;return(0,p.A)(function*(){const n=e.project?.markers?.find(i=>i.id===t);n&&(yield e.showMarkerOptions(n))})()}showMarkerOptions(t){var e=this;return(0,p.A)(function*(){const n=t.id,i=t.photoIds&&t.photoIds.length>0,r=i?e.photos.filter(c=>t.photoIds.includes(c.id)):[],s=[];i&&s.push({text:`Ver ${r.length} foto${r.length>1?"s":""}`,icon:"images-outline",handler:()=>{const c=e.project?.markers?.find(a=>a.id===n);if(c){const a=e.photos.filter(d=>c.photoIds?.includes(d.id));e.showMarkerPhotos(c,a)}}}),s.push({text:"Tomar foto",icon:"camera-outline",handler:()=>(e.pendingPhotoMarkerId=n,e.hiddenPhotoInput?.nativeElement&&e.hiddenPhotoInput.nativeElement.click(),!1)}),s.push({text:"Analizar con IA",icon:"sparkles-outline",handler:()=>{const c=e.project?.markers?.find(a=>a.id===n);if(c&&c.photoIds&&c.photoIds.length>0){const a=e.photos.filter(d=>c.photoIds?.includes(d.id));e.analyzeMarkerPhotosWithAI(a)}else e.showNoPhotosAlert()}}),s.push({text:"Editar notas",icon:"create-outline",handler:()=>{const c=e.project?.markers?.find(a=>a.id===n);c&&e.editMarkerNotes(c)}}),s.push({text:"Eliminar punto",icon:"trash-outline",role:"destructive",handler:()=>{const c=e.project?.markers?.find(a=>a.id===n);c&&e.deleteMarker(c)}}),s.push({text:"Cancelar",icon:"close",role:"cancel"}),yield(yield e.actionSheetCtrl.create({header:t.name,subHeader:t.description||t.aiDescription||`${t.coordinate.lat.toFixed(5)}, ${t.coordinate.lng.toFixed(5)}`,buttons:s})).present()})()}showNoPhotosAlert(){var t=this;return(0,p.A)(function*(){yield(yield t.alertCtrl.create({header:"Sin fotos",message:"Primero debes tomar una foto para poder analizarla con IA.",buttons:["Entendido"]})).present()})()}analyzeMarkerPhotosWithAI(t){var e=this;return(0,p.A)(function*(){for(const n of t)n.aiDescription||(yield e.analyzePhotoWithAI(n));e.renderProjectElements()})()}editMarkerNotes(t){var e=this;return(0,p.A)(function*(){var i;yield(yield e.alertCtrl.create({header:"Editar notas",inputs:[{name:"notes",type:"textarea",placeholder:"Escribe tus notas aqu\xed...",value:t.description||""}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Guardar",handler:(i=(0,p.A)(function*(r){t.description=r.notes,yield e.saveProject(),e.renderProjectElements()}),function(s){return i.apply(this,arguments)})}]})).present()})()}showMarkerPhotos(t,e){var n=this;return(0,p.A)(function*(){if(1===e.length)n.showPhotoDetail(e[0],t);else{const i=e.map((s,l)=>({text:`Foto ${l+1} - ${new Date(s.timestamp||"").toLocaleDateString("es-ES")}`,handler:()=>n.showPhotoDetail(s,t)}));i.push({text:"Cancelar",role:"cancel"}),yield(yield n.actionSheetCtrl.create({header:"Seleccionar foto",buttons:i})).present()}})()}showPhotoDetail(t,e){var n=this;return(0,p.A)(function*(){n.viewerPhoto=t,n.viewerMarker=e,n.showPhotoViewer=!0})()}closePhotoViewer(){this.showPhotoViewer=!1,this.viewerPhoto=null,this.viewerMarker=null}editViewerPhotoNotes(){var t=this;return(0,p.A)(function*(){if(t.viewerPhoto){yield t.editPhotoNotes(t.viewerPhoto);const e=t.photos.find(n=>n.id===t.viewerPhoto?.id);e&&(t.viewerPhoto=e)}})()}analyzeViewerPhotoWithAI(){var t=this;return(0,p.A)(function*(){if(t.viewerPhoto){const e=t.viewerPhoto;t.closePhotoViewer(),yield t.analyzePhotoWithAI(e)}})()}deleteViewerPhoto(){var t=this;return(0,p.A)(function*(){if(t.viewerPhoto&&t.viewerMarker){const e=t.viewerPhoto,n=t.viewerMarker;t.closePhotoViewer(),yield t.deleteMarkerPhoto(e,n)}})()}deleteMarkerPhoto(t,e){var n=this;return(0,p.A)(function*(){var r;yield(yield n.alertCtrl.create({header:"Eliminar foto",message:"\xbfSeguro que quieres eliminar esta foto?",buttons:[{text:"Cancelar",role:"cancel"},{text:"Eliminar",role:"destructive",handler:(r=(0,p.A)(function*(){yield n.storageService.deletePhoto(t.id),n.photos=n.photos.filter(s=>s.id!==t.id),e.photoIds&&(e.photoIds=e.photoIds.filter(s=>s!==t.id),yield n.saveProject()),n.renderProjectElements()}),function(){return r.apply(this,arguments)})}]})).present()})()}editPhotoNotes(t){var e=this;return(0,p.A)(function*(){var i;yield(yield e.alertCtrl.create({header:"Editar notas de la foto",inputs:[{name:"notes",type:"textarea",placeholder:"Escribe tus notas...",value:t.notes||""}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Guardar",handler:(i=(0,p.A)(function*(r){t.notes=r.notes,yield e.storageService.updatePhoto(t);const s=e.photos.findIndex(l=>l.id===t.id);s>=0&&(e.photos[s]=t)}),function(s){return i.apply(this,arguments)})}]})).present()})()}showOrphanPhotoOptions(t){var e=this;return(0,p.A)(function*(){const n=[{text:"Editar notas",icon:"create-outline",handler:()=>e.editPhotoNotes(t)},{text:"Analizar con IA",icon:"sparkles-outline",handler:()=>e.analyzePhotoWithAI(t)},{text:"Eliminar foto",icon:"trash-outline",role:"destructive",handler:()=>e.deleteOrphanPhoto(t)},{text:"Cancelar",icon:"close",role:"cancel"}];yield(yield e.actionSheetCtrl.create({header:"Foto",subHeader:t.notes||t.aiDescription||`${t.latitude?.toFixed(5)}, ${t.longitude?.toFixed(5)}`,buttons:n})).present()})()}deleteOrphanPhoto(t){var e=this;return(0,p.A)(function*(){var i;yield(yield e.alertCtrl.create({header:"Eliminar foto",message:"\xbfSeguro que quieres eliminar esta foto?",buttons:[{text:"Cancelar",role:"cancel"},{text:"Eliminar",role:"destructive",handler:(i=(0,p.A)(function*(){yield e.storageService.deletePhoto(t.id),e.photos=e.photos.filter(r=>r.id!==t.id),e.renderProjectElements()}),function(){return i.apply(this,arguments)})}]})).present()})()}deleteMarker(t){var e=this;return(0,p.A)(function*(){const n=e.project?.markers?.find(l=>l.id===t.id);if(!n)return;const i=n.photoIds&&n.photoIds.length>0,r=n.photoIds?.length||0;var l;yield(yield e.alertCtrl.create({header:"Eliminar punto",message:i?`\xbfSeguro que quieres eliminar "${n.name}" y sus ${r} foto${r>1?"s":""} asociada${r>1?"s":""}?`:`\xbfSeguro que quieres eliminar "${n.name}"?`,buttons:[{text:"Cancelar",role:"cancel"},{text:"Eliminar",role:"destructive",handler:(l=(0,p.A)(function*(){if(e.project){const c=e.project.markers?.find(a=>a.id===t.id);if(c?.photoIds&&c.photoIds.length>0)for(const a of c.photoIds)yield e.storageService.deletePhoto(a),e.photos=e.photos.filter(d=>d.id!==a);e.project.markers=e.project.markers?.filter(a=>a.id!==t.id),yield e.saveProject(),e.renderProjectElements()}}),function(){return l.apply(this,arguments)})}]})).present()})()}showZoneOptions(t){var e=this;return(0,p.A)(function*(){const n=e.getZoneInfo(t),i=[{text:"Ver informaci\xf3n detallada",icon:"information-circle-outline",handler:()=>e.showZoneDetails(t,n)},{text:"Editar nombre/descripci\xf3n",icon:"create-outline",handler:()=>e.editZone(t)},{text:"Eliminar zona",icon:"trash-outline",role:"destructive",handler:()=>e.deleteZone(t)},{text:"Cancelar",icon:"close",role:"cancel"}];yield(yield e.actionSheetCtrl.create({header:t.name,subHeader:`\xc1rea: ${e.formatArea(n.area)} | Per\xedmetro: ${e.formatDistance(n.perimeter)}`,buttons:i})).present()})()}showZoneDetails(t,e){var n=this;return(0,p.A)(function*(){const i=`\n\u{1f4d0} \xc1REA: ${n.formatArea(e.area)}\n\n\u{1f4cf} PER\xcdMETRO: ${n.formatDistance(e.perimeter)}\n\n\u{1f4cd} V\xc9RTICES: ${e.vertices} puntos\n\n\u{1f4e6} DIMENSIONES:\n   \u2022 Ancho: ${n.formatDistance(e.bbox.width)}\n   \u2022 Alto: ${n.formatDistance(e.bbox.height)}\n\n${t.description?"\u{1f4dd} DESCRIPCI\xd3N:\n"+t.description:""}\n    `.trim();yield(yield n.alertCtrl.create({header:t.name,subHeader:"Informaci\xf3n de la zona",message:i,buttons:["Cerrar"]})).present()})()}editZone(t){var e=this;return(0,p.A)(function*(){var i;yield(yield e.alertCtrl.create({header:"Editar zona",inputs:[{name:"name",type:"text",placeholder:"Nombre de la zona",value:t.name},{name:"description",type:"textarea",placeholder:"Descripci\xf3n (opcional)",value:t.description||""}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Guardar",handler:(i=(0,p.A)(function*(r){r.name?.trim()&&(t.name=r.name,t.description=r.description,yield e.saveProject(),e.renderProjectElements())}),function(s){return i.apply(this,arguments)})}]})).present()})()}deleteZone(t){var e=this;return(0,p.A)(function*(){var i;yield(yield e.alertCtrl.create({header:"Eliminar zona",message:`\xbfSeguro que quieres eliminar "${t.name}"?`,buttons:[{text:"Cancelar",role:"cancel"},{text:"Eliminar",role:"destructive",handler:(i=(0,p.A)(function*(){e.project&&(e.project.zones=e.project.zones?.filter(r=>r.id!==t.id),yield e.saveProject(),e.renderProjectElements())}),function(){return i.apply(this,arguments)})}]})).present()})()}showPathOptions(t){var e=this;return(0,p.A)(function*(){const n=e.getPathInfo(t),i=[{text:"Ver informaci\xf3n detallada",icon:"information-circle-outline",handler:()=>e.showPathDetails(t,n)},{text:"Editar nombre/descripci\xf3n",icon:"create-outline",handler:()=>e.editPath(t)},{text:"Eliminar trazado",icon:"trash-outline",role:"destructive",handler:()=>e.deletePath(t)},{text:"Cancelar",icon:"close",role:"cancel"}];yield(yield e.actionSheetCtrl.create({header:t.name,subHeader:`Longitud: ${e.formatDistance(n.length)} | ${n.segments} tramos`,buttons:i})).present()})()}showPathDetails(t,e){var n=this;return(0,p.A)(function*(){const i=`\n\u{1f4cf} LONGITUD TOTAL: ${n.formatDistance(e.length)}\n\n\u{1f517} TRAMOS: ${e.segments} segmentos\n\n\u{1f4cd} PUNTOS: ${t.coordinates.length} v\xe9rtices\n\n\u{1f4e6} EXTENSI\xd3N:\n   \u2022 Ancho: ${n.formatDistance(e.bbox.width)}\n   \u2022 Alto: ${n.formatDistance(e.bbox.height)}\n\n${t.description?"\u{1f4dd} DESCRIPCI\xd3N:\n"+t.description:""}\n    `.trim();yield(yield n.alertCtrl.create({header:t.name,subHeader:"Informaci\xf3n del trazado",message:i,buttons:["Cerrar"]})).present()})()}editPath(t){var e=this;return(0,p.A)(function*(){var i;yield(yield e.alertCtrl.create({header:"Editar trazado",inputs:[{name:"name",type:"text",placeholder:"Nombre del trazado",value:t.name},{name:"description",type:"textarea",placeholder:"Descripci\xf3n (opcional)",value:t.description||""}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Guardar",handler:(i=(0,p.A)(function*(r){r.name?.trim()&&(t.name=r.name,t.description=r.description,yield e.saveProject(),e.renderProjectElements())}),function(s){return i.apply(this,arguments)})}]})).present()})()}deletePath(t){var e=this;return(0,p.A)(function*(){var i;yield(yield e.alertCtrl.create({header:"Eliminar trazado",message:`\xbfSeguro que quieres eliminar "${t.name}"?`,buttons:[{text:"Cancelar",role:"cancel"},{text:"Eliminar",role:"destructive",handler:(i=(0,p.A)(function*(){e.project&&(e.project.paths=e.project.paths?.filter(r=>r.id!==t.id),yield e.saveProject(),e.renderProjectElements())}),function(){return i.apply(this,arguments)})}]})).present()})()}createPhotoPopup(t){const e=t.imageUrl||t.localPath||"";return`<div class="photo-popup">${e?`<img src="${e}" style="max-width:150px;border-radius:8px;">`:""}<p>${t.notes||t.aiDescription||"Sin descripcion"}</p><small>${t.latitude?.toFixed(5)}, ${t.longitude?.toFixed(5)}</small></div>`}takePhoto(){var t=this;return(0,p.A)(function*(){try{const e=yield t.gpsService.getCurrentPosition(),n=yield t.cameraService.takePhoto();if(n&&t.project){const i=n.base64?`data:image/jpeg;base64,${n.base64}`:n.webviewPath||n.webPath,r={id:`photo_${Date.now()}`,projectId:t.project.id,localPath:n.filepath,imageUrl:i,latitude:e.latitude,longitude:e.longitude,altitude:e.altitude,timestamp:(new Date).toISOString(),synced:!1};yield t.storageService.savePhoto(r),t.photos.push(r),t.renderProjectElements(),t.map&&t.map.setView([e.latitude,e.longitude],18)}}catch{}})()}analyzePhotoWithAI(t){var e=this;return(0,p.A)(function*(){e.isAnalyzingPhoto=!0,e.aiLoadingMessage="Analizando imagen con IA...";try{const n=t.imageUrl||t.localPath||"",i=yield e.claudeService.analyzeImage(n);t.aiDescription=i,yield e.storageService.updatePhoto(t);const r=e.photos.findIndex(s=>s.id===t.id);r>=0&&(e.photos[r]=t),e.renderProjectElements()}catch{}finally{e.isAnalyzingPhoto=!1,e.aiLoadingMessage=""}})()}captureMapScreenshot(){var t=this;return(0,p.A)(function*(){if(!t.map||!t.project)return"";try{const i=document.createElement("canvas");i.width=800,i.height=500;const r=i.getContext("2d");if(!r)return"";r.fillStyle="#e5e7eb",r.fillRect(0,0,800,500);const s=t.getContentBounds();if(!s)return"";r.strokeStyle="#d1d5db",r.lineWidth=1;for(let c=0;c<800;c+=50)r.beginPath(),r.moveTo(c,0),r.lineTo(c,500),r.stroke();for(let c=0;c<500;c+=50)r.beginPath(),r.moveTo(0,c),r.lineTo(800,c),r.stroke();const l=(c,a)=>({x:(a-s.west)/(s.east-s.west)*720+40,y:(s.north-c)/(s.north-s.south)*420+40});return t.project.zones&&t.project.zones.forEach(c=>{if(c.coordinates.length<3)return;r.beginPath();const a=l(c.coordinates[0].lat,c.coordinates[0].lng);r.moveTo(a.x,a.y),c.coordinates.forEach((d,f)=>{if(f>0){const g=l(d.lat,d.lng);r.lineTo(g.x,g.y)}}),r.closePath(),r.fillStyle="rgba(239, 68, 68, 0.3)",r.fill(),r.strokeStyle="#ef4444",r.lineWidth=3,r.stroke()}),t.project.paths&&t.project.paths.forEach(c=>{if(c.coordinates.length<2)return;r.beginPath();const a=l(c.coordinates[0].lat,c.coordinates[0].lng);r.moveTo(a.x,a.y),c.coordinates.forEach((d,f)=>{if(f>0){const g=l(d.lat,d.lng);r.lineTo(g.x,g.y)}}),r.strokeStyle="#3b82f6",r.lineWidth=5,r.lineCap="round",r.lineJoin="round",r.stroke()}),t.project.markers&&t.project.markers.forEach(c=>{const a=l(c.coordinate.lat,c.coordinate.lng),f=c.photoIds&&c.photoIds.length>0?"#10b981":"#f59e0b",g=c.order||"?";r.shadowColor="rgba(0,0,0,0.3)",r.shadowBlur=4,r.shadowOffsetY=2,r.beginPath(),r.fillStyle=f,r.arc(a.x,a.y-18,16,0,2*Math.PI),r.fill(),r.beginPath(),r.moveTo(a.x-10,a.y-8),r.lineTo(a.x,a.y+2),r.lineTo(a.x+10,a.y-8),r.fill(),r.shadowColor="transparent",r.beginPath(),r.fillStyle="white",r.arc(a.x,a.y-18,11,0,2*Math.PI),r.fill(),r.fillStyle=f,r.font="bold 14px Arial",r.textAlign="center",r.textBaseline="middle",r.fillText(String(g),a.x,a.y-17)}),r.shadowColor="transparent",r.fillStyle="rgba(0,0,0,0.7)",r.fillRect(0,470,800,30),r.fillStyle="white",r.font="14px Arial",r.textAlign="center",r.fillText(`${t.project.name} - ${t.project.markers?.length||0} puntos, ${t.project.zones?.length||0} zonas, ${t.project.paths?.length||0} viales`,400,488),i.toDataURL("image/jpeg",.9)}catch(e){return console.error("Error generando mapa:",e),""}})()}getContentBounds(){if(!this.project)return null;const t=[],e=[];if(this.project.markers?.forEach(a=>{t.push(a.coordinate.lat),e.push(a.coordinate.lng)}),this.project.zones?.forEach(a=>{a.coordinates.forEach(d=>{t.push(d.lat),e.push(d.lng)})}),this.project.paths?.forEach(a=>{a.coordinates.forEach(d=>{t.push(d.lat),e.push(d.lng)})}),0===t.length)return null;const n=Math.max(...t),i=Math.min(...t),r=Math.max(...e),s=Math.min(...e),l=.1*(n-i)||.001,c=.1*(r-s)||.001;return{north:n+l,south:i-l,east:r+c,west:s-c}}showExportOptions(){var t=this;return(0,p.A)(function*(){yield(yield t.actionSheetCtrl.create({header:"Exportar Proyecto",buttons:[{text:"Exportar a KMZ (Google Earth)",icon:"globe-outline",handler:()=>t.exportToKMZ()},{text:"Generar Informe Word",icon:"document-text-outline",handler:()=>t.exportToWord()},{text:"Cancelar",icon:"close",role:"cancel"}]})).present()})()}exportToKMZ(){var t=this;return(0,p.A)(function*(){t.project&&(yield t.saveKmlToProject())})()}exportToWord(){var t=this;return(0,p.A)(function*(){if(t.project&&!t.isGeneratingPDD){t.isGeneratingPDD=!0;try{t.aiLoadingMessage="Capturando mapa...";const e=yield t.captureMapScreenshot(),n=[];for(const a of t.photos){let f,g,d="";if(a.imageUrl)d=a.imageUrl;else if(a.localPath)try{d=yield t.cameraService.getPhotoBase64(a.localPath)}catch{}const w=t.project?.markers?.find(y=>y.photoIds?.includes(a.id));w&&(f=w.order,g=w.name),n.push({id:a.id,base64:d,description:a.notes,aiDescription:a.aiDescription,latitude:a.latitude,longitude:a.longitude,timestamp:a.timestamp,location:a.location,catastroRef:a.catastroRef,markerOrder:f,markerName:g})}n.sort((a,d)=>void 0===a.markerOrder&&void 0===d.markerOrder?0:void 0===a.markerOrder?1:void 0===d.markerOrder?-1:a.markerOrder-d.markerOrder);const i=t.project.markers?.map(a=>({order:a.order||0,name:a.name,description:a.description,aiDescription:a.aiDescription,latitude:a.coordinate.lat,longitude:a.coordinate.lng,photoCount:a.photoIds?.length||0})).sort((a,d)=>a.order-d.order)||[],r=t.project.zones?.map(a=>{const d=t.getZoneInfo(a);return{name:a.name,description:a.description,area:d.area,areaFormatted:t.formatArea(d.area),perimeter:d.perimeter,perimeterFormatted:t.formatDistance(d.perimeter),vertices:d.vertices,dimensions:`${t.formatDistance(d.bbox.width)} x ${t.formatDistance(d.bbox.height)}`}}),s=t.project.paths?.map(a=>{const d=t.getPathInfo(a);return{name:a.name,description:a.description,length:d.length,lengthFormatted:t.formatDistance(d.length),segments:d.segments,dimensions:`${t.formatDistance(d.bbox.width)} x ${t.formatDistance(d.bbox.height)}`}});t.aiLoadingMessage="Generando resumen con IA...";let l="";try{const a={projectName:t.project.name,projectLocation:t.project.location,zones:r?.map(f=>({name:f.name,description:f.description,area:f.areaFormatted,perimeter:f.perimeterFormatted,vertices:f.vertices})),paths:s?.map(f=>({name:f.name,description:f.description,length:f.lengthFormatted,segments:f.segments})),photos:t.photos.map(f=>({description:f.notes,aiDescription:f.aiDescription,location:f.location,latitude:f.latitude,longitude:f.longitude}))};l=(yield t.claudeService.generateProjectReport(a)).summary||""}catch{l="Resumen no disponible (sin conexi\xf3n a IA)"}t.aiLoadingMessage="";const c={projectName:t.project.name,projectDescription:t.project.description,projectLocation:t.project.location,createdAt:t.project.createdAt.toString(),aiSummary:l,mapScreenshot:e,markers:i,photos:n,zones:r,paths:s,notes:t.project.notes};t.pendingReportData=c,t.reportPreviewRawHtml=t.reportService.generateHtmlPreview(c),t.reportPreviewHtml=t.sanitizer.bypassSecurityTrustHtml(t.reportPreviewRawHtml),t.showReportPreview=!0}catch(e){console.error("Error generando informe:",e)}finally{t.isGeneratingPDD=!1}}})()}closeReportPreview(){this.showReportPreview=!1,this.reportPreviewHtml="",this.reportPreviewRawHtml="",this.pendingReportData=null}downloadReport(){var t=this;return(0,p.A)(function*(){if(t.pendingReportData&&t.project)try{yield t.reportService.downloadReport(t.pendingReportData),t.closeReportPreview()}catch(e){console.error("Error descargando informe:",e)}})()}saveReportToProject(){var t=this;return(0,p.A)(function*(){if(console.log("saveReportToProject llamado",{pendingReportData:!!t.pendingReportData,project:!!t.project}),t.pendingReportData&&t.project)try{const e=new Date,r=`Informe PDD ${e.toLocaleDateString("es-ES")} ${e.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}`,s=localStorage.getItem("token"),l=t.project.serverId||t.project.id;if(s)try{return console.log("Guardando informe en la nube:",r),yield(0,M._)(t.apiService.createReport(l,r,t.reportPreviewRawHtml)),console.log("Informe guardado en la nube"),yield(yield t.alertCtrl.create({header:"Informe guardado",message:`El informe "${r}" se ha guardado correctamente.`,buttons:["OK"]})).present(),void t.closeReportPreview()}catch(d){console.warn("Error guardando en la nube, intentando local:",d)}const c={id:`report_${Date.now()}`,name:r,htmlContent:t.reportPreviewRawHtml,createdAt:e.toISOString()};t.project.reports=t.project.reports||[],t.project.reports.push(c),yield t.saveProject(),console.log("Informe guardado localmente. Total informes:",t.project.reports.length),yield(yield t.alertCtrl.create({header:"Informe guardado",message:`El informe "${r}" se ha guardado correctamente.`,buttons:["OK"]})).present(),t.closeReportPreview()}catch(e){console.error("Error guardando informe:",e),yield(yield t.alertCtrl.create({header:"Error",message:"No se pudo guardar el informe: "+e.message,buttons:["OK"]})).present()}else console.error("No hay datos de reporte o proyecto")})()}downloadReportAsHtml(t,e){const n=new Blob([e],{type:"text/html"}),i=URL.createObjectURL(n),r=document.createElement("a");r.href=i,r.download=`${t.replace(/[^a-zA-Z0-9]/g,"_")}.html`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),this.showToast("Informe descargado","success")}saveKmlToProject(){var t=this;return(0,p.A)(function*(){if(console.log("saveKmlToProject llamado",{project:!!t.project}),t.project)try{const e={name:t.project.name,description:t.project.description,location:t.project.location,createdAt:t.project.createdAt.toString(),photos:t.photos.map(g=>({id:g.id,url:g.imageUrl||g.localPath||"",description:g.notes||g.aiDescription,latitude:g.latitude,longitude:g.longitude,timestamp:g.timestamp})),zones:t.project.zones?.map(g=>({name:g.name,description:g.description,coordinates:g.coordinates})),paths:t.project.paths?.map(g=>({name:g.name,description:g.description,coordinates:g.coordinates})),markers:t.project.markers?.map(g=>{const w=g.photoIds?.map(y=>{const b=t.photos.find(rt=>rt.id===y);return b?{id:b.id,base64:b.imageUrl||b.localPath||"",notes:b.notes,aiDescription:b.aiDescription}:null}).filter(y=>null!==y)||[];return{name:g.name,description:g.description,aiDescription:g.aiDescription,coordinate:g.coordinate,photos:w}})};console.log("Generando KML...",e);const n=t.kmlService.generateKml(e),i=new Date,l=`Informe KML ${i.toLocaleDateString("es-ES")} ${i.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}`;console.log("Guardando KML:",l);const c=localStorage.getItem("token"),a=t.project.serverId||t.project.id;if(c)try{return yield(0,M._)(t.apiService.createKml(a,l,n)),console.log("KML guardado en la nube"),void(yield(yield t.alertCtrl.create({header:"Archivo KML guardado",message:`El archivo "${l}.kml" se ha guardado correctamente.`,buttons:["OK"]})).present())}catch(g){console.warn("Error guardando KML en la nube, intentando local:",g)}const d={id:`kml_${Date.now()}`,name:l,kmlContent:n,createdAt:i.toISOString()};t.project.kmls=t.project.kmls||[],t.project.kmls.push(d),yield t.saveProject(),console.log("KML guardado localmente. Total KMLs:",t.project.kmls.length),yield(yield t.alertCtrl.create({header:"Archivo KML guardado",message:`El archivo "${l}.kml" se ha guardado correctamente.`,buttons:["OK"]})).present()}catch(e){console.error("Error guardando KML:",e),yield(yield t.alertCtrl.create({header:"Error",message:"No se pudo guardar el archivo KML: "+e.message,buttons:["OK"]})).present()}else console.error("No hay proyecto")})()}downloadKmlFile(t,e){const n=new Blob([e],{type:"application/vnd.google-earth.kml+xml"}),i=URL.createObjectURL(n),r=document.createElement("a");r.href=i,r.download=`${t.replace(/[^a-zA-Z0-9_-]/g,"_")}.kml`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),this.showToast("Archivo KML descargado","success")}blobToBase64(t){return new Promise((e,n)=>{const i=new FileReader;i.onerror=n,i.onload=()=>e(i.result),i.readAsDataURL(t)})}locateMe(){var t=this;return(0,p.A)(function*(){try{const e=yield t.gpsService.getCurrentPosition();t.map&&t.map.setView([e.latitude,e.longitude],18)}catch{}})()}saveProject(){var t=this;return(0,p.A)(function*(){t.project&&(t.project.updatedAt=new Date,yield t.storageService.saveProject(t.project),t.project.serverId&&t.syncProjectContent())})()}syncProjectContent(){var t=this;return(0,p.A)(function*(){if(t.project?.serverId)try{const e={zones:t.project.zones||[],paths:t.project.paths||[],markers:t.project.markers||[],coordinates:t.project.coordinates};yield(0,M._)(t.apiService.put(`/projects/${t.project.serverId}/content`,e)),console.log("Contenido sincronizado con servidor")}catch(e){console.log("Error sincronizando contenido:",e?.message)}})()}goBack(){this.navCtrl.back()}showToast(t,e){var n=this;return(0,p.A)(function*(){yield(yield n.toastCtrl.create({message:t,duration:2e3,position:"top",color:e})).present()})()}get zoneCount(){return this.project?.zones?.length||0}get pathCount(){return this.project?.paths?.length||0}get markerCount(){return this.project?.markers?.length||0}get photoCount(){return this.photos.length}haversineDistance(t,e,n,i){const s=this.toRad(n-t),l=this.toRad(i-e),c=Math.sin(s/2)*Math.sin(s/2)+Math.cos(this.toRad(t))*Math.cos(this.toRad(n))*Math.sin(l/2)*Math.sin(l/2);return 2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))*6371e3}toRad(t){return t*(Math.PI/180)}calculatePolygonArea(t){if(t.length<3)return 0;const e=t.reduce((l,c)=>l+c.lat,0)/t.length,i=111320*Math.cos(this.toRad(e)),r=t.map(l=>({x:(l.lng-t[0].lng)*i,y:111320*(l.lat-t[0].lat)}));let s=0;for(let l=0;l<r.length;l++){const c=(l+1)%r.length;s+=r[l].x*r[c].y,s-=r[c].x*r[l].y}return Math.abs(s/2)}calculatePathLength(t,e=!1){if(t.length<2)return 0;let n=0;for(let i=0;i<t.length-1;i++)n+=this.haversineDistance(t[i].lat,t[i].lng,t[i+1].lat,t[i+1].lng);return e&&t.length>2&&(n+=this.haversineDistance(t[t.length-1].lat,t[t.length-1].lng,t[0].lat,t[0].lng)),n}calculateBoundingBox(t){if(0===t.length)return{width:0,height:0,minLat:0,maxLat:0,minLng:0,maxLng:0};const e=t.map(w=>w.lat),n=t.map(w=>w.lng),i=Math.min(...e),r=Math.max(...e),s=Math.min(...n),l=Math.max(...n);return{width:(l-s)*(111320*Math.cos(this.toRad((i+r)/2))),height:111320*(r-i),minLat:i,maxLat:r,minLng:s,maxLng:l}}formatArea(t){return t>=1e4?`${(t/1e4).toFixed(2)} ha (${t.toFixed(0)} m\xb2)`:`${t.toFixed(2)} m\xb2`}formatDistance(t){return t>=1e3?`${(t/1e3).toFixed(2)} km`:`${t.toFixed(2)} m`}getZoneInfo(t){const e=this.calculatePolygonArea(t.coordinates),n=this.calculatePathLength(t.coordinates,!0),i=this.calculateBoundingBox(t.coordinates);return{area:e,perimeter:n,vertices:t.coordinates.length,bbox:{width:i.width,height:i.height}}}getPathInfo(t){const e=this.calculatePathLength(t.coordinates,!1),n=this.calculateBoundingBox(t.coordinates);return{length:e,segments:t.coordinates.length-1,bbox:{width:n.width,height:n.height}}}static#t=u=()=>(this.\u0275fac=function(e){return new(e||v)(o.rXU(O.nX),o.rXU(E.q9),o.rXU(_.hG),o.rXU(_.K_),o.rXU(_.GD),o.rXU(D.up),o.rXU(S.n),o.rXU(A.a),o.rXU(R.j),o.rXU(L.o),o.rXU($.c),o.rXU(z.G),o.rXU(T.G))},this.\u0275cmp=o.VBU({type:v,selectors:[["app-project-editor"]],viewQuery:function(e,n){if(1&e&&o.GBs(F,5),2&e){let i;o.mGM(i=o.lsd())&&(n.hiddenPhotoInput=i.first)}},standalone:!1,decls:37,vars:13,consts:[["hiddenPhotoInput",""],["color","primary"],["slot","start"],[3,"click"],["slot","icon-only","name","arrow-back"],[3,"fullscreen"],["id","editorMap",1,"editor-map"],[1,"stats-panel"],[1,"stat-item"],["name","shapes-outline"],["name","git-branch-outline"],["name","location-outline"],["name","camera-outline"],["class","drawing-controls",4,"ngIf"],["class","tools-panel",4,"ngIf"],["color","light",1,"locate-btn",3,"click"],["slot","icon-only","name","locate"],["class","export-pdd-btn","color","primary",3,"disabled","click",4,"ngIf"],["class","export-kml-btn","color","success",3,"click",4,"ngIf"],["class","report-preview-overlay",4,"ngIf"],["class","ai-loading-overlay",4,"ngIf"],["type","file","accept","image/*","capture","environment",2,"position","fixed","top","-1000px","left","-1000px","opacity","0","width","1px","height","1px","pointer-events","none",3,"change"],["class","photo-viewer-overlay",4,"ngIf"],[1,"drawing-controls"],[1,"drawing-info"],[4,"ngIf"],[1,"drawing-buttons"],["size","small","color","medium",3,"click","disabled"],["slot","start","name","arrow-undo"],["size","small","color","danger",3,"click"],["slot","start","name","close"],["size","small","color","success",3,"disabled","click",4,"ngIf"],["size","small","color","success",3,"click","disabled"],["slot","start","name","checkmark"],[1,"tools-panel"],["color","light","title","Dibujar zona",1,"tool-btn",3,"click"],["slot","icon-only","name","shapes-outline"],["color","light","title","Trazar vial",1,"tool-btn",3,"click"],["slot","icon-only","name","git-branch-outline"],["color","light","title","Agregar punto",1,"tool-btn",3,"click"],["slot","icon-only","name","location-outline"],["color","primary",1,"export-pdd-btn",3,"click","disabled"],["name","crescent","slot","start",4,"ngIf"],["slot","start","name","document-text-outline",4,"ngIf"],["name","crescent","slot","start"],["slot","start","name","document-text-outline"],["color","success",1,"export-kml-btn",3,"click"],["slot","start","name","earth-outline"],[1,"report-preview-overlay"],[1,"report-preview-header"],["fill","clear",3,"click"],["slot","icon-only","name","close"],[1,"report-preview-content",3,"innerHTML"],[1,"report-preview-actions"],["color","medium",3,"click"],["slot","start","name","close-outline"],["color","success",3,"click"],["slot","start","name","save-outline"],[1,"ai-loading-overlay"],[1,"ai-loading-content"],[1,"ai-loading-spinner"],["name","crescent","color","primary"],[1,"ai-loading-icon"],["name","sparkles"],[1,"ai-loading-text"],[1,"ai-title"],[1,"ai-message"],[1,"photo-viewer-overlay"],[1,"photo-viewer-topbar"],[1,"topbar-title"],[1,"close-btn",3,"click"],["name","close"],[1,"photo-viewer-scroll"],["alt","Foto",3,"src"],["class","photo-notes",4,"ngIf"],["class","photo-ai",4,"ngIf"],[1,"photo-viewer-bottom"],[1,"viewer-btn",3,"click"],["name","create-outline"],["name","sparkles-outline"],[1,"viewer-btn","delete",3,"click"],["name","trash-outline"],[1,"photo-notes"],[1,"note-header"],["name","document-text"],[1,"photo-ai"]],template:function(e,n){if(1&e){const i=o.RV6();o.j41(0,"ion-header")(1,"ion-toolbar",1)(2,"ion-buttons",2)(3,"ion-button",3),o.bIt("click",function(){return m.eBV(i),m.Njj(n.goBack())}),o.nrm(4,"ion-icon",4),o.k0s()(),o.j41(5,"ion-title"),o.EFF(6),o.k0s()()(),o.j41(7,"ion-content",5),o.nrm(8,"div",6),o.j41(9,"div",7)(10,"div",8),o.nrm(11,"ion-icon",9),o.j41(12,"span"),o.EFF(13),o.k0s()(),o.j41(14,"div",8),o.nrm(15,"ion-icon",10),o.j41(16,"span"),o.EFF(17),o.k0s()(),o.j41(18,"div",8),o.nrm(19,"ion-icon",11),o.j41(20,"span"),o.EFF(21),o.k0s()(),o.j41(22,"div",8),o.nrm(23,"ion-icon",12),o.j41(24,"span"),o.EFF(25),o.k0s()()(),o.DNE(26,U,13,5,"div",13)(27,X,7,0,"div",14),o.j41(28,"ion-button",15),o.bIt("click",function(){return m.eBV(i),m.Njj(n.locateMe())}),o.nrm(29,"ion-icon",16),o.k0s(),o.DNE(30,Y,4,4,"ion-button",17)(31,Z,3,0,"ion-button",18)(32,W,14,1,"div",19)(33,J,11,1,"div",20),o.j41(34,"input",21,0),o.bIt("change",function(s){return m.eBV(i),m.Njj(n.onHiddenPhotoInputChange(s))}),o.k0s()(),o.DNE(36,tt,24,8,"div",22)}2&e&&(o.R7$(6),o.JRh((null==n.project?null:n.project.name)||"Editor"),o.R7$(),o.Y8G("fullscreen",!0),o.R7$(6),o.JRh(n.zoneCount),o.R7$(4),o.JRh(n.pathCount),o.R7$(4),o.JRh(n.markerCount),o.R7$(4),o.JRh(n.photoCount),o.R7$(),o.Y8G("ngIf","none"!==n.drawMode),o.R7$(),o.Y8G("ngIf","none"===n.drawMode),o.R7$(3),o.Y8G("ngIf","none"===n.drawMode&&!n.showReportPreview),o.R7$(),o.Y8G("ngIf","none"===n.drawMode&&!n.showReportPreview),o.R7$(),o.Y8G("ngIf",n.showReportPreview),o.R7$(),o.Y8G("ngIf",n.isAnalyzingPhoto||n.isGeneratingPDD),o.R7$(3),o.Y8G("ngIf",n.showPhotoViewer&&n.viewerPhoto))},dependencies:[j.bT,_.Jm,_.QW,_.W9,_.eU,_.iq,_.w2,_.BC,_.ai,j.vh],styles:['.editor-map[_ngcontent-%COMP%]{position:absolute;inset:0;width:100%;height:100%;z-index:1}.stats-panel[_ngcontent-%COMP%]{position:absolute;top:10px;left:10px;z-index:1000;display:flex;gap:8px;background:#fffffff2;padding:8px 12px;border-radius:12px;box-shadow:0 2px 8px #00000026}.stats-panel[_ngcontent-%COMP%]   .stat-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:4px;font-size:13px;font-weight:600;color:#333}.stats-panel[_ngcontent-%COMP%]   .stat-item[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:16px;color:var(--ion-color-primary)}.tools-panel[_ngcontent-%COMP%]{position:absolute;right:10px;top:50%;transform:translateY(-50%);z-index:1000;display:flex;flex-direction:column;gap:8px}.tools-panel[_ngcontent-%COMP%]   .tool-btn[_ngcontent-%COMP%]{--border-radius: 12px;--padding-start: 12px;--padding-end: 12px;--box-shadow: 0 2px 8px rgba(0, 0, 0, .2);width:48px;height:48px}.tools-panel[_ngcontent-%COMP%]   .tool-btn[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:22px}.drawing-controls[_ngcontent-%COMP%]{position:absolute;bottom:20px;left:10px;right:10px;z-index:1000;background:#fffffffa;border-radius:16px;padding:12px 16px;box-shadow:0 4px 16px #0003}.drawing-controls[_ngcontent-%COMP%]   .drawing-info[_ngcontent-%COMP%]{text-align:center;font-weight:600;color:var(--ion-color-primary);margin-bottom:10px;font-size:14px}.drawing-controls[_ngcontent-%COMP%]   .drawing-buttons[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:8px;flex-wrap:wrap}.drawing-controls[_ngcontent-%COMP%]   .drawing-buttons[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{--border-radius: 8px;font-size:12px}.locate-btn[_ngcontent-%COMP%]{position:absolute;top:60px;left:10px;z-index:1000;--border-radius: 50%;--padding-start: 10px;--padding-end: 10px;width:44px;height:44px;--box-shadow: 0 2px 8px rgba(0, 0, 0, .2)}.locate-btn[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:20px}.export-pdd-btn[_ngcontent-%COMP%]{position:absolute;bottom:20px;left:10px;z-index:1000;--border-radius: 12px;--box-shadow: 0 4px 12px rgba(59, 130, 246, .4);font-weight:600;font-size:13px}.export-kml-btn[_ngcontent-%COMP%]{position:absolute;bottom:20px;right:10px;z-index:1000;--border-radius: 12px;--box-shadow: 0 4px 12px rgba(16, 185, 129, .4);font-weight:600;font-size:13px}.report-preview-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;z-index:2000;background:#fff;display:flex;flex-direction:column}.report-preview-overlay[_ngcontent-%COMP%]   .report-preview-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--ion-color-primary);color:#fff}.report-preview-overlay[_ngcontent-%COMP%]   .report-preview-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:18px;font-weight:600}.report-preview-overlay[_ngcontent-%COMP%]   .report-preview-header[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{--color: white}.report-preview-overlay[_ngcontent-%COMP%]   .report-preview-content[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:0;background:#f5f5f5}.report-preview-overlay[_ngcontent-%COMP%]   .report-preview-actions[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:12px;padding:12px 16px;background:#fff;border-top:1px solid #e0e0e0;box-shadow:0 -2px 8px #0000001a}.report-preview-overlay[_ngcontent-%COMP%]   .report-preview-actions[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{--border-radius: 8px;font-weight:600}[_nghost-%COMP%]     .draw-point .draw-dot{width:24px;height:24px;background:var(--ion-color-primary);border:2px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;box-shadow:0 2px 6px #0000004d}[_nghost-%COMP%]     .photo-marker .photo-marker-dot{width:24px;height:24px;background:#10b981;border:2px solid white;border-radius:50%;box-shadow:0 2px 6px #0000004d;position:relative}[_nghost-%COMP%]     .photo-marker .photo-marker-dot:after{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:10px;height:8px;background:#fff;border-radius:2px}[_nghost-%COMP%]     .project-marker{position:relative;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3))}[_nghost-%COMP%]     .project-marker svg{display:block}[_nghost-%COMP%]     .project-marker .photo-badge{position:absolute;top:-2px;right:-4px;width:14px;height:14px;background:#3b82f6;border:2px solid white;border-radius:50%;box-shadow:0 1px 3px #0000004d}[_nghost-%COMP%]     .element-popup{padding:4px;min-width:120px}[_nghost-%COMP%]     .element-popup strong{display:block;margin-bottom:4px;color:#333}[_nghost-%COMP%]     .element-popup p{margin:4px 0;font-size:12px;color:#666}[_nghost-%COMP%]     .element-popup small{color:#999;font-size:10px}[_nghost-%COMP%]     .element-popup .ai-desc{background:#f3f4f6;padding:4px 8px;border-radius:4px;font-style:italic}[_nghost-%COMP%]     .photo-popup{text-align:center;min-width:160px}[_nghost-%COMP%]     .photo-popup img{display:block;margin:0 auto 8px}[_nghost-%COMP%]     .photo-popup p{margin:4px 0;font-size:12px;color:#333}[_nghost-%COMP%]     .photo-popup small{color:#999;font-size:10px}[_nghost-%COMP%]     .leaflet-control-zoom{margin-bottom:60px!important}.ai-loading-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;z-index:9999;background:#000000b3;display:flex;align-items:center;justify-content:center;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-content[_ngcontent-%COMP%]{background:#fff;border-radius:20px;padding:32px 48px;display:flex;flex-direction:column;align-items:center;gap:16px;box-shadow:0 8px 32px #0000004d;animation:_ngcontent-%COMP%_fadeInScale .3s ease-out;max-width:280px;text-align:center}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-spinner[_ngcontent-%COMP%]{position:relative;width:80px;height:80px;display:flex;align-items:center;justify-content:center}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-spinner[_ngcontent-%COMP%]   ion-spinner[_ngcontent-%COMP%]{--color: var(--ion-color-primary);width:80px;height:80px}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-icon[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-icon[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:32px;color:var(--ion-color-primary);animation:_ngcontent-%COMP%_sparkle 1.5s ease-in-out infinite}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-text[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:4px}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-text[_ngcontent-%COMP%]   .ai-title[_ngcontent-%COMP%]{font-size:18px;font-weight:700;color:#333}.ai-loading-overlay[_ngcontent-%COMP%]   .ai-loading-text[_ngcontent-%COMP%]   .ai-message[_ngcontent-%COMP%]{font-size:14px;color:#666}@keyframes _ngcontent-%COMP%_fadeInScale{0%{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}@keyframes _ngcontent-%COMP%_sparkle{0%,to{opacity:1;transform:translate(-50%,-50%) scale(1)}50%{opacity:.6;transform:translate(-50%,-50%) scale(1.1)}}.photo-viewer-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#0a0a0a;z-index:99999;display:flex;flex-direction:column}.photo-viewer-topbar[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#111;border-bottom:1px solid #222;flex-shrink:0}.photo-viewer-topbar[_ngcontent-%COMP%]   .topbar-title[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:17px;font-weight:600;color:#fff}.photo-viewer-topbar[_ngcontent-%COMP%]   .topbar-title[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:12px;color:#888}.photo-viewer-topbar[_ngcontent-%COMP%]   .close-btn[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:50%;background:#333;border:none;color:#fff;display:flex;align-items:center;justify-content:center}.photo-viewer-topbar[_ngcontent-%COMP%]   .close-btn[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:22px}.photo-viewer-scroll[_ngcontent-%COMP%]{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px}.photo-viewer-scroll[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;border-radius:12px;display:block}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-notes[_ngcontent-%COMP%], .photo-viewer-scroll[_ngcontent-%COMP%]   .photo-ai[_ngcontent-%COMP%]{margin-top:16px;padding:14px;border-radius:10px}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-notes[_ngcontent-%COMP%]   .note-header[_ngcontent-%COMP%], .photo-viewer-scroll[_ngcontent-%COMP%]   .photo-ai[_ngcontent-%COMP%]   .note-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-weight:600;font-size:14px;margin-bottom:8px}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-notes[_ngcontent-%COMP%]   .note-header[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%], .photo-viewer-scroll[_ngcontent-%COMP%]   .photo-ai[_ngcontent-%COMP%]   .note-header[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:18px}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-notes[_ngcontent-%COMP%]   p[_ngcontent-%COMP%], .photo-viewer-scroll[_ngcontent-%COMP%]   .photo-ai[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-size:14px;line-height:1.5;color:#ddd}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-notes[_ngcontent-%COMP%]{background:#10b98126;border-left:3px solid #10b981}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-notes[_ngcontent-%COMP%]   .note-header[_ngcontent-%COMP%]{color:#34d399}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-ai[_ngcontent-%COMP%]{background:#f59e0b26;border-left:3px solid #f59e0b}.photo-viewer-scroll[_ngcontent-%COMP%]   .photo-ai[_ngcontent-%COMP%]   .note-header[_ngcontent-%COMP%]{color:#fbbf24}.photo-viewer-bottom[_ngcontent-%COMP%]{display:flex;gap:10px;padding:12px 16px;background:#111;border-top:1px solid #222;flex-shrink:0}.photo-viewer-bottom[_ngcontent-%COMP%]   .viewer-btn[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:12px 8px;background:#1e293b;border:1px solid #334155;border-radius:10px;color:#94a3b8;font-size:13px;font-weight:500}.photo-viewer-bottom[_ngcontent-%COMP%]   .viewer-btn[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:18px}.photo-viewer-bottom[_ngcontent-%COMP%]   .viewer-btn.delete[_ngcontent-%COMP%]{background:#ef444426;border-color:#ef44444d;color:#f87171}']}))}return u(),v})()}];let ot=(()=>{var u;class v{static#t=u=()=>(this.\u0275fac=function(e){return new(e||v)},this.\u0275mod=o.$C({type:v}),this.\u0275inj=m.G2t({imports:[C.iI.forChild(et),C.iI]}))}return u(),v})(),nt=(()=>{var u;class v{static#t=u=()=>(this.\u0275fac=function(e){return new(e||v)},this.\u0275mod=o.$C({type:v}),this.\u0275inj=m.G2t({imports:[j.MD,I.YN,_.bv,ot]}))}return u(),v})()}}]);