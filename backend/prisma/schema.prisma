// Prisma schema for GeoTech

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  isAdmin      Boolean   @default(false) @map("is_admin")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  projects      Project[]
  refreshTokens RefreshToken[]
  licenses      License[]
  payments      Payment[]

  @@map("users")
}

// Tipos de licencia disponibles (configurables por admin)
model LicenseType {
  id              String    @id @default(uuid())
  name            String    // "Por Horas", "Diaria", "Mensual", etc.
  code            String    @unique // "hourly", "daily", "monthly", etc.
  durationDays    Int       @default(0) @map("duration_days") // Dias de duracion
  durationHours   Int       @default(0) @map("duration_hours") // Horas de duracion (tiene prioridad sobre dias)
  price           Decimal   @db.Decimal(10, 2) // Precio en EUR
  promoPrice      Decimal?  @db.Decimal(10, 2) @map("promo_price") // Precio promocional
  promoEndsAt     DateTime? @map("promo_ends_at") // Fecha fin de promocion
  description     String?
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  licenses        License[]
  payments        Payment[]

  @@map("license_types")
}

// Licencias de usuarios
model License {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")
  licenseTypeId   String      @map("license_type_id")
  licenseKey      String      @unique @map("license_key")
  status          String      @default("active") // "active", "expired", "revoked"
  activatedAt     DateTime    @default(now()) @map("activated_at")
  expiresAt       DateTime    @map("expires_at")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  licenseType     LicenseType @relation(fields: [licenseTypeId], references: [id])

  @@index([userId])
  @@index([licenseKey])
  @@index([expiresAt])
  @@map("licenses")
}

// Pagos de PayPal
model Payment {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")
  licenseTypeId   String      @map("license_type_id")
  paypalOrderId   String?     @unique @map("paypal_order_id")
  paypalPayerId   String?     @map("paypal_payer_id")
  amount          Decimal     @db.Decimal(10, 2)
  currency        String      @default("EUR")
  status          String      @default("pending") // "pending", "completed", "failed", "refunded"
  licenseKeyGenerated String? @map("license_key_generated")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  licenseType     LicenseType @relation(fields: [licenseTypeId], references: [id])

  @@index([userId])
  @@index([paypalOrderId])
  @@map("payments")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Project {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  description String?
  location    String?
  content     Json?    // Almacena zones, paths, markers, coordinates como JSON
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  photos      Photo[]
  reports     Report[]
  kmlFiles    KmlFile[]

  @@index([userId])
  @@map("projects")
}

model Photo {
  id              String   @id @default(uuid())
  projectId       String   @map("project_id")
  imageUrl        String   @map("image_url")
  thumbnailUrl    String?  @map("thumbnail_url")
  latitude        Decimal  @db.Decimal(10, 8)
  longitude       Decimal  @db.Decimal(11, 8)
  altitude        Decimal? @db.Decimal(10, 2)
  accuracy        Decimal? @db.Decimal(10, 2)
  catastroRef     String?  @map("catastro_ref")
  catastroData    Json?    @map("catastro_data")
  aiDescription   String?  @map("ai_description") @db.Text
  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([latitude, longitude])
  @@map("photos")
}

model Report {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  name        String
  htmlContent String   @map("html_content") @db.Text
  fileUrl     String?  @map("file_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("reports")
}

model KmlFile {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  name        String
  kmlContent  String   @map("kml_content") @db.Text
  fileUrl     String?  @map("file_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("kml_files")
}
