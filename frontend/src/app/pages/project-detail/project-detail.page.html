<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="arrow-back-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ project?.name || 'Proyecto' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="project-detail-content">
  <div class="project-info" *ngIf="project">
    <div class="info-card">
      <h2 class="project-name">{{ project.name }}</h2>
      <p class="project-description" *ngIf="project.description">{{ project.description }}</p>

      <div class="info-row">
        <ion-icon name="location-outline"></ion-icon>
        <span>{{ project.location || 'Sin ubicacion' }}</span>
      </div>

      <div class="info-row">
        <ion-icon name="calendar-outline"></ion-icon>
        <span>Creado: {{ formatDateTime(project.createdAt) }}</span>
      </div>

      <div class="info-row">
        <ion-icon name="images-outline"></ion-icon>
        <span>{{ photos.length }} {{ photos.length === 1 ? 'fotografía' : 'fotografías' }}</span>
      </div>

      <div class="info-row" *ngIf="zoneCount > 0 || pathCount > 0 || markerCount > 0">
        <ion-icon name="map-outline"></ion-icon>
        <span>{{ zoneCount }} {{ zoneCount === 1 ? 'área delimitada' : 'áreas delimitadas' }}, {{ pathCount }} {{ pathCount === 1 ? 'trazado vial' : 'trazados viales' }}, {{ markerCount }} {{ markerCount === 1 ? 'punto de interés' : 'puntos de interés' }}</span>
      </div>

      <div class="info-row">
        <ion-icon name="folder-outline"></ion-icon>
        <span>{{ totalDocuments }} {{ totalDocuments === 1 ? 'documento generado' : 'documentos generados' }}</span>
      </div>

      <div class="sync-status">
        <span class="sync-badge local">
          <ion-icon name="phone-portrait-outline"></ion-icon>
          Guardado localmente
        </span>
      </div>

      <!-- Edit on Map Button -->
      <ion-button expand="block" color="primary" class="edit-map-btn" (click)="openMapEditor()">
        <ion-icon slot="start" name="map-outline"></ion-icon>
        Editar en Mapa
      </ion-button>
    </div>
  </div>

  <div class="photos-section" *ngIf="photos.length > 0">
    <h3 class="section-title">Registro fotográfico</h3>
    <div class="photos-grid">
      <div class="photo-card" *ngFor="let photo of photos" (click)="openPhotoViewer(photo)">
        <img [src]="photo.imageUrl || photo.localPath || photo.imagePath" alt="Foto" *ngIf="photo.imageUrl || photo.localPath || photo.imagePath" (error)="onImageError($event)">
        <div class="photo-placeholder" *ngIf="!photo.imageUrl && !photo.localPath && !photo.imagePath">
          <ion-icon name="image-outline"></ion-icon>
        </div>
        <div class="photo-info">
          <span class="photo-date" *ngIf="photo.timestamp">{{ formatDate($any(photo.timestamp)) }}</span>
          <span class="photo-coords" *ngIf="photo.latitude">
            {{ photo.latitude.toFixed(4) }}, {{ photo.longitude.toFixed(4) }}
          </span>
        </div>
        <div class="photo-indicators">
          <ion-icon name="sparkles" *ngIf="photo.aiDescription" class="indicator-ai"></ion-icon>
          <ion-icon name="document-text" *ngIf="photo.notes" class="indicator-notes"></ion-icon>
        </div>
      </div>
    </div>
  </div>

  <div class="empty-photos" *ngIf="photos.length === 0 && (totalDocuments > 0 || zoneCount > 0 || pathCount > 0 || markerCount > 0)">
    <div class="empty-photos-content">
      <ion-icon name="images-outline"></ion-icon>
      <span>Sin registro fotográfico</span>
    </div>
  </div>

  <!-- Documentos Generados Section -->
  <div class="documents-section" *ngIf="totalDocuments > 0">
    <h3 class="section-title">Documentación técnica</h3>
    <div class="documents-grid">
      <!-- Informes PDD -->
      <div class="document-card report-card" *ngFor="let report of project?.reports" (click)="openReportViewer(report)">
        <div class="document-icon">
          <ion-icon name="document-text"></ion-icon>
        </div>
        <div class="document-type">INFORME TÉCNICO</div>
        <div class="document-name">{{ report.name }}</div>
        <div class="document-date">{{ formatDate(report.createdAt) }}</div>
      </div>
      <!-- Archivos KML -->
      <div class="document-card kml-card" *ngFor="let kml of project?.kmls" (click)="openKmlViewer(kml)">
        <div class="document-icon">
          <ion-icon name="earth"></ion-icon>
        </div>
        <div class="document-type">GEODATOS KML</div>
        <div class="document-name">{{ kml.name }}</div>
        <div class="document-date">{{ formatDate(kml.createdAt) }}</div>
      </div>
    </div>
  </div>

  <!-- Sin contenido -->
  <div class="empty-state" *ngIf="photos.length === 0 && totalDocuments === 0 && zoneCount === 0 && pathCount === 0 && markerCount === 0">
    <div class="empty-icon">
      <ion-icon name="folder-open-outline"></ion-icon>
    </div>
    <p class="empty-title">Proyecto vacío</p>
    <p class="empty-description">Este proyecto aún no tiene contenido. Utiliza el editor de mapa para añadir elementos geográficos, fotografías y generar documentación.</p>
  </div>

</ion-content>

<!-- Photo Viewer Overlay - fuera de ion-content para cubrir toda la pantalla -->
<div class="photo-viewer-overlay" *ngIf="showPhotoViewer && selectedPhoto" (click)="closePhotoViewer()">
  <div class="photo-viewer-container" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closePhotoViewer()">
      <ion-icon name="close"></ion-icon>
    </button>

    <div class="viewer-image">
      <img [src]="selectedPhoto.imageUrl || selectedPhoto.localPath || selectedPhoto.imagePath" alt="Foto" (error)="onImageError($event)">
    </div>

    <div class="viewer-content">
      <!-- Location -->
      <div class="viewer-section location-section" *ngIf="selectedPhoto.location">
        <div class="viewer-section-header">
          <ion-icon name="navigate"></ion-icon>
          <span>Ubicación</span>
        </div>
        <p class="viewer-text">{{ selectedPhoto.location }}</p>
      </div>

      <!-- Coordinates -->
      <div class="viewer-section" *ngIf="selectedPhoto.latitude">
        <div class="viewer-section-header">
          <ion-icon name="location"></ion-icon>
          <span>Coordenadas</span>
        </div>
        <p class="viewer-coords">{{ selectedPhoto.latitude.toFixed(6) }}, {{ selectedPhoto.longitude.toFixed(6) }}</p>
      </div>

      <!-- AI Description -->
      <div class="viewer-section ai-section" *ngIf="selectedPhoto.aiDescription" (click)="editAIDescription()">
        <div class="viewer-section-header">
          <ion-icon name="sparkles"></ion-icon>
          <span>Descripción IA</span>
          <ion-icon name="create-outline" class="edit-icon"></ion-icon>
        </div>
        <p class="viewer-text">{{ selectedPhoto.aiDescription }}</p>
      </div>

      <!-- User Notes -->
      <div class="viewer-section notes-section" *ngIf="selectedPhoto.notes" (click)="editPhotoNotes()">
        <div class="viewer-section-header">
          <ion-icon name="document-text"></ion-icon>
          <span>Mis notas</span>
          <ion-icon name="create-outline" class="edit-icon"></ion-icon>
        </div>
        <p class="viewer-text">{{ selectedPhoto.notes }}</p>
      </div>

      <!-- Date and Time -->
      <div class="viewer-date" *ngIf="selectedPhoto.timestamp">
        {{ formatDateTime(selectedPhoto.timestamp) }}
      </div>

      <!-- Action Buttons -->
      <div class="viewer-actions">
        <button class="action-btn edit-btn" (click)="editPhotoNotes()">
          <ion-icon name="create-outline"></ion-icon>
          {{ selectedPhoto.notes ? 'Editar nota' : 'Añadir nota' }}
        </button>
        <button class="action-btn ai-btn" (click)="analyzePhotoWithAI()" *ngIf="!selectedPhoto.aiDescription && !isAnalyzingPhoto">
          <ion-icon name="sparkles-outline"></ion-icon>
          Documentar con IA
        </button>
        <button class="action-btn ai-btn" (click)="editAIDescription()" *ngIf="selectedPhoto.aiDescription && !isAnalyzingPhoto">
          <ion-icon name="sparkles-outline"></ion-icon>
          Editar descripción IA
        </button>
        <button class="action-btn ai-btn analyzing" *ngIf="isAnalyzingPhoto" disabled>
          <ion-spinner name="crescent"></ion-spinner>
          Analizando...
        </button>
      </div>

      <!-- Delete Button -->
      <button class="delete-photo-btn" (click)="confirmDeletePhoto()">
        <ion-icon name="trash-outline"></ion-icon>
        Eliminar foto
      </button>
    </div>
  </div>
</div>

<!-- Report Viewer Overlay - fuera de ion-content para cubrir toda la pantalla -->
<div class="report-viewer-overlay" *ngIf="showReportViewer && selectedReport">
  <div class="report-viewer-header">
    <ion-button fill="clear" (click)="closeReportViewer()">
      <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
    </ion-button>
    <h2>{{ selectedReport.name }}</h2>
    <div class="header-spacer"></div>
  </div>
  <div class="report-viewer-content" [innerHTML]="selectedReportHtml"></div>
  <div class="report-viewer-actions">
    <ion-button color="danger" fill="outline" (click)="deleteReport(selectedReport)">
      <ion-icon slot="start" name="trash-outline"></ion-icon>
      Eliminar
    </ion-button>
    <ion-button color="primary" (click)="downloadReportAsWord(selectedReport)">
      <ion-icon slot="start" name="download-outline"></ion-icon>
      Descargar
    </ion-button>
  </div>
</div>

<!-- KML Viewer Overlay - fuera de ion-content para cubrir toda la pantalla -->
<div class="kml-viewer-overlay" *ngIf="showKmlViewer && selectedKml">
  <div class="kml-viewer-header">
    <ion-button fill="clear" (click)="closeKmlViewer()">
      <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
    </ion-button>
    <h2>{{ selectedKml.name }}</h2>
    <div class="header-spacer"></div>
  </div>
  <div class="kml-viewer-content">
    <div class="kml-preview">
      <ion-icon name="earth" class="kml-big-icon"></ion-icon>
      <p class="kml-info">Archivo KML</p>
      <p class="kml-date">Creado: {{ formatDateTime(selectedKml.createdAt) }}</p>
    </div>
  </div>
  <div class="kml-viewer-actions">
    <ion-button color="danger" fill="outline" (click)="deleteKml(selectedKml)">
      <ion-icon slot="start" name="trash-outline"></ion-icon>
      Eliminar
    </ion-button>
    <ion-button color="primary" (click)="downloadKml(selectedKml)">
      <ion-icon slot="start" name="download-outline"></ion-icon>
      Descargar KML
    </ion-button>
  </div>
</div>
