<ion-content class="map-content" [fullscreen]="true">
  <!-- 2D Map View -->
  <div class="map-container" *ngIf="viewMode === 'map'">
    <div id="mainMap" class="main-map"></div>

    <!-- Top Controls -->
    <div class="top-controls">
      <div class="map-type-toggle">
        <button [class.active]="mapType === 'satellite'" (click)="setMapType('satellite')">
          <ion-icon name="globe-outline"></ion-icon>
          Satelite
        </button>
        <button [class.active]="mapType === 'street'" (click)="setMapType('street')">
          <ion-icon name="map-outline"></ion-icon>
          Mapa
        </button>
      </div>
      <button class="catastro-toggle" [class.active]="showCatastro" (click)="toggleCatastro()">
        <ion-icon name="layers-outline"></ion-icon>
        Catastro
      </button>
    </div>

    <!-- Floating Action Buttons -->
    <div class="fab-container">
      <button class="fab-button primary" (click)="locateMe()">
        <ion-icon name="locate"></ion-icon>
      </button>
      <button class="fab-button secondary" (click)="openEarthView()">
        <ion-icon name="earth"></ion-icon>
      </button>
      <button class="fab-button tertiary" (click)="toggleSearch()">
        <ion-icon name="search"></ion-icon>
      </button>
      <button class="fab-button" [class.active]="measureMode === 'distance'" (click)="toggleMeasureDistance()">
        <ion-icon name="resize-outline"></ion-icon>
      </button>
      <button class="fab-button" [class.active]="measureMode === 'area'" (click)="toggleMeasureArea()">
        <ion-icon name="square-outline"></ion-icon>
      </button>
    </div>

    <!-- Search Panel -->
    <div class="search-panel" [class.visible]="showSearch">
      <div class="search-header">
        <h3>Buscar ubicacion</h3>
        <button (click)="toggleSearch()"><ion-icon name="close"></ion-icon></button>
      </div>
      <div class="search-form">
        <!-- Búsqueda por dirección -->
        <div class="input-group">
          <label>Buscar direccion</label>
          <div class="search-input-wrapper">
            <input type="text" [(ngModel)]="searchAddress" placeholder="Ej: Calle Mayor 1, Madrid" (keyup.enter)="searchByAddress()">
            <button class="search-icon-btn" (click)="searchByAddress()">
              <ion-icon name="search"></ion-icon>
            </button>
          </div>
        </div>
        <!-- Resultados de búsqueda -->
        <div class="address-results" *ngIf="showAddressResults && searchResults.length > 0">
          <div class="result-item" *ngFor="let result of searchResults" (click)="selectAddress(result)">
            <ion-icon name="location-outline"></ion-icon>
            <span>{{ result.display_name }}</span>
          </div>
        </div>
        <div class="divider"><span>o coordenadas</span></div>
        <div class="input-group">
          <label>Latitud</label>
          <input type="text" [(ngModel)]="latitude" placeholder="40.416775">
        </div>
        <div class="input-group">
          <label>Longitud</label>
          <input type="text" [(ngModel)]="longitude" placeholder="-3.703790">
        </div>
        <button class="btn-primary" (click)="goToCoords()">
          <ion-icon name="navigate"></ion-icon>
          Ir a coordenadas
        </button>
      </div>
    </div>

    <!-- Measurement Panel -->
    <div class="measure-panel" *ngIf="measureMode !== 'none'">
      <div class="measure-info">
        <ion-icon [name]="measureMode === 'distance' ? 'resize-outline' : 'square-outline'"></ion-icon>
        <span *ngIf="measureMode === 'distance'">Distancia: {{ measureDistance | number:'1.2-2' }} m</span>
        <span *ngIf="measureMode === 'area'">Area: {{ measureArea | number:'1.0-0' }} m²</span>
      </div>
      <button class="measure-stop" (click)="stopMeasure()">
        <ion-icon name="checkmark-circle"></ion-icon>
        Guardar
      </button>
    </div>

    <!-- FAB para ver mediciones guardadas -->
    <button class="fab-measurements" (click)="goToMeasurements()">
      <ion-icon name="list-outline"></ion-icon>
    </button>

    <!-- Info Panel -->
    <div class="info-panel" [class.visible]="showInfoPanel">
      <div class="info-header">
        <div class="coords-display">
          <ion-icon name="location"></ion-icon>
          <span>{{ latitude }}, {{ longitude }}</span>
        </div>
        <button (click)="closeInfoPanel()"><ion-icon name="close"></ion-icon></button>
      </div>
      <div class="info-actions">
        <button class="action-btn" (click)="searchCatastro()">
          <ion-icon name="business-outline"></ion-icon>
          <span>Consultar Catastro</span>
        </button>
        <button class="action-btn google" (click)="openInGoogleMaps()">
          <ion-icon name="map-outline"></ion-icon>
          <span>Google Maps</span>
        </button>
        <button class="action-btn google" (click)="openInGoogleEarth()">
          <ion-icon name="globe-outline"></ion-icon>
          <span>Google Earth</span>
        </button>
        <button class="action-btn catastro" (click)="openInCatastro()" *ngIf="parcelData?.referenciaCatastral">
          <ion-icon name="open-outline"></ion-icon>
          <span>Ver en Catastro</span>
        </button>
      </div>
      <div class="parcel-data" *ngIf="parcelData">
        <div class="data-row" *ngIf="parcelData.referenciaCatastral">
          <span class="data-label">Ref. Catastral</span>
          <span class="data-value mono">{{ parcelData.referenciaCatastral }}</span>
        </div>
        <div class="data-row" *ngIf="parcelData.direccion">
          <span class="data-label">Direccion</span>
          <span class="data-value">{{ parcelData.direccion }}</span>
        </div>
        <div class="data-row" *ngIf="parcelData.superficie">
          <span class="data-label">Superficie</span>
          <span class="data-value">{{ parcelData.superficie }} m2</span>
        </div>
        <div class="data-row" *ngIf="parcelData.uso">
          <span class="data-label">Uso</span>
          <span class="data-value">{{ parcelData.uso }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 3D Earth View -->
  <div class="earth-container" *ngIf="viewMode === 'earth'">
    <div id="earthView" class="earth-view"></div>
    <button class="back-btn" (click)="backToMap()">
      <ion-icon name="arrow-back"></ion-icon>
      Volver al mapa
    </button>
  </div>
</ion-content>
